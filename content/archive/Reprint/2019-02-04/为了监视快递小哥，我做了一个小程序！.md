---
title: '为了监视快递小哥，我做了一个小程序！' 
date: 2019-02-04 2:30:58
hidden: true
slug: 5epgxhtzow
categories: [reprint]
---

{{< raw >}}

                    
<p>我感觉我可以在电脑上查看快递小哥离我有多远了!</p>
<ul>
<li><p>应用演示地址: <a href="http://geomap.wilddogapp.com/" rel="nofollow noreferrer" target="_blank">http://geomap.wilddogapp.com/</a></p></li>
<li><p>源码下载: <a href="http://git.oschina.net/chengxinxin/wildGeo" rel="nofollow noreferrer" target="_blank">http://git.oschina.net/chengxinxin/wildGeo</a> 下载到本地解压后即可运行。由于流量问题,请先替换源码<code>delivery.js</code>中的<code>appId</code></p></li>
<li><p>appId注册链接: <a href="https://www.wilddog.com/my-account/signup" rel="nofollow noreferrer" target="_blank">https://www.wilddog.com/my-account/signup</a>。</p></li>
</ul>
<p><span class="img-wrap"><img data-src="/img/remote/1460000006839324" src="https://static.alili.tech/img/remote/1460000006839324" alt="添加应用" title="添加应用" style="cursor: pointer;"></span></p>
<p><span class="img-wrap"><img data-src="/img/remote/1460000006839325" src="https://static.alili.tech/img/remote/1460000006839325" alt="appId" title="appId" style="cursor: pointer; display: inline;"></span></p>
<h4>我们来看一下代码。</h4>
<p>从地图展现的程度来说,这个地图布局基本没有难度。如果你对我这么说感到疑惑那么我建议你可以看看这个: <a href="http://lbs.amap.com/api/javascript-api/example/map/map-show/" rel="nofollow noreferrer" target="_blank">高德地图示例中心</a>。你应该很快可以构建出想wildGeo这样的界面。如果你对此表示有难度的话,请拷贝下面的代码到一个空白的HTML文件中:</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="<!doctype html>
<html>
<head>
    <meta charset=&quot;utf-8&quot;>
    <meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;>
    <meta name=&quot;viewport&quot; content=&quot;initial-scale=1.0, user-scalable=no, width=device-width&quot;>
    <title>基本地图展示</title>
    <link rel=&quot;stylesheet&quot; href=&quot;http://cache.amap.com/lbs/static/main1119.css&quot;/>
    <script src=&quot;http://cache.amap.com/lbs/static/es5.min.js&quot;></script>
    <script src=&quot;http://webapi.amap.com/maps?v=1.3&amp;key=您申请的key值&quot;></script>
    <script type=&quot;text/javascript&quot; src=&quot;http://cache.amap.com/lbs/static/addToolbar.js&quot;></script>
</head>
<body>
<div id=&quot;container&quot;></div>
<script>
    var map = new AMap.Map('container', {
        resizeEnable: true,
        zoom:11,
        center: [116.397428, 39.90923]
        
    });
</script>
</body>
</html>
" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs xml"><code><span class="hljs-meta">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"X-UA-Compatible"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"IE=edge"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"initial-scale=1.0, user-scalable=no, width=device-width"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>基本地图展示<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://cache.amap.com/lbs/static/main1119.css"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://cache.amap.com/lbs/static/es5.min.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://webapi.amap.com/maps?v=1.3&amp;key=您申请的key值"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://cache.amap.com/lbs/static/addToolbar.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
    <span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> AMap.Map(<span class="hljs-string">'container'</span>, {
        resizeEnable: <span class="hljs-literal">true</span>,
        zoom:<span class="hljs-number">11</span>,
        center: [<span class="hljs-number">116.397428</span>, <span class="hljs-number">39.90923</span>]
        
    });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>这样你就可以在浏览器中打开一张地图了。</p>
<h4>下面我们该干什么了? Coding!</h4>
<p>我们需要在地图上标注配送站的信息,高德地图上叫做 <a href="http://lbs.amap.com/api/javascript-api/example/marker/custom-icon-content/" rel="nofollow noreferrer" target="_blank">自定义标记覆盖物</a>,野狗的wildGeo工程师是这样写的:</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="//自定义点标记内容   
    var stationMarkerContent = document.createElement(&quot;div&quot;);
    stationMarkerContent.className = &quot;markerContentStyle&quot;;
        
    //点标记中的图标
    var stationMarkerImg = document.createElement(&quot;img&quot;);
    stationMarkerImg.className = &quot;markerlnglat&quot;;
    stationMarkerImg.src =&quot;http://webapi.amap.com/images/marker_sprite.png&quot;;
    stationMarkerContent.appendChild(stationMarkerImg);
         
    //点标记中的文本
    var stationMarkerSpan = document.createElement(&quot;span&quot;);
    stationMarkerSpan.innerHTML = '配送站';
    stationMarkerSpan.setAttribute(&quot;class&quot;, &quot;span1&quot;)
    stationMarkerContent.appendChild(stationMarkerSpan);

    var stationMarker  = new AMap.Marker({ //AMap.Marker是非常重要的点,关于样式如果不是很符合你的要求,你可以手动去改!
        map:map,
        position:new AMap.LngLat(116.408032,39.897614),//基点位置
        autoRotation:false,
        content: stationMarkerContent //自定义点标记覆盖物内容,这个地方可以直接写HTML文件
    });
    " title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs dart"><code><span class="hljs-comment">//自定义点标记内容   </span>
    <span class="hljs-keyword">var</span> stationMarkerContent = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>);
    stationMarkerContent.className = <span class="hljs-string">"markerContentStyle"</span>;
        
    <span class="hljs-comment">//点标记中的图标</span>
    <span class="hljs-keyword">var</span> stationMarkerImg = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"img"</span>);
    stationMarkerImg.className = <span class="hljs-string">"markerlnglat"</span>;
    stationMarkerImg.src =<span class="hljs-string">"http://webapi.amap.com/images/marker_sprite.png"</span>;
    stationMarkerContent.appendChild(stationMarkerImg);
         
    <span class="hljs-comment">//点标记中的文本</span>
    <span class="hljs-keyword">var</span> stationMarkerSpan = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"span"</span>);
    stationMarkerSpan.innerHTML = <span class="hljs-string">'配送站'</span>;
    stationMarkerSpan.setAttribute(<span class="hljs-string">"class"</span>, <span class="hljs-string">"span1"</span>)
    stationMarkerContent.appendChild(stationMarkerSpan);

    <span class="hljs-keyword">var</span> stationMarker  = <span class="hljs-keyword">new</span> AMap.Marker({ <span class="hljs-comment">//AMap.Marker是非常重要的点,关于样式如果不是很符合你的要求,你可以手动去改!</span>
        map:map,
        position:<span class="hljs-keyword">new</span> AMap.LngLat(<span class="hljs-number">116.408032</span>,<span class="hljs-number">39.897614</span>),<span class="hljs-comment">//基点位置</span>
        autoRotation:<span class="hljs-keyword">false</span>,
        content: stationMarkerContent <span class="hljs-comment">//自定义点标记覆盖物内容,这个地方可以直接写HTML文件</span>
    });
    </code></pre>
<p>野狗工程师在做wildGeo用的是JavaScript来做的,他定义了一个 <code>stationMarkerContent</code> 来盛放自定义标记覆盖物的内容。之后把<code>标价覆盖物</code>的HTML代码构造好了放到了 <code>AMap.Marker</code> 对象的<code>content</code>中。你当然可以直接在<code>content</code>中写好你构造好的<code>HTML代码</code>字符串。</p>
<p>完成以上的步骤,客户实现的效果是,一张地图,之后会有一个配送站地理位置图标,和配送站三个文字。</p>
<p>因为我们需要确定是地图上任意一个点上某个范围内的送餐员电话,所以我们需要一某个点为中心画圆,当然,高德地图给我们提供了这样的一个接口。</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="var circle = new AMap.Circle({ 
        map:map,//map指的是你创建的地图对象,就是这篇文章第五个代码块中的那个map对象
         center:loc,// 圆心位置
        radius:(1500), //半径
        strokeColor: &quot;#6D3099&quot;, //线颜色
        strokeOpacity: 1, //线透明度
        strokeWeight: 3, //线粗细度
        fillColor: &quot;#B650FF&quot;, //填充颜色
        fillOpacity: 0.35//填充透明度

    }); 
    " title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs dts"><code>var circle = new AMap.Circle({ 
<span class="hljs-symbol">        map:</span>map,<span class="hljs-comment">//map指的是你创建的地图对象,就是这篇文章第五个代码块中的那个map对象</span>
<span class="hljs-symbol">         center:</span>loc,<span class="hljs-comment">// 圆心位置</span>
<span class="hljs-symbol">        radius:</span>(<span class="hljs-number">1500</span>), <span class="hljs-comment">//半径</span>
<span class="hljs-symbol">        strokeColor:</span> <span class="hljs-string">"#6D3099"</span>, <span class="hljs-comment">//线颜色</span>
<span class="hljs-symbol">        strokeOpacity:</span> <span class="hljs-number">1</span>, <span class="hljs-comment">//线透明度</span>
<span class="hljs-symbol">        strokeWeight:</span> <span class="hljs-number">3</span>, <span class="hljs-comment">//线粗细度</span>
<span class="hljs-symbol">        fillColor:</span> <span class="hljs-string">"#B650FF"</span>, <span class="hljs-comment">//填充颜色</span>
<span class="hljs-symbol">        fillOpacity:</span> <span class="hljs-number">0.35</span><span class="hljs-comment">//填充透明度</span>

    }); 
    </code></pre>
<p>之后地图上会有一个出现一个表示范围的圆环。下面就是野狗实施后端云大显身手的时间了! 别忘记注册 <a href="https://www.wilddog.com" rel="nofollow noreferrer" target="_blank">野狗</a> 账号</p>
<p>首先,如果你要通过 <code>ctrl+c</code> 和 <code>ctrl+p</code> 之后代码就可以使用的话,你一定要了解后台的数据结构。wildGeo数据结构如下:</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="{
    &quot;_geofire&quot;: {
        &quot;beijing:0000&quot;: {
            &quot;g&quot;: &quot;wx4dwxwtp8&quot;, 
            &quot;l&quot;: [
                39.856513, 
                116.310528
            ]
        }, 
        &quot;beijing:0001&quot;: {
            &quot;g&quot;: &quot;wx4en9qsrw&quot;, 
            &quot;l&quot;: [
                39.909971999999996, 
                116.310528
            ]
        }, 
        &quot;beijing:0100&quot;: {
            &quot;g&quot;: &quot;wx4f8rstp8&quot;, 
            &quot;l&quot;: [
                39.856513, 
                116.3846855
            ]
        }, 
        &quot;beijing:0101&quot;: {
            &quot;g&quot;: &quot;wx4g03ksrw&quot;, 
            &quot;l&quot;: [
                39.909971999999996, 
                116.3846855
            ]
        }
    }, 
    &quot;beijing&quot;: {
        &quot;delivery&quot;: {
            &quot;0000&quot;: {
                &quot;id&quot;: &quot;0000&quot;, 
                &quot;lat&quot;: 39.856513, 
                &quot;lng&quot;: 116.310528
            }, 
            &quot;0001&quot;: {
                &quot;id&quot;: &quot;0001&quot;, 
                &quot;lat&quot;: 39.909971999999996, 
                &quot;lng&quot;: 116.310528
            }, 
            &quot;0100&quot;: {
                &quot;id&quot;: &quot;0100&quot;, 
                &quot;lat&quot;: 39.856513, 
                &quot;lng&quot;: 116.3846855
            }, 
            &quot;0101&quot;: {
                &quot;id&quot;: &quot;0101&quot;, 
                &quot;lat&quot;: 39.909971999999996, 
                &quot;lng&quot;: 116.3846855
            }
        }
    }
}
" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs json"><code>{
    <span class="hljs-attr">"_geofire"</span>: {
        <span class="hljs-attr">"beijing:0000"</span>: {
            <span class="hljs-attr">"g"</span>: <span class="hljs-string">"wx4dwxwtp8"</span>, 
            <span class="hljs-attr">"l"</span>: [
                <span class="hljs-number">39.856513</span>, 
                <span class="hljs-number">116.310528</span>
            ]
        }, 
        <span class="hljs-attr">"beijing:0001"</span>: {
            <span class="hljs-attr">"g"</span>: <span class="hljs-string">"wx4en9qsrw"</span>, 
            <span class="hljs-attr">"l"</span>: [
                <span class="hljs-number">39.909971999999996</span>, 
                <span class="hljs-number">116.310528</span>
            ]
        }, 
        <span class="hljs-attr">"beijing:0100"</span>: {
            <span class="hljs-attr">"g"</span>: <span class="hljs-string">"wx4f8rstp8"</span>, 
            <span class="hljs-attr">"l"</span>: [
                <span class="hljs-number">39.856513</span>, 
                <span class="hljs-number">116.3846855</span>
            ]
        }, 
        <span class="hljs-attr">"beijing:0101"</span>: {
            <span class="hljs-attr">"g"</span>: <span class="hljs-string">"wx4g03ksrw"</span>, 
            <span class="hljs-attr">"l"</span>: [
                <span class="hljs-number">39.909971999999996</span>, 
                <span class="hljs-number">116.3846855</span>
            ]
        }
    }, 
    <span class="hljs-attr">"beijing"</span>: {
        <span class="hljs-attr">"delivery"</span>: {
            <span class="hljs-attr">"0000"</span>: {
                <span class="hljs-attr">"id"</span>: <span class="hljs-string">"0000"</span>, 
                <span class="hljs-attr">"lat"</span>: <span class="hljs-number">39.856513</span>, 
                <span class="hljs-attr">"lng"</span>: <span class="hljs-number">116.310528</span>
            }, 
            <span class="hljs-attr">"0001"</span>: {
                <span class="hljs-attr">"id"</span>: <span class="hljs-string">"0001"</span>, 
                <span class="hljs-attr">"lat"</span>: <span class="hljs-number">39.909971999999996</span>, 
                <span class="hljs-attr">"lng"</span>: <span class="hljs-number">116.310528</span>
            }, 
            <span class="hljs-attr">"0100"</span>: {
                <span class="hljs-attr">"id"</span>: <span class="hljs-string">"0100"</span>, 
                <span class="hljs-attr">"lat"</span>: <span class="hljs-number">39.856513</span>, 
                <span class="hljs-attr">"lng"</span>: <span class="hljs-number">116.3846855</span>
            }, 
            <span class="hljs-attr">"0101"</span>: {
                <span class="hljs-attr">"id"</span>: <span class="hljs-string">"0101"</span>, 
                <span class="hljs-attr">"lat"</span>: <span class="hljs-number">39.909971999999996</span>, 
                <span class="hljs-attr">"lng"</span>: <span class="hljs-number">116.3846855</span>
            }
        }
    }
}
</code></pre>
<p>你们一定要明白数据结构和数据的区别!你可以把上面的数据复制到本地的一个json文件中,之后导入到你的野狗app里面去。<br>之后建立也野狗对象</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="//map variable
var map;

// Set the center as Wilddog HQ
var locations = {
  &quot;WilddogHQ&quot;: [39.897614,116.408032]
};
var center = locations[&quot;WilddogHQ&quot;];

// Get a reference to the Wilddog public transit open data set
var transitWilddogRef = new Wilddog(&quot;https://<appId>.wilddogio.com/&quot;)
" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs go"><code><span class="hljs-comment">//map variable</span>
<span class="hljs-keyword">var</span> <span class="hljs-keyword">map</span>;

<span class="hljs-comment">// Set the center as Wilddog HQ</span>
<span class="hljs-keyword">var</span> locations = {
  <span class="hljs-string">"WilddogHQ"</span>: [<span class="hljs-number">39.897614</span>,<span class="hljs-number">116.408032</span>]
};
<span class="hljs-keyword">var</span> center = locations[<span class="hljs-string">"WilddogHQ"</span>];

<span class="hljs-comment">// Get a reference to the Wilddog public transit open data set</span>
<span class="hljs-keyword">var</span> transitWilddogRef = <span class="hljs-built_in">new</span> Wilddog(<span class="hljs-string">"https://&lt;appId&gt;.wilddogio.com/"</span>)
</code></pre>
<p>野狗为了更好的和地图是进行适配,开发了wildGeo对象,他是一个单独的js,有兴趣的开发者可以 <a href="https://github.com/WildDogTeam/demo-js-geomap/tree/master/app/scripts" rel="nofollow noreferrer" target="_blank">下载</a> 或 <a href="https://github.com/WildDogTeam/lib-js-wildgeo/blob/master/API.md" rel="nofollow noreferrer" target="_blank">阅读文档</a></p>
<p>我们在建立了<code>transitwilddogRef</code>对象的基础上,需要尽力<code>wildGeo</code>对象。</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="
// Create a new WildGeo instance, pulling data from the public transit data
var wildGeo = new WildGeo(transitWilddogRef.child(&quot;_geofire&quot;));
" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs sql"><code>
// <span class="hljs-keyword">Create</span> a <span class="hljs-keyword">new</span> WildGeo <span class="hljs-keyword">instance</span>, pulling <span class="hljs-keyword">data</span> <span class="hljs-keyword">from</span> the <span class="hljs-keyword">public</span> transit <span class="hljs-keyword">data</span>
<span class="hljs-keyword">var</span> wildGeo = <span class="hljs-keyword">new</span> WildGeo(transitWilddogRef.child(<span class="hljs-string">"_geofire"</span>));
</code></pre>
<p>上面的代码说明了,创建<code>wildGeo</code>对象来操作地理坐标数据,数据来源于<code>transitWilddogRef</code>下面的<code>_geofire</code>节点。</p>
<p>之后,我们来看一下怎样数据初始化。</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="/*************/
/*  GEOQUERY */
/*************/
// Keep track of all of the deliverys currently within the query
var deliverysInQuery = {};

// Create a new GeoQuery instance
var geoQuery = wildGeo.query({
  center: center, //center指的是 var center = locations[&quot;WilddogHQ&quot;];
  radius: 1500
});

/* Adds new delivery markers to the map when they enter the query */
geoQuery.on(&quot;key_entered&quot;, function(deliveryId, deliveryLocation) { 
  // Specify that the delivery has entered this query
  deliveryId = deliveryId.split(&quot;:&quot;)[1];
  deliverysInQuery[deliveryId] = true;

  // Look up the delivery's data in the Transit Open Data Set
  transitWilddogRef.child(&quot;beijing/delivery&quot;).child(deliveryId).once(&quot;value&quot;, function(dataSnapshot) {
    // Get the delivery data from the Open Data Set
    delivery = dataSnapshot.val();

    // If the delivery has not already exited this query in the time it took to look up its data in the Open Data
    // Set, add it to the map
    if (delivery !== null &amp;&amp; deliverysInQuery[deliveryId] === true) {
      // Add the delivery to the list of deliverys in the query
      deliverysInQuery[deliveryId] = delivery;

      // Create a new marker for the delivery
      delivery.marker = createdeliveryMarker(delivery);
    }
  });
});

" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs actionscript"><code><span class="hljs-comment">/*************/</span>
<span class="hljs-comment">/*  GEOQUERY */</span>
<span class="hljs-comment">/*************/</span>
<span class="hljs-comment">// Keep track of all of the deliverys currently within the query</span>
<span class="hljs-keyword">var</span> deliverysInQuery = {};

<span class="hljs-comment">// Create a new GeoQuery instance</span>
<span class="hljs-keyword">var</span> geoQuery = wildGeo.query({
  center: center, <span class="hljs-comment">//center指的是 var center = locations["WilddogHQ"];</span>
  radius: <span class="hljs-number">1500</span>
});

<span class="hljs-comment">/* Adds new delivery markers to the map when they enter the query */</span>
geoQuery.on(<span class="hljs-string">"key_entered"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(deliveryId, deliveryLocation)</span> </span>{ 
  <span class="hljs-comment">// Specify that the delivery has entered this query</span>
  deliveryId = deliveryId.split(<span class="hljs-string">":"</span>)[<span class="hljs-number">1</span>];
  deliverysInQuery[deliveryId] = <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// Look up the delivery's data in the Transit Open Data Set</span>
  transitWilddogRef.child(<span class="hljs-string">"beijing/delivery"</span>).child(deliveryId).once(<span class="hljs-string">"value"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dataSnapshot)</span> </span>{
    <span class="hljs-comment">// Get the delivery data from the Open Data Set</span>
    delivery = dataSnapshot.val();

    <span class="hljs-comment">// If the delivery has not already exited this query in the time it took to look up its data in the Open Data</span>
    <span class="hljs-comment">// Set, add it to the map</span>
    <span class="hljs-keyword">if</span> (delivery !== <span class="hljs-literal">null</span> &amp;&amp; deliverysInQuery[deliveryId] === <span class="hljs-literal">true</span>) {
      <span class="hljs-comment">// Add the delivery to the list of deliverys in the query</span>
      deliverysInQuery[deliveryId] = delivery;

      <span class="hljs-comment">// Create a new marker for the delivery</span>
      delivery.marker = createdeliveryMarker(delivery);
    }
  });
});

</code></pre>
<p>我们需要观察几个点:</p>
<ul>
<li><p>第一个点是<code>wildGeo.query()</code> 之后会产生一个新的对象叫做:<code>geoQuery</code>。</p></li>
<li><p><code>geoQuery.on(eventType,callback)</code> eventType是事件类型:这里用的是<code>key_entered</code>,表示监听的点是否进入范围之内。如果进入则存到<code>deliverysInQuery</code>对象中去,通过<code>createdeliveryMarker</code>方法,在地图上创建一个个的快递员图标。</p></li>
</ul>
<p>那么如果快递离开了我们的那个范围呢?</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="geoQuery.on(&quot;key_exited&quot;, function(deliveryId, deliveryLocation) {
  // Get the delivery from the list of deliverys in the query
  deliveryId = deliveryId.split(&quot;:&quot;)[1];
  var delivery = deliverysInQuery[deliveryId];
  // If the delivery's data has already been loaded from the Open Data Set, remove its marker from the map
  if (delivery !== true &amp;&amp;  typeof delivery.marker !== &quot;undefined&quot;) {
      delivery.marker.stopMove();
    delivery.marker.setMap(null);
  }

  // Remove the delivery from the list of deliverys in the query
  delete deliverysInQuery[deliveryId];
});
" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs actionscript"><code>geoQuery.on(<span class="hljs-string">"key_exited"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(deliveryId, deliveryLocation)</span> </span>{
  <span class="hljs-comment">// Get the delivery from the list of deliverys in the query</span>
  deliveryId = deliveryId.split(<span class="hljs-string">":"</span>)[<span class="hljs-number">1</span>];
  <span class="hljs-keyword">var</span> delivery = deliverysInQuery[deliveryId];
  <span class="hljs-comment">// If the delivery's data has already been loaded from the Open Data Set, remove its marker from the map</span>
  <span class="hljs-keyword">if</span> (delivery !== <span class="hljs-literal">true</span> &amp;&amp;  <span class="hljs-keyword">typeof</span> delivery.marker !== <span class="hljs-string">"undefined"</span>) {
      delivery.marker.stopMove();
    delivery.marker.setMap(<span class="hljs-literal">null</span>);
  }

  <span class="hljs-comment">// Remove the delivery from the list of deliverys in the query</span>
  <span class="hljs-keyword">delete</span> deliverysInQuery[deliveryId];
});
</code></pre>
<p>我们可以使用<code>key_exited</code>这个方法,来监听离开我们的快递员。</p>
<p>最后附上<code>createdeliveryMarker</code>方法。</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="/**********************/
/*  HELPER FUNCTIONS  */
/**********************/
/* Adds a marker for the inputted delivery to the map */
function createdeliveryMarker(delivery) {
    //自定义点标记内容   
    var markerContent = document.createElement(&quot;div&quot;);
    markerContent.className = &quot;markerContentStyle&quot;;
        
    //点标记中的图标
    var markerImg = document.createElement(&quot;img&quot;);
    markerImg.className = &quot;markerlnglat&quot;;
    markerImg.src = &quot;images/man.png&quot;;
    markerImg.height = &quot;35&quot;;
    markerImg.width = &quot;27&quot;;
    markerContent.appendChild(markerImg);
         
    //点标记中的文本
    var markerSpan = document.createElement(&quot;span&quot;);
    markerSpan.innerHTML = delivery.id;
    markerContent.appendChild(markerSpan);

    var marker  = new AMap.Marker({
        map:map,
        position:new AMap.LngLat(delivery.lng, delivery.lat),//基点位置
        autoRotation:false,
        content: markerContent //自定义点标记覆盖物内容
        
    });
      return marker;
}
" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs dart"><code><span class="hljs-comment"><span class="markdown">/<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>**/</span></span>
<span class="hljs-comment">/*  HELPER FUNCTIONS  */</span>
<span class="hljs-comment"><span class="markdown">/<span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>**/</span></span>
<span class="hljs-comment">/* Adds a marker for the inputted delivery to the map */</span>
function createdeliveryMarker(delivery) {
    <span class="hljs-comment">//自定义点标记内容   </span>
    <span class="hljs-keyword">var</span> markerContent = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>);
    markerContent.className = <span class="hljs-string">"markerContentStyle"</span>;
        
    <span class="hljs-comment">//点标记中的图标</span>
    <span class="hljs-keyword">var</span> markerImg = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"img"</span>);
    markerImg.className = <span class="hljs-string">"markerlnglat"</span>;
    markerImg.src = <span class="hljs-string">"images/man.png"</span>;
    markerImg.height = <span class="hljs-string">"35"</span>;
    markerImg.width = <span class="hljs-string">"27"</span>;
    markerContent.appendChild(markerImg);
         
    <span class="hljs-comment">//点标记中的文本</span>
    <span class="hljs-keyword">var</span> markerSpan = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"span"</span>);
    markerSpan.innerHTML = delivery.id;
    markerContent.appendChild(markerSpan);

    <span class="hljs-keyword">var</span> marker  = <span class="hljs-keyword">new</span> AMap.Marker({
        map:map,
        position:<span class="hljs-keyword">new</span> AMap.LngLat(delivery.lng, delivery.lat),<span class="hljs-comment">//基点位置</span>
        autoRotation:<span class="hljs-keyword">false</span>,
        content: markerContent <span class="hljs-comment">//自定义点标记覆盖物内容</span>
        
    });
      <span class="hljs-keyword">return</span> marker;
}
</code></pre>
<p>和<code>地图初始化代码</code>片段</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function initializeMap() {
    var loc = new AMap.LngLat(center[1], center[0]);
    //初始化地图对象，加载地图
    var UA = navigator.userAgent;
    if (UA.indexOf(&quot;Mobile&quot;) == -1 || UA.indexOf(&quot;Mobile&quot;) == -1) {
        defineMap(loc, 15);
    } else {
        defineMap(loc , 13);
    };

    //加载工具条
    // map.plugin([&quot;AMap.ToolBar&quot;],function(){
    //     var tool = new AMap.ToolBar();
    //        map.addControl(tool); 
    //         });
    //
    // //加载比例尺
    // map.plugin([&quot;AMap.Scale&quot;],function(){
    //         var scale = new AMap.Scale();
    //         map.addControl(scale);  
    //         });

    
    var circle = new AMap.Circle({ 
        map:map,
         center:loc,// 圆心位置
        radius:((radiusInKm) * 1000), //半径
        strokeColor: &quot;#6D3099&quot;, //线颜色
        strokeOpacity: 1, //线透明度
        strokeWeight: 3, //线粗细度
        fillColor: &quot;#B650FF&quot;, //填充颜色
        fillOpacity: 0.35//填充透明度

    }); 

    //自定义点标记内容   
    var stationMarkerContent = document.createElement(&quot;div&quot;);
    stationMarkerContent.className = &quot;markerContentStyle&quot;;
        
    //点标记中的图标
    var stationMarkerImg = document.createElement(&quot;img&quot;);
    stationMarkerImg.className = &quot;markerlnglat&quot;;
    stationMarkerImg.src =&quot;http://webapi.amap.com/images/marker_sprite.png&quot;;
    stationMarkerContent.appendChild(stationMarkerImg);
         
    //点标记中的文本
    var stationMarkerSpan = document.createElement(&quot;span&quot;);
    stationMarkerSpan.innerHTML = '配送站';
    stationMarkerSpan.setAttribute(&quot;class&quot;, &quot;span1&quot;)
    stationMarkerContent.appendChild(stationMarkerSpan);

    var stationMarker  = new AMap.Marker({
        map:map,
        position:new AMap.LngLat(116.408032,39.897614),//基点位置
        autoRotation:false,
        content: stationMarkerContent //自定义点标记覆盖物内容
    });

    var lnglat;
    var clickEventListener = AMap.event.addListener(map,'click',function(e){
        lnglat=e.lnglat;
        circle.setCenter(lnglat);
        updateCriteria();
    });

    var updateCriteria = _.debounce(function() {
        lnglat = circle.getCenter();
        geoQuery.updateCriteria({
          center: [lnglat.getLat(), lnglat.getLng()],
          radius: radiusInKm
        });
      }, 10);
}
" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs javascript"><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initializeMap</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> loc = <span class="hljs-keyword">new</span> AMap.LngLat(center[<span class="hljs-number">1</span>], center[<span class="hljs-number">0</span>]);
    <span class="hljs-comment">//初始化地图对象，加载地图</span>
    <span class="hljs-keyword">var</span> UA = navigator.userAgent;
    <span class="hljs-keyword">if</span> (UA.indexOf(<span class="hljs-string">"Mobile"</span>) == <span class="hljs-number">-1</span> || UA.indexOf(<span class="hljs-string">"Mobile"</span>) == <span class="hljs-number">-1</span>) {
        defineMap(loc, <span class="hljs-number">15</span>);
    } <span class="hljs-keyword">else</span> {
        defineMap(loc , <span class="hljs-number">13</span>);
    };

    <span class="hljs-comment">//加载工具条</span>
    <span class="hljs-comment">// map.plugin(["AMap.ToolBar"],function(){</span>
    <span class="hljs-comment">//     var tool = new AMap.ToolBar();</span>
    <span class="hljs-comment">//        map.addControl(tool); </span>
    <span class="hljs-comment">//         });</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// //加载比例尺</span>
    <span class="hljs-comment">// map.plugin(["AMap.Scale"],function(){</span>
    <span class="hljs-comment">//         var scale = new AMap.Scale();</span>
    <span class="hljs-comment">//         map.addControl(scale);  </span>
    <span class="hljs-comment">//         });</span>

    
    <span class="hljs-keyword">var</span> circle = <span class="hljs-keyword">new</span> AMap.Circle({ 
        <span class="hljs-attr">map</span>:map,
         <span class="hljs-attr">center</span>:loc,<span class="hljs-comment">// 圆心位置</span>
        radius:((radiusInKm) * <span class="hljs-number">1000</span>), <span class="hljs-comment">//半径</span>
        strokeColor: <span class="hljs-string">"#6D3099"</span>, <span class="hljs-comment">//线颜色</span>
        strokeOpacity: <span class="hljs-number">1</span>, <span class="hljs-comment">//线透明度</span>
        strokeWeight: <span class="hljs-number">3</span>, <span class="hljs-comment">//线粗细度</span>
        fillColor: <span class="hljs-string">"#B650FF"</span>, <span class="hljs-comment">//填充颜色</span>
        fillOpacity: <span class="hljs-number">0.35</span><span class="hljs-comment">//填充透明度</span>

    }); 

    <span class="hljs-comment">//自定义点标记内容   </span>
    <span class="hljs-keyword">var</span> stationMarkerContent = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>);
    stationMarkerContent.className = <span class="hljs-string">"markerContentStyle"</span>;
        
    <span class="hljs-comment">//点标记中的图标</span>
    <span class="hljs-keyword">var</span> stationMarkerImg = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"img"</span>);
    stationMarkerImg.className = <span class="hljs-string">"markerlnglat"</span>;
    stationMarkerImg.src =<span class="hljs-string">"http://webapi.amap.com/images/marker_sprite.png"</span>;
    stationMarkerContent.appendChild(stationMarkerImg);
         
    <span class="hljs-comment">//点标记中的文本</span>
    <span class="hljs-keyword">var</span> stationMarkerSpan = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"span"</span>);
    stationMarkerSpan.innerHTML = <span class="hljs-string">'配送站'</span>;
    stationMarkerSpan.setAttribute(<span class="hljs-string">"class"</span>, <span class="hljs-string">"span1"</span>)
    stationMarkerContent.appendChild(stationMarkerSpan);

    <span class="hljs-keyword">var</span> stationMarker  = <span class="hljs-keyword">new</span> AMap.Marker({
        <span class="hljs-attr">map</span>:map,
        <span class="hljs-attr">position</span>:<span class="hljs-keyword">new</span> AMap.LngLat(<span class="hljs-number">116.408032</span>,<span class="hljs-number">39.897614</span>),<span class="hljs-comment">//基点位置</span>
        autoRotation:<span class="hljs-literal">false</span>,
        <span class="hljs-attr">content</span>: stationMarkerContent <span class="hljs-comment">//自定义点标记覆盖物内容</span>
    });

    <span class="hljs-keyword">var</span> lnglat;
    <span class="hljs-keyword">var</span> clickEventListener = AMap.event.addListener(map,<span class="hljs-string">'click'</span>,<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>)</span>{
        lnglat=e.lnglat;
        circle.setCenter(lnglat);
        updateCriteria();
    });

    <span class="hljs-keyword">var</span> updateCriteria = _.debounce(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        lnglat = circle.getCenter();
        geoQuery.updateCriteria({
          <span class="hljs-attr">center</span>: [lnglat.getLat(), lnglat.getLng()],
          <span class="hljs-attr">radius</span>: radiusInKm
        });
      }, <span class="hljs-number">10</span>);
}
</code></pre>
<p>累死妹子了!</p>
<p>作为一个博爱的程序媛,我还要一定要做这个事情（为什么我写了这句话感觉到好邪恶！）:</p>
<ul>
<li><p>Android版本: <a href="https://github.com/WildDogTeam/lib-android-wildgeo" rel="nofollow noreferrer" target="_blank">https://github.com/WildDogTeam/lib-android-wildgeo</a></p></li>
<li><p>IOS版本: <a href="https://github.com/WildDogTeam/lib-ios-wildgeo" rel="nofollow noreferrer" target="_blank">https://github.com/WildDogTeam/lib-ios-wildgeo</a></p></li>
</ul>
<p>鉴于本人是一个前端攻城狮,所以这两个版本的东西我也就只能给你们一个链接吧,各位IOS攻城狮和Android攻城狮,来玩玩么?</p>

                
{{< /raw >}}

# 版权声明
本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，

本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。

原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！

## 原文标题
为了监视快递小哥，我做了一个小程序！

## 原文链接
[https://segmentfault.com/a/1190000006839321](https://segmentfault.com/a/1190000006839321)

