---
title: '黑科技：LocalStorage 缓存机制' 
date: 2018-12-12 2:30:10
hidden: true
slug: 90eu6j71dz
categories: [reprint]
---

{{< raw >}}

                    
<h1 id="articleHeader0">黑科技：LocalStorage 缓存机制</h1>
<p>事情的起因是我的同事<em>金果</em>问我：<br>- “你知道微信公众号文章的渲染方式吗？”</p>
<p>对此，我的反应是：<br>- “啊？”</p>
<p>金果继续问：<br>- “控制台的 Network 里没有发生任何请求，文章里的内容是怎么来的？”</p>
<p>说到这儿我好像大概理解她的意思，于是打开控制台的 Network 确认一下果真如此，文章中的内容并不是通过 http 请求获取的。</p>
<p><span class="img-wrap"><img data-src="/img/remote/1460000013480585?w=996&amp;h=566" src="https://static.alili.tech/img/remote/1460000013480585?w=996&amp;h=566" alt="image_1c5hrfi6bcjg11jtj041plo11vp9.png-114.5kB" title="image_1c5hrfi6bcjg11jtj041plo11vp9.png-114.5kB" style="cursor: pointer; display: inline;"></span></p>
<p>首先我想到的是：<br>- “会不会是服务器端渲染的？”</p>
<p>于是我找到请求得到的 html 文件却发现：</p>
<p>- “只有文章的标题是服务器端渲染的，那么文章的内容就只能在 js 文件中。”</p>
<p>我继续寻找请求得到的 js 文件却发现空空如也：<br>- “难道 js 文件都被缓存到 localStorage 里？！”</p>
<p><span class="img-wrap"><img data-src="/img/remote/1460000013480586?w=996&amp;h=566" src="https://static.alili.tech/img/remote/1460000013480586?w=996&amp;h=566" alt="image_1c5hs078em851ha81kuq830os9m.png-97.4kB" title="image_1c5hs078em851ha81kuq830os9m.png-97.4kB" style="cursor: pointer; display: inline;"></span></p>
<p>看到 Local Storage 里密密麻麻的 js 文件我心里一阵澎湃：这确实是一种可以尝试的前端加载性能优化的方式。</p>
<p><span class="img-wrap"><img data-src="/img/remote/1460000013480587?w=996&amp;h=566" src="https://static.alili.tech/img/remote/1460000013480587?w=996&amp;h=566" alt="image_1c5hs7q02ppe4vh14vhv8917nu13.png-394.6kB" title="image_1c5hs7q02ppe4vh14vhv8917nu13.png-394.6kB" style="cursor: pointer; display: inline;"></span></p>
<h2 id="articleHeader1">使用 localStorage 进行资源缓存的解决方案梳理</h2>
<h3 id="articleHeader2">缓存更新机制</h3>
<p>项目在迭代开发的过程中，难以避免需要更新资源文件，常用的方法有`文件名${md5}.js`或者在资源 url 后面加上特定后缀的方式 etc.，而在微信做法中以 <em>__MOON__pages/report.js</em> 为例，其版本信息使用 key 为 <em>__MOON__pages/report.js_ver</em> 的存储项保存：</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="__MOON__pages/report.js_ver: //res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/report3b8dd6.js" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs awk"><code style="word-break: break-word; white-space: initial;">__MOON__pages<span class="hljs-regexp">/report.js_ver: /</span><span class="hljs-regexp">/res.wx.qq.com/mm</span>bizwap<span class="hljs-regexp">/zh_CN/</span>htmledition<span class="hljs-regexp">/js/</span>pages<span class="hljs-regexp">/report3b8dd6.js</span></code></pre>
<p>我们不直接使用这个 value 动态插入 script 节点来加载该文件，而是根据后端提供的配置信息，判断是选择使用缓存的 <em>__MOON__pages/report.js</em> 文件，还是重新发起加载请求。</p>
<h3 id="articleHeader3">搭建更新代码的脚手架</h3>
<p>（加载 combo 化）使用基于 localStorage 的缓存机制，就需要一个脚手架来管理资源文件的读取和写入，不难看出微信使用的是自己开发的脚手架 <em>moon.js</em>，阅读其源码代价较大，暂不分析。</p>
<h3 id="articleHeader4">资源配置信息</h3>
<p>前端在进行资源更新时需要后端提供一份依据供前端用于判断哪些资源需要更新，并且脚手架 moon.js 需要该资源配置信息才能正常工作，所以配置信息一定要在 moon.js 的 script 标签前输出：</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="window.moon_map = {&quot;new_video/player.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/new_video/player.html3b8dd6.js&quot;,&quot;biz_wap/zepto/touch.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/zepto/touch34c264.js&quot;,&quot;biz_wap/zepto/event.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/zepto/event34c264.js&quot;,&quot;biz_wap/zepto/zepto.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/zepto/zepto34c264.js&quot;,&quot;page/pages/video.css&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/pages/video.css3b8dd6.js&quot;,&quot;a/appdialog_confirm.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/appdialog_confirm.html34f0d8.js&quot;,&quot;widget/wx_profile_dialog_primary.css&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/widget/wx_profile_dialog_primary.css34f0d8.js&quot;,&quot;appmsg/emotion/caret.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/caret278965.js&quot;,&quot;new_video/player.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/new_video/player3b8ecd.js&quot;,&quot;a/appdialog_confirm.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/appdialog_confirm34c32a.js&quot;,&quot;biz_wap/jsapi/cardticket.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/cardticket34c264.js&quot;,&quot;biz_common/utils/emoji_panel_data.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/emoji_panel_data3518c6.js&quot;,&quot;biz_common/utils/emoji_data.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/emoji_data3518c6.js&quot;,&quot;appmsg/emotion/textarea.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/textarea353f34.js&quot;,&quot;appmsg/emotion/nav.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/nav278965.js&quot;,&quot;appmsg/emotion/common.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/common3518c6.js&quot;,&quot;appmsg/emotion/slide.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/slide2a9cd9.js&quot;,&quot;pages/loadscript.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/loadscript39aac6.js&quot;,&quot;pages/music_report_conf.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/music_report_conf39aac6.js&quot;,&quot;pages/report.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/report3b8dd6.js&quot;,&quot;pages/player_adaptor.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/player_adaptor39d6ee.js&quot;,&quot;pages/music_player.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/music_player3af14e.js&quot;,&quot;appmsg/emotion/dom.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/dom31ff31.js&quot;,&quot;appmsg/comment_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/comment_tpl.html36c376.js&quot;,&quot;biz_wap/utils/fakehash.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/fakehash38c7af.js&quot;,&quot;biz_common/utils/wxgspeedsdk.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/wxgspeedsdk3518c6.js&quot;,&quot;a/video.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/video3b8ecd.js&quot;,&quot;a/sponsor.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/sponsor3b86a9.js&quot;,&quot;a/app_card.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/app_card393ef4.js&quot;,&quot;a/ios.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/ios393966.js&quot;,&quot;a/android.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/android393966.js&quot;,&quot;a/profile.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/profile31ff31.js&quot;,&quot;a/cpc_a_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/cpc_a_tpl.html3b540a.js&quot;,&quot;a/sponsor_a_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/sponsor_a_tpl.html36c7cf.js&quot;,&quot;a/a_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/a_tpl.html3b86a9.js&quot;,&quot;a/mpshop.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/mpshop311179.js&quot;,&quot;a/wxopen_card.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/wxopen_card3a95b8.js&quot;,&quot;a/card.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/card311179.js&quot;,&quot;biz_wap/utils/position.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/position34c264.js&quot;,&quot;a/a_report.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/a_report393966.js&quot;,&quot;appmsg/my_comment_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/my_comment_tpl.html36906d.js&quot;,&quot;appmsg/cmt_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/cmt_tpl.html369d00.js&quot;,&quot;sougou/a_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/sougou/a_tpl.html2c6e7c.js&quot;,&quot;appmsg/emotion/emotion.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/emotion353f34.js&quot;,&quot;biz_wap/utils/wapsdk.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/wapsdk34c264.js&quot;,&quot;biz_common/utils/report.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/report3518c6.js&quot;,&quot;appmsg/open_url_with_webview.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/open_url_with_webview3145f0.js&quot;,&quot;biz_common/utils/http.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/http3518c6.js&quot;,&quot;biz_common/utils/cookie.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/cookie3518c6.js&quot;,&quot;appmsg/topic_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/topic_tpl.html31ff31.js&quot;,&quot;pages/weapp_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/weapp_tpl.html36906d.js&quot;,&quot;biz_common/utils/monitor.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/monitor3518c6.js&quot;,&quot;appmsg/weapp_common.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/weapp_common3af55a.js&quot;,&quot;pages/voice_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/voice_tpl.html38518d.js&quot;,&quot;pages/kugoumusic_ctrl.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/kugoumusic_ctrl393e3a.js&quot;,&quot;pages/qqmusic_ctrl.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/qqmusic_ctrl39b68c.js&quot;,&quot;pages/voice_component.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/voice_component3af14e.js&quot;,&quot;pages/qqmusic_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/qqmusic_tpl.html393e3a.js&quot;,&quot;new_video/ctl.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/new_video/ctl2d441f.js&quot;,&quot;a/testdata.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/testdata3b86a9.js&quot;,&quot;appmsg/reward_entry.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/reward_entry3b1cff.js&quot;,&quot;appmsg/comment.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/comment3944ad.js&quot;,&quot;appmsg/like.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/like375fea.js&quot;,&quot;pages/version4video.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/version4video3a9bef.js&quot;,&quot;a/a.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/a3b8ecd.js&quot;,&quot;rt/appmsg/getappmsgext.rt.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/rt/appmsg/getappmsgext.rt2c21f6.js&quot;,&quot;biz_wap/utils/storage.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/storage34c264.js&quot;,&quot;biz_common/tmpl.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/tmpl3518c6.js&quot;,&quot;appmsg/share_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/share_tpl.html36906d.js&quot;,&quot;appmsg/img_copyright_tpl.html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/img_copyright_tpl.html2a2c13.js&quot;,&quot;pages/video_ctrl.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/video_ctrl36ebcf.js&quot;,&quot;biz_common/ui/imgonepx.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/ui/imgonepx3518c6.js&quot;,&quot;biz_common/utils/respTypes.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/respTypes3518c6.js&quot;,&quot;biz_wap/utils/log.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/log34c264.js&quot;,&quot;sougou/index.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/sougou/index36913b.js&quot;,&quot;biz_wap/safe/mutation_observer_report.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/safe/mutation_observer_report34c264.js&quot;,&quot;appmsg/fereport.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/fereport3b9457.js&quot;,&quot;appmsg/report.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/report3404b3.js&quot;,&quot;appmsg/report_and_source.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/report_and_source3a7477.js&quot;,&quot;appmsg/page_pos.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/page_pos3a95b8.js&quot;,&quot;appmsg/cdn_speed_report.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/cdn_speed_report3097b2.js&quot;,&quot;appmsg/wxtopic.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/wxtopic31a3be.js&quot;,&quot;appmsg/new_index.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/new_index36906d.js&quot;,&quot;appmsg/weapp.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/weapp3af55a.js&quot;,&quot;appmsg/weproduct.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/weproduct3af55a.js&quot;,&quot;appmsg/voicemsg.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/voicemsg3b1748.js&quot;,&quot;appmsg/autoread.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/autoread3af14e.js&quot;,&quot;appmsg/voice.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/voice38518d.js&quot;,&quot;appmsg/qqmusic.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/qqmusic39dc43.js&quot;,&quot;appmsg/iframe.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/iframe39ab71.js&quot;,&quot;appmsg/product.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/product393966.js&quot;,&quot;appmsg/review_image.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/review_image3af55a.js&quot;,&quot;appmsg/outer_link.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/outer_link275627.js&quot;,&quot;appmsg/copyright_report.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/copyright_report2ec4b2.js&quot;,&quot;appmsg/async.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/async3b27d5.js&quot;,&quot;biz_wap/ui/lazyload_img.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/ui/lazyload_img3af55a.js&quot;,&quot;biz_common/log/jserr.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/log/jserr3518c6.js&quot;,&quot;appmsg/share.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/share3b4418.js&quot;,&quot;appmsg/cdn_img_lib.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/cdn_img_lib38b7bb.js&quot;,&quot;biz_common/utils/url/parse.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/url/parse36ebcf.js&quot;,&quot;page/appmsg/not_in_mm.css&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/not_in_mm.css36906d.js&quot;,&quot;page/appmsg/page_mp_article_improve_combo.css&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_combo.css3b86a9.js&quot;,&quot;page/appmsg_new/not_in_mm.css&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg_new/not_in_mm.css36f05c.js&quot;,&quot;page/appmsg_new/combo.css&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg_new/combo.css3b86a9.js&quot;,&quot;biz_wap/jsapi/core.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/core3b0568.js&quot;,&quot;biz_common/dom/event.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/event3a25e9.js&quot;,&quot;appmsg/test.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/test354009.js&quot;,&quot;biz_wap/utils/mmversion.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/mmversion34c264.js&quot;,&quot;appmsg/max_age.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/max_age2fdd28.js&quot;,&quot;biz_common/dom/attr.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/attr3518c6.js&quot;,&quot;biz_wap/utils/ajax.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/ajax38c31a.js&quot;,&quot;appmsg/log.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/log300330.js&quot;,&quot;biz_common/dom/class.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/class3518c6.js&quot;,&quot;biz_wap/utils/device.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/device34c264.js&quot;,&quot;biz_common/utils/string/html.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/string/html3518c6.js&quot;,&quot;appmsg/index.js&quot;:&quot;//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/index3b1748.js&quot;};" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre><code style="word-break: break-word; white-space: initial;">window.moon_map = {"new_video/player.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/new_video/player.html3b8dd6.js","biz_wap/zepto/touch.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/zepto/touch34c264.js","biz_wap/zepto/event.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/zepto/event34c264.js","biz_wap/zepto/zepto.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/zepto/zepto34c264.js","page/pages/video.css":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/pages/video.css3b8dd6.js","a/appdialog_confirm.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/appdialog_confirm.html34f0d8.js","widget/wx_profile_dialog_primary.css":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/widget/wx_profile_dialog_primary.css34f0d8.js","appmsg/emotion/caret.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/caret278965.js","new_video/player.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/new_video/player3b8ecd.js","a/appdialog_confirm.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/appdialog_confirm34c32a.js","biz_wap/jsapi/cardticket.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/cardticket34c264.js","biz_common/utils/emoji_panel_data.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/emoji_panel_data3518c6.js","biz_common/utils/emoji_data.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/emoji_data3518c6.js","appmsg/emotion/textarea.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/textarea353f34.js","appmsg/emotion/nav.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/nav278965.js","appmsg/emotion/common.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/common3518c6.js","appmsg/emotion/slide.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/slide2a9cd9.js","pages/loadscript.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/loadscript39aac6.js","pages/music_report_conf.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/music_report_conf39aac6.js","pages/report.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/report3b8dd6.js","pages/player_adaptor.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/player_adaptor39d6ee.js","pages/music_player.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/music_player3af14e.js","appmsg/emotion/dom.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/dom31ff31.js","appmsg/comment_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/comment_tpl.html36c376.js","biz_wap/utils/fakehash.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/fakehash38c7af.js","biz_common/utils/wxgspeedsdk.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/wxgspeedsdk3518c6.js","a/video.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/video3b8ecd.js","a/sponsor.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/sponsor3b86a9.js","a/app_card.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/app_card393ef4.js","a/ios.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/ios393966.js","a/android.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/android393966.js","a/profile.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/profile31ff31.js","a/cpc_a_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/cpc_a_tpl.html3b540a.js","a/sponsor_a_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/sponsor_a_tpl.html36c7cf.js","a/a_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/a_tpl.html3b86a9.js","a/mpshop.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/mpshop311179.js","a/wxopen_card.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/wxopen_card3a95b8.js","a/card.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/card311179.js","biz_wap/utils/position.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/position34c264.js","a/a_report.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/a_report393966.js","appmsg/my_comment_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/my_comment_tpl.html36906d.js","appmsg/cmt_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/cmt_tpl.html369d00.js","sougou/a_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/sougou/a_tpl.html2c6e7c.js","appmsg/emotion/emotion.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/emotion/emotion353f34.js","biz_wap/utils/wapsdk.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/wapsdk34c264.js","biz_common/utils/report.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/report3518c6.js","appmsg/open_url_with_webview.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/open_url_with_webview3145f0.js","biz_common/utils/http.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/http3518c6.js","biz_common/utils/cookie.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/cookie3518c6.js","appmsg/topic_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/topic_tpl.html31ff31.js","pages/weapp_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/weapp_tpl.html36906d.js","biz_common/utils/monitor.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/monitor3518c6.js","appmsg/weapp_common.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/weapp_common3af55a.js","pages/voice_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/voice_tpl.html38518d.js","pages/kugoumusic_ctrl.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/kugoumusic_ctrl393e3a.js","pages/qqmusic_ctrl.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/qqmusic_ctrl39b68c.js","pages/voice_component.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/voice_component3af14e.js","pages/qqmusic_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/qqmusic_tpl.html393e3a.js","new_video/ctl.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/new_video/ctl2d441f.js","a/testdata.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/testdata3b86a9.js","appmsg/reward_entry.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/reward_entry3b1cff.js","appmsg/comment.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/comment3944ad.js","appmsg/like.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/like375fea.js","pages/version4video.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/version4video3a9bef.js","a/a.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/a/a3b8ecd.js","rt/appmsg/getappmsgext.rt.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/rt/appmsg/getappmsgext.rt2c21f6.js","biz_wap/utils/storage.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/storage34c264.js","biz_common/tmpl.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/tmpl3518c6.js","appmsg/share_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/share_tpl.html36906d.js","appmsg/img_copyright_tpl.html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/img_copyright_tpl.html2a2c13.js","pages/video_ctrl.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/pages/video_ctrl36ebcf.js","biz_common/ui/imgonepx.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/ui/imgonepx3518c6.js","biz_common/utils/respTypes.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/respTypes3518c6.js","biz_wap/utils/log.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/log34c264.js","sougou/index.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/sougou/index36913b.js","biz_wap/safe/mutation_observer_report.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/safe/mutation_observer_report34c264.js","appmsg/fereport.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/fereport3b9457.js","appmsg/report.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/report3404b3.js","appmsg/report_and_source.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/report_and_source3a7477.js","appmsg/page_pos.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/page_pos3a95b8.js","appmsg/cdn_speed_report.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/cdn_speed_report3097b2.js","appmsg/wxtopic.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/wxtopic31a3be.js","appmsg/new_index.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/new_index36906d.js","appmsg/weapp.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/weapp3af55a.js","appmsg/weproduct.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/weproduct3af55a.js","appmsg/voicemsg.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/voicemsg3b1748.js","appmsg/autoread.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/autoread3af14e.js","appmsg/voice.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/voice38518d.js","appmsg/qqmusic.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/qqmusic39dc43.js","appmsg/iframe.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/iframe39ab71.js","appmsg/product.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/product393966.js","appmsg/review_image.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/review_image3af55a.js","appmsg/outer_link.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/outer_link275627.js","appmsg/copyright_report.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/copyright_report2ec4b2.js","appmsg/async.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/async3b27d5.js","biz_wap/ui/lazyload_img.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/ui/lazyload_img3af55a.js","biz_common/log/jserr.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/log/jserr3518c6.js","appmsg/share.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/share3b4418.js","appmsg/cdn_img_lib.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/cdn_img_lib38b7bb.js","biz_common/utils/url/parse.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/url/parse36ebcf.js","page/appmsg/not_in_mm.css":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/not_in_mm.css36906d.js","page/appmsg/page_mp_article_improve_combo.css":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_combo.css3b86a9.js","page/appmsg_new/not_in_mm.css":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg_new/not_in_mm.css36f05c.js","page/appmsg_new/combo.css":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg_new/combo.css3b86a9.js","biz_wap/jsapi/core.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/jsapi/core3b0568.js","biz_common/dom/event.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/event3a25e9.js","appmsg/test.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/test354009.js","biz_wap/utils/mmversion.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/mmversion34c264.js","appmsg/max_age.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/max_age2fdd28.js","biz_common/dom/attr.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/attr3518c6.js","biz_wap/utils/ajax.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/ajax38c31a.js","appmsg/log.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/log300330.js","biz_common/dom/class.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/dom/class3518c6.js","biz_wap/utils/device.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_wap/utils/device34c264.js","biz_common/utils/string/html.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/biz_common/utils/string/html3518c6.js","appmsg/index.js":"//res.wx.qq.com/mmbizwap/zh_CN/htmledition/js/appmsg/index3b1748.js"};</code></pre>
<h3 id="articleHeader5">存在 XSS 安全隐患</h3>
<p>在 <em>__MOON__pages/report.js</em> 文件的入口处加入代码 <em>alert('Helo World');</em> 如图所示：</p>
<p><span class="img-wrap"><img data-src="/img/remote/1460000013480588?w=996&amp;h=566" src="https://static.alili.tech/img/remote/1460000013480588?w=996&amp;h=566" alt="image_1c5hughjh1p4lspo47j1mgs1aou2g.png-392.2kB" title="image_1c5hughjh1p4lspo47j1mgs1aou2g.png-392.2kB" style="cursor: pointer; display: inline;"></span></p>
<p>刷新页面后弹出提示 “Hello World”，说明使用基于 localStorage 的缓存机制存在一些安全隐患，并且微信尚未对这些攻击漏洞进行处理。</p>
<p><span class="img-wrap"><img data-src="/img/remote/1460000013480589?w=500&amp;h=139" src="https://static.alili.tech/img/remote/1460000013480589?w=500&amp;h=139" alt="image_1c5huj6jqfutfp615v6ehj7dj2t.png-12.9kB" title="image_1c5huj6jqfutfp615v6ehj7dj2t.png-12.9kB" style="cursor: pointer; display: inline;"></span></p>
<h2 id="articleHeader6">关于使用 localStorage 进行资源缓存其他思考</h2>
<ol>
<li>如果先输出 html 然后用 js 从本地缓存读取样式再插入会出现严重的阻塞和闪烁问题</li>
<li>这种解决方案更加适合单页面应用否则容易产生冗余</li>
<li>存在浏览器兼容性问题（隐身模式 etc.）（微信具有自己的X5内核完美解决该问题）</li>
<li>网络速度快，协商缓存的响应延迟可能比 <em>LS读取+eval</em> 更小</li>
<li>浏览器对于单次 set 和对 LS（本质是 SQL lite）的总容量存在限制</li>
<li>可以节省流量，并且可以用于 A/B test</li>
<li>移动端的浏览器缓存经常会被清理且网络状态通常较差，更加适合这种解决方案</li>
</ol>
<p><a href="https://github.com/scrat-team/scrat-site" rel="nofollow noreferrer" target="_blank"></a><a href="https://github.com/scrat-team/scrat-site" rel="nofollow noreferrer" target="_blank">https://github.com/scrat-team...</a><br><a href="https://github.com/mtjs/mt" rel="nofollow noreferrer" target="_blank"></a><a href="https://github.com/mtjs/mt" rel="nofollow noreferrer" target="_blank">https://github.com/mtjs/mt</a></p>
<blockquote>最后突然想起一句话：不要指望代码能解决一切问题。</blockquote>

                
{{< /raw >}}

# 版权声明
本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，

本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。

原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！

## 原文标题
黑科技：LocalStorage 缓存机制

## 原文链接
[https://segmentfault.com/a/1190000013480580](https://segmentfault.com/a/1190000013480580)

