---
title: '前端模板的原理与实现' 
date: 2019-02-03 2:30:39
hidden: true
slug: g6kvbj2tctr
categories: [reprint]
---

{{< raw >}}

                    
<p>时下流行什么react, avalon, angular, vue什么，其核心都离不开前端模板。理解前端模板，是我们了解MV* 的关键。 </p>
<p>前端框架最重要的目的是将页面渲染出来。“渲染”（render）这个词最初不是前端的东西的。前端之前叫做切图，将设计师做的PSD变成一个静态页面，然后加上动态交互。但是我们有许多数据是来自后端，如何将数据加入静态页面呢？于是又多了一套工序叫“套页面”。套页面的过程实际就是将静态页面变成切割成一块块，每一块都是一个php，jsp或vm文件，它们是<strong>后端模板引擎</strong>的处理对象！</p>
<p>其实模板是不局限于后端还是前端的， 模板的本质是用于从<strong>数据（变量）</strong>到实际的<strong>视觉表现（HTML代码）</strong>这项工作的一种实现手段。由于后端近水楼台先得月（取数据比较方便），因此先在后端发展出这种技术。这些后端模板文件是活动于服务器的，然后经过复杂的处理，最后由浏览器渲染出来。这时的渲染是将服务器拼接好的静态文本变成一个DOM树的过程。</p>
<p>如果要实现前端实现MVC或MVP，那些工序必须发生改变。静态文件产出是不变，尤其是大公司，分工够细，有专门的切图组（大多数是妹子）将它们做出来。接着是套页面，这时就不能使用后端模板引擎，需要引入前端模板引擎。由于实现一个前端模板引擎太简单了，经过多年的发展，已经有众多好用的轮子：</p>
<p><a href="https://github.com/janl/mustache.js" rel="nofollow noreferrer" target="_blank">https://github.com/janl/musta...</a><br>基于JavaScript的Logic-less（无逻辑或轻逻辑）模板。 </p>
<p><a href="https://github.com/twitter/hogan.js" rel="nofollow noreferrer" target="_blank">https://github.com/twitter/ho...</a><br>上面的优化版，twitter出品</p>
<p><a href="https://github.com/wycats/handlebars.js" rel="nofollow noreferrer" target="_blank">https://github.com/wycats/han...</a><br>完全兼容mustcache的语法</p>
<p><a href="https://github.com/paularmstrong/swig" rel="nofollow noreferrer" target="_blank">https://github.com/paularmstr...</a><br>拥有更强悍的模板继承与block 重写功能</p>
<p><a href="https://github.com/mozilla/nunjucks" rel="nofollow noreferrer" target="_blank">https://github.com/mozilla/nu...</a><br>跟django的模板系统相似，可以说swig的升级版，是gitbook的御用前端模板</p>
<p>其它推荐的还有ejs， 易学易用，对有过ASP/PHP/JSP编程经验的人来说，非常亲切自然，缺点就是功能有点简单。</p>
<p>其他doT,  xtempalate， Underscore Templates。 </p>
<p>最不推荐是jade， 有点华而不实，过度设计，导致套页面工作量大，性能其差。</p>
<p>虚拟DOM时代流行的jsx就是无逻辑模板。之所以流行无逻辑或轻逻辑模板，其主要原因是改动成本比较少，像jade这样自造语法糖太多，从美工手中拿来的html需要大动干戈，进行摧心折骨般的改造才能套数据。对于模板来说，最简单而言，就是将某个可变数据放到适当的地方（<strong>填空</strong>），而其次，可以控制这个区域输出不输入（<strong>if指令</strong>)，或让其个区域循环输入多次（<strong>for指令</strong>)，更强制，实现模板互相套嵌（<strong>layout与block</strong>）。为了实现if与for有两种方法，一种是单纯的区域，插入一个js 语句，里面有if语句与for语句，另一种是使用语法糖，比如说 ms-for, ms-repeat, ng-if, ng-repeat。语法糖的用法比直接使用JS语句简单，但是带来学习成本与拓展功能。每一个模板 if, for指令的语法都不一样的，并且你想在循环做一些处理，比如过滤一些数据，或突然在某处中断，这又得引用一些新的语句。随着模板要求前后共用，就有了传输成本，直接写JS语句在模板里面肯定比不过语法糖。因此基于这种种原因，mustache风格的模板就成为主流。</p>
<p>现在三种模板风格：</p>
<p>PHP/ASP/JSP风格：</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="<% if ( list.length ) { %>
  <ol>
    <% for ( n=0; n<list.length; ++n ) { %>
      <li>
        <%= list[n] %>
      </li>
    <% } %>
  </ol>
<% } %>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs erb"><code><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">%</span></span></span><span class="ruby"> <span class="hljs-keyword">if</span> ( list.length ) { </span><span class="xml"><span class="hljs-tag">%&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">%</span></span></span><span class="ruby"> <span class="hljs-keyword">for</span> ( n=<span class="hljs-number">0</span>; n&lt;list.length; ++n ) { </span><span class="xml"><span class="hljs-tag">%&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">%=</span></span></span><span class="ruby"> list[n] </span><span class="xml"><span class="hljs-tag">%&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">%</span></span></span><span class="ruby"> } </span><span class="xml"><span class="hljs-tag">%&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">%</span></span></span><span class="ruby"> } </span><span class="xml"><span class="hljs-tag">%&gt;</span></span></code></pre>
<p>mustcache风格，高级语法有限，通常难自定义拓展：</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text=""{{"#if list.length"}}"
  <ol>
    "{{"#each list item"}}"
      <li>
        "{{" item "}}"
      </li>
    "{{"/each"}}"
  </ol>
"{{"/if"}}"" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs handlebars"><code><span class="xml"></span><span class="hljs-template-tag">"{{"#<span class="hljs-name"><span class="hljs-builtin-name">if</span></span> list.length"}}"</span><span class="xml">
  <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span>
    </span><span class="hljs-template-tag">"{{"#<span class="hljs-name"><span class="hljs-builtin-name">each</span></span> list item"}}"</span><span class="xml">
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
        </span><span class="hljs-template-variable">"{{" item "}}"</span><span class="xml">
      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    </span><span class="hljs-template-tag">"{{"/<span class="hljs-name"><span class="hljs-builtin-name">each</span></span>"}}"</span><span class="xml">
  <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
</span><span class="hljs-template-tag">"{{"/<span class="hljs-name"><span class="hljs-builtin-name">if</span></span>"}}"</span></code><span class="xml"></span></pre>
<p>属性绑定风格：</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="<ol ms-if=&quot;list.length&quot;>
  <li ms-for=&quot;item in list&quot;>
      "{{"item"}}"
  </li>
</ol>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs stylus"><code>&lt;<span class="hljs-selector-tag">ol</span> ms-<span class="hljs-keyword">if</span>=<span class="hljs-string">"list.length"</span>&gt;
  &lt;<span class="hljs-selector-tag">li</span> ms-<span class="hljs-keyword">for</span>=<span class="hljs-string">"item in list"</span>&gt;
      "{{"item"}}"
  &lt;/li&gt;
&lt;/ol&gt;</code></pre>
<p>前两者只能出现于script, textarea等容器元素内部。因此<code>&lt;</code>分隔符与标签的<code>&lt;</code>容器造成冲突，并且也不利于IDE的格式化处理。属性绑定风格则是MVVM时期最流行的模板定义风格，某页面某个区域就是一个模板，不需要进行入append等操作。</p>
<p>我们再来看如何实现前端模板。前端模板的本质就是一个可以转换函数（渲染函数）的字符串。渲染函数放进一个充满数据的对象后，还原为一个全新的字符串。因此重点是如何构建一个渲染函数。最简单的方式是正则，还记得第二章的format方法吗，这就是一个轻型的填充数据的方法。</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function format(str, object) {
    var array = Array.prototype.slice.call(arguments, 1);
    return str.replace(/\\?\#{([^{}]+)\}/gm, function(match, name) {
        if (match.charAt(0) == '\\')
            return match.slice(1);
        var index = Number(name)
        if (index >= 0)
            return array[index];
        if (object &amp;&amp; object[name] !== void 0)
            return  object[name];
        return  '';
    });
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">format</span>(<span class="hljs-params">str, object</span>) </span>{
    <span class="hljs-keyword">var</span> array = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/\\?\#{([^{}]+)\}/gm</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">match, name</span>) </span>{
        <span class="hljs-keyword">if</span> (match.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">'\\'</span>)
            <span class="hljs-keyword">return</span> match.slice(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">var</span> index = <span class="hljs-built_in">Number</span>(name)
        <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span> array[index];
        <span class="hljs-keyword">if</span> (object &amp;&amp; object[name] !== <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>)
            <span class="hljs-keyword">return</span>  object[name];
        <span class="hljs-keyword">return</span>  <span class="hljs-string">''</span>;
    });
}</code></pre>
<p>format方法是通过<code>#{ }</code>来划分静态内容与动态内容的，一般来说它们称之为定界符（<strong>delimiter</strong>）。<code>#{</code>为前定界符，<code>}</code>为后界符，这个#{}其实是ruby风格的定界符。通常的定界符是<code>&lt;%</code>与<code>%&gt;</code>，<code>"{{"</code>与<code>"}}"</code>  。通常在前定界符中还有一些修饰符号，比如=号，表示这个会输出到页面，-号，表示会去掉两旁的空白。<br>将下例，要编译成一个渲染函数</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="var tpl = '你好,我的名字啊<%name%>, 今年已经 <%info.age%>岁了'
 var data = {
     name: &quot;司徒正美&quot;,
     age: 20
 }" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript"><span class="hljs-keyword">var</span> tpl = <span class="hljs-string">'你好,我的名字啊&lt;%name%&gt;, 今年已经 &lt;%info.age%&gt;岁了'</span>
 <span class="hljs-keyword">var</span> data = {
     <span class="hljs-attr">name</span>: <span class="hljs-string">"司徒正美"</span>,
     <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>
 }</code></pre>
<p>大抵是这样</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="var body = '你好,我的名字叫'+ data.name+ ', 今年已经 '+data.info.age+ '岁了'
var render = new Function('data', 'return '+ body)" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript"><span class="hljs-keyword">var</span> body = <span class="hljs-string">'你好,我的名字叫'</span>+ data.name+ <span class="hljs-string">', 今年已经 '</span>+data.info.age+ <span class="hljs-string">'岁了'</span>
<span class="hljs-keyword">var</span> render = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">'data'</span>, <span class="hljs-string">'return '</span>+ body)</code></pre>
<p>或者聪明一点，使用数组来join:</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="var array = ['return ']
array.push('你好,我的名字叫'）
array.push(data.name)
array.push(', 今年已经')
array.push(data.info.age)
array.push( '岁了')
var render = new Function('data', array.join('+'))" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript"><span class="hljs-keyword">var</span> array = [<span class="hljs-string">'return '</span>]
array.push(<span class="hljs-string">'你好,我的名字叫'</span>）
array.push(data.name)
array.push(<span class="hljs-string">', 今年已经'</span>)
array.push(data.info.age)
array.push( <span class="hljs-string">'岁了'</span>)
<span class="hljs-keyword">var</span> render = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">'data'</span>, array.join(<span class="hljs-string">'+'</span>))</code></pre>
<p>这就得区分静态内容与为变量前加<code>data.</code>前缀。这一步可以用正则来做，也可以用纯字符串。我们试一下纯字符串方式。假令前定界符为openTag，后定界符为closeTag，通过indexOf 与slice方法，就可以将它切成一块块。</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function tokenize(str) {
    var openTag = '<%'
    var closeTag = '%>'
    var ret = []
    do {
        var index = str.indexOf(openTag)
        index = index === -1 ? str.length : index
        var value = str.slice(0, index)
        //抽取"{{"前面的静态内容
        ret.push({
            expr: value,
            type: 'text'
        })
        //改变str字符串自身
        str = str.slice(index + openTag.length)
        if (str) {
            index = str.indexOf(closeTag)
            var value = str.slice(0, index)
            //抽取"{{"与"}}"的动态内容
            ret.push({
                expr: value.trim(),//JS逻辑两旁的空白可以省去
                type: 'js'
            })
            //改变str字符串自身
            str = str.slice(index + closeTag.length)
        }
    } while (str.length)
    return ret
}
console.log(tokenize(tpl))" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs axapta"><code>function tokenize(<span class="hljs-keyword">str</span>) {
    var openTag = <span class="hljs-string">'&lt;%'</span>
    var closeTag = <span class="hljs-string">'%&gt;'</span>
    var ret = []
    do {
        var <span class="hljs-keyword">index</span> = <span class="hljs-keyword">str</span>.indexOf(openTag)
        <span class="hljs-keyword">index</span> = <span class="hljs-keyword">index</span> === <span class="hljs-number">-1</span> ? <span class="hljs-keyword">str</span>.length : <span class="hljs-keyword">index</span>
        var value = <span class="hljs-keyword">str</span>.slice(<span class="hljs-number">0</span>, <span class="hljs-keyword">index</span>)
        <span class="hljs-comment">//抽取"{{"前面的静态内容</span>
        ret.push({
            expr: value,
            type: <span class="hljs-string">'text'</span>
        })
        <span class="hljs-comment">//改变str字符串自身</span>
        <span class="hljs-keyword">str</span> = <span class="hljs-keyword">str</span>.slice(<span class="hljs-keyword">index</span> + openTag.length)
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">str</span>) {
            <span class="hljs-keyword">index</span> = <span class="hljs-keyword">str</span>.indexOf(closeTag)
            var value = <span class="hljs-keyword">str</span>.slice(<span class="hljs-number">0</span>, <span class="hljs-keyword">index</span>)
            <span class="hljs-comment">//抽取"{{"与"}}"的动态内容</span>
            ret.push({
                expr: value.trim(),<span class="hljs-comment">//JS逻辑两旁的空白可以省去</span>
                type: <span class="hljs-string">'js'</span>
            })
            <span class="hljs-comment">//改变str字符串自身</span>
            <span class="hljs-keyword">str</span> = <span class="hljs-keyword">str</span>.slice(<span class="hljs-keyword">index</span> + closeTag.length)
        }
    } <span class="hljs-keyword">while</span> (<span class="hljs-keyword">str</span>.length)
    <span class="hljs-keyword">return</span> ret
}
console.log(tokenize(tpl))</code></pre>
<p><span class="img-wrap"><img data-src="/img/bVDuyQ?w=335&amp;h=368" src="https://static.alili.tech/img/bVDuyQ?w=335&amp;h=368" alt="clipboard.png" title="clipboard.png" style="cursor: pointer;"></span></p>
<p>然后通过render方法将它们拼接起来。</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function render(str) {
     var tokens = tokenize(str)
     var ret = []
     for (var i = 0, token; token = tokens[i++]; ) {
         if (token.type === 'text') {
             ret.push('&quot;' + token.expr + '&quot;')
         } else {
             ret.push(token.expr)
         }
     }
     console.log(&quot;return &quot;+ ret.join('+'))
 }" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs stata"><code>function render(str) {
     <span class="hljs-keyword">var</span> tokens = <span class="hljs-keyword">tokenize</span>(str)
     <span class="hljs-keyword">var</span> <span class="hljs-keyword">ret</span> = []
     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = 0, <span class="hljs-keyword">token</span>; <span class="hljs-keyword">token</span> = tokens[i++]; ) {
         <span class="hljs-keyword">if</span> (<span class="hljs-keyword">token</span>.<span class="hljs-keyword">type</span> === 'text') {
             <span class="hljs-keyword">ret</span>.push('<span class="hljs-string">"' + token.expr + '"</span>')
         } <span class="hljs-keyword">else</span> {
             <span class="hljs-keyword">ret</span>.push(<span class="hljs-keyword">token</span>.expr)
         }
     }
     console.<span class="hljs-built_in">log</span>(<span class="hljs-string">"return "</span>+ <span class="hljs-keyword">ret</span>.join('+'))
 }</code></pre>
<p>打印出来如下</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="return &quot;你好,我的名字叫&quot;+name+&quot;, 今年已经 &quot;+info.age+&quot;岁了&quot;" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs applescript"><code style="word-break: break-word; white-space: initial;"><span class="hljs-built_in">return</span> <span class="hljs-string">"你好,我的名字叫"</span>+<span class="hljs-built_in">name</span>+<span class="hljs-string">", 今年已经 "</span>+info.age+<span class="hljs-string">"岁了"</span></code></pre>
<p>这个方法还不完整。首先光是在两旁加上双引号是不可靠的，万一里面还有双引号怎么办。因此我们需要引入第二章介绍的quote方法，当类型为文本时，<code>ret.push(+quote(token.expr)+）</code>。其次需要对动态部分的变量加上<code>.data</code>。怎么知道它是一个变量呢。我们回想一下变量的定义，就是以_,$或字母开头的字符组合。为了简洁起见，我们暂时不用里会中文的情况。不过，<code>info.age</code>这个字符串里面，其实有两个符合变量的子串，而我只需要在info前面加<code>data.</code>。这时，我们需要设法在匹配变量前，将对象的子级属性替换掉，替换成不符合变量的字符，然后再替换为去。为此，我搞了一个dig与fill方法，将子级属性变成<code>??12</code>这样的字符串:</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text=" var quote = JSON.stringify//自己到第二章找完整函数
 var rident = /[$a-zA-Z_][$a-zA-Z0-9_]*/g
 var rproperty = /\.\s*[\w\.\$]+/g
 var number = 1
 var rfill = /\?\?\d+/g
 var stringPool = {}
 function dig(a) {
     var key = '??' + number++
     stringPool[key] = a
     return key
 }
 function fill(a) {
     return stringPool[a]
 }
 function render(str) {
     stringPool = {}
     var tokens = tokenize(str)
     var ret = []
     for (var i = 0, token; token = tokens[i++]; ) {
         if (token.type === 'text') {
             ret.push(quote(token.expr))
         } else {
             // 先去掉对象的子级属性,减少干扰因素
             var js = token.expr.replace(rproperty, dig)
             js = js.replace(rident, function (a) {
                 return 'data.' + a
             })
             js = js.replace(rfill, fill)
             ret.push(js)
         }
     }
     console.log(&quot;return &quot; + ret.join('+'))
 }
render(tpl)" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs javascript"><code> <span class="hljs-keyword">var</span> quote = <span class="hljs-built_in">JSON</span>.stringify<span class="hljs-comment">//自己到第二章找完整函数</span>
 <span class="hljs-keyword">var</span> rident = <span class="hljs-regexp">/[$a-zA-Z_][$a-zA-Z0-9_]*/g</span>
 <span class="hljs-keyword">var</span> rproperty = <span class="hljs-regexp">/\.\s*[\w\.\$]+/g</span>
 <span class="hljs-keyword">var</span> number = <span class="hljs-number">1</span>
 <span class="hljs-keyword">var</span> rfill = <span class="hljs-regexp">/\?\?\d+/g</span>
 <span class="hljs-keyword">var</span> stringPool = {}
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dig</span>(<span class="hljs-params">a</span>) </span>{
     <span class="hljs-keyword">var</span> key = <span class="hljs-string">'??'</span> + number++
     stringPool[key] = a
     <span class="hljs-keyword">return</span> key
 }
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fill</span>(<span class="hljs-params">a</span>) </span>{
     <span class="hljs-keyword">return</span> stringPool[a]
 }
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">str</span>) </span>{
     stringPool = {}
     <span class="hljs-keyword">var</span> tokens = tokenize(str)
     <span class="hljs-keyword">var</span> ret = []
     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, token; token = tokens[i++]; ) {
         <span class="hljs-keyword">if</span> (token.type === <span class="hljs-string">'text'</span>) {
             ret.push(quote(token.expr))
         } <span class="hljs-keyword">else</span> {
             <span class="hljs-comment">// 先去掉对象的子级属性,减少干扰因素</span>
             <span class="hljs-keyword">var</span> js = token.expr.replace(rproperty, dig)
             js = js.replace(rident, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a</span>) </span>{
                 <span class="hljs-keyword">return</span> <span class="hljs-string">'data.'</span> + a
             })
             js = js.replace(rfill, fill)
             ret.push(js)
         }
     }
     <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"return "</span> + ret.join(<span class="hljs-string">'+'</span>))
 }
render(tpl)</code></pre>
<p>输出为</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="return &quot;你好,我的名字叫&quot;+data.name+&quot;, 今年已经 &quot;+data.info.age+&quot;岁了&quot;" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs kotlin"><code style="word-break: break-word; white-space: initial;"><span class="hljs-keyword">return</span> <span class="hljs-string">"你好,我的名字叫"</span>+<span class="hljs-keyword">data</span>.name+<span class="hljs-string">", 今年已经 "</span>+<span class="hljs-keyword">data</span>.info.age+<span class="hljs-string">"岁了"</span></code></pre>
<p>最后，我们修改一下后面两行，得到我们梦魅以求的渲染函数，它的实现过程比format方法复杂多了，但却是所有扩展性极强的前端模板的一般实现过程。</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="  function render(str){
  //略。。。
     return new Function(&quot;data&quot;, &quot;return &quot; + ret.join('+'))
  }
  var fn = render(tpl)
  console.log(fn+&quot;&quot;)
  console.log(fn(data))" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">str</span>)</span>{
  <span class="hljs-comment">//略。。。</span>
     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">"data"</span>, <span class="hljs-string">"return "</span> + ret.join(<span class="hljs-string">'+'</span>))
  }
  <span class="hljs-keyword">var</span> fn = render(tpl)
  <span class="hljs-built_in">console</span>.log(fn+<span class="hljs-string">""</span>)
  <span class="hljs-built_in">console</span>.log(fn(data))</code></pre>
<p><span class="img-wrap"><img data-src="/img/bVDuzp?w=510&amp;h=87" src="https://static.alili.tech/img/bVDuzp?w=510&amp;h=87" alt="clipboard.png" title="clipboard.png" style="cursor: pointer;"></span></p>
<p>我们再看一下如何引入循环语句，比如将上面的模板与数据改成这样</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="var tpl = '你好,我的名字叫<%name%>, 今年已经 <%info.age%>岁了,喜欢<% for(var i = 0, el; el = list[i++];){%><% el %> <% } %>'
 var data = {
     name: &quot;司徒正美&quot;,
     info: {
         age: 20
     },
     list: [&quot;苹果&quot;,&quot;香蕉&quot;,&quot;雪梨&quot;]
 }" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript"><span class="hljs-keyword">var</span> tpl = <span class="hljs-string">'你好,我的名字叫&lt;%name%&gt;, 今年已经 &lt;%info.age%&gt;岁了,喜欢&lt;% for(var i = 0, el; el = list[i++];){%&gt;&lt;% el %&gt; &lt;% } %&gt;'</span>
 <span class="hljs-keyword">var</span> data = {
     <span class="hljs-attr">name</span>: <span class="hljs-string">"司徒正美"</span>,
     <span class="hljs-attr">info</span>: {
         <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>
     },
     <span class="hljs-attr">list</span>: [<span class="hljs-string">"苹果"</span>,<span class="hljs-string">"香蕉"</span>,<span class="hljs-string">"雪梨"</span>]
 }</code></pre>
<p>这时我们就添加一种新的类型，不输出到页面的动态内容。这在token方法中做一些修改</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="value = value.trim()
if (/^(if|for|})/.test(value)) {
    ret.push({
        expr: value,
        type: 'logic'
    })
} else {
    ret.push({
        expr: value,
        type: 'js'
    })
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript">value = value.trim()
<span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^(if|for|})/</span>.test(value)) {
    ret.push({
        <span class="hljs-attr">expr</span>: value,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'logic'</span>
    })
} <span class="hljs-keyword">else</span> {
    ret.push({
        <span class="hljs-attr">expr</span>: value,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'js'</span>
    })
}</code></pre>
<p>但render方法怎么修改好呢，显示这时继续用<code>＋</code>已经不行了，否则下场是这样</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="return &quot;你好,我的名字叫&quot;+data.name+&quot;, 今年已经 &quot;+data.info.age+&quot;岁了,喜欢&quot;+for(var i = 0, el; el = list[i++];){+&quot;&quot;+data.el+&quot; &quot;+}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript" style="word-break: break-word; white-space: initial;"><span class="hljs-keyword">return</span> <span class="hljs-string">"你好,我的名字叫"</span>+data.name+<span class="hljs-string">", 今年已经 "</span>+data.info.age+<span class="hljs-string">"岁了,喜欢"</span>+<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, el; el = list[i++];){+<span class="hljs-string">""</span>+data.el+<span class="hljs-string">" "</span>+}</code></pre>
<p>这时， 我们需要借用数组，将要输入的数据（text, js类型 ）放进去，logic类型不放进去。</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function addPrefix(str) {
   // 先去掉对象的子级属性,减少干扰因素
   var js = str.replace(rproperty, dig)
   js = js.replace(rident, function (a) {
       return 'data.' + a
   })
   return js.replace(rfill, fill)
}
function addView(s) {
   return '__data__.push(' + s + ')'
}
function render(str) {
    stringPool = {}
    var tokens = tokenize(str)
    var ret = ['var __data__ = []']
    tokens.forEach(function(token){
       if (token.type === 'text') {
           ret.push(addView(quote(token.expr)))
       } else if (token.type === 'logic') {
           //逻辑部分都经过addPrefix方法处理
           ret.push(addPrefix(token.expr))
       } else {
           ret.push(addView(addPrefix(token.expr)))
       }
    })
    ret.push(&quot;return __data__.join('')&quot;)
    console.log( ret.join('\n'))
  }
var fn = render(tpl)" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addPrefix</span>(<span class="hljs-params">str</span>) </span>{
   <span class="hljs-comment">// 先去掉对象的子级属性,减少干扰因素</span>
   <span class="hljs-keyword">var</span> js = str.replace(rproperty, dig)
   js = js.replace(rident, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a</span>) </span>{
       <span class="hljs-keyword">return</span> <span class="hljs-string">'data.'</span> + a
   })
   <span class="hljs-keyword">return</span> js.replace(rfill, fill)
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addView</span>(<span class="hljs-params">s</span>) </span>{
   <span class="hljs-keyword">return</span> <span class="hljs-string">'__data__.push('</span> + s + <span class="hljs-string">')'</span>
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">str</span>) </span>{
    stringPool = {}
    <span class="hljs-keyword">var</span> tokens = tokenize(str)
    <span class="hljs-keyword">var</span> ret = [<span class="hljs-string">'var __data__ = []'</span>]
    tokens.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">token</span>)</span>{
       <span class="hljs-keyword">if</span> (token.type === <span class="hljs-string">'text'</span>) {
           ret.push(addView(quote(token.expr)))
       } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token.type === <span class="hljs-string">'logic'</span>) {
           <span class="hljs-comment">//逻辑部分都经过addPrefix方法处理</span>
           ret.push(addPrefix(token.expr))
       } <span class="hljs-keyword">else</span> {
           ret.push(addView(addPrefix(token.expr)))
       }
    })
    ret.push(<span class="hljs-string">"return __data__.join('')"</span>)
    <span class="hljs-built_in">console</span>.log( ret.join(<span class="hljs-string">'\n'</span>))
  }
<span class="hljs-keyword">var</span> fn = render(tpl)</code></pre>
<p>得到的内部结构是这样的，显然addPrefix方法出问题，我们应该过滤掉if, for等关键字与保留字。</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="var __data__ = []
__data__.push(&quot;你好,我的名字叫&quot;)
__data__.push(data.name)
__data__.push(&quot;, 今年已经 &quot;)
__data__.push(data.info.age)
__data__.push(&quot;岁了,喜欢&quot;)
data.for(data.var data.i = 0, data.el; data.el = data.list[data.i++]){
__data__.push(&quot;&quot;)
__data__.push(data.el)
__data__.push(&quot; &quot;)
}
return __data__.join('')" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript"><span class="hljs-keyword">var</span> __data__ = []
__data__.push(<span class="hljs-string">"你好,我的名字叫"</span>)
__data__.push(data.name)
__data__.push(<span class="hljs-string">", 今年已经 "</span>)
__data__.push(data.info.age)
__data__.push(<span class="hljs-string">"岁了,喜欢"</span>)
data.for(data.var data.i = <span class="hljs-number">0</span>, data.el; data.el = data.list[data.i++]){
__data__.push(<span class="hljs-string">""</span>)
__data__.push(data.el)
__data__.push(<span class="hljs-string">" "</span>)
}
<span class="hljs-keyword">return</span> __data__.join(<span class="hljs-string">''</span>)</code></pre>
<p>但即使我们处理掉关键字与保留字，对于中间生成i, el怎么区分呢？是区分不了。于是目前有两种方法，一是使用with， 这时我们就不需要加<code>data.</code>前缀。第二种引入新的语法。比如，前面是<code>@</code>就替换为<code>data.</code>。</p>
<p>先看第一种：</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function render(str) {
     stringPool = {}
     var tokens = tokenize(str)
     var ret = ['var __data__ = [];', 'with(data){']
     for (var i = 0, token; token = tokens[i++]; ) {
         if (token.type === 'text') {
             ret.push(addView(quote(token.expr)))
         } else if (token.type === 'logic') {
             ret.push(token.expr)
         } else {
             ret.push(addView(token.expr))
         }
     }
     ret.push('}')
     ret.push('return __data__.join(&quot;&quot;)')
     return new Function(&quot;data&quot;, ret.join('\n'))
 }
 var fn = render(tpl)
 console.log(fn + &quot;&quot;)
 console.log(fn(data))" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">str</span>) </span>{
     stringPool = {}
     <span class="hljs-keyword">var</span> tokens = tokenize(str)
     <span class="hljs-keyword">var</span> ret = [<span class="hljs-string">'var __data__ = [];'</span>, <span class="hljs-string">'with(data){'</span>]
     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, token; token = tokens[i++]; ) {
         <span class="hljs-keyword">if</span> (token.type === <span class="hljs-string">'text'</span>) {
             ret.push(addView(quote(token.expr)))
         } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token.type === <span class="hljs-string">'logic'</span>) {
             ret.push(token.expr)
         } <span class="hljs-keyword">else</span> {
             ret.push(addView(token.expr))
         }
     }
     ret.push(<span class="hljs-string">'}'</span>)
     ret.push(<span class="hljs-string">'return __data__.join("")'</span>)
     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">"data"</span>, ret.join(<span class="hljs-string">'\n'</span>))
 }
 <span class="hljs-keyword">var</span> fn = render(tpl)
 <span class="hljs-built_in">console</span>.log(fn + <span class="hljs-string">""</span>)
 <span class="hljs-built_in">console</span>.log(fn(data))</code></pre>
<p><span class="img-wrap"><img data-src="/img/bVDuH7?w=390&amp;h=265" src="https://static.alili.tech/img/bVDuH7?w=390&amp;h=265" alt="clipboard.png" title="clipboard.png" style="cursor: pointer;"></span></p>
<p>许多迷你模板都是用with减少替换工作。</p>
<p>第二种方法，使用引导符<code>@</code>, avalon2就是这么玩。这样addPrefix方法可以减少许多代码。相对应，模板也要改动一下</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text=" var tpl = '你好,我的名字叫<%@name%>, 今年已经 <%@info.age%>岁了,喜欢<% for(var i = 0, el; el = @list[i++];){%><% el %> <% } %>'
 var rguide = /(^|[^\w\u00c0-\uFFFF_])(@|##)(?=[$\w])/g
 function addPrefix(str) {
     return str.replace(rguide, '$1data.')
 }
 function render(str) {
     stringPool = {}
     var tokens = tokenize(str)
     var ret = ['var __data__ = [];']
     for (var i = 0, token; token = tokens[i++]; ) {
         if (token.type === 'text') {
             ret.push(addView(quote(token.expr)))
         } else if (token.type === 'logic') {
             //逻辑部分都经过addPrefix方法处理
             ret.push(addPrefix(token.expr))
         } else {
             ret.push(addView(addPrefix(token.expr)))
         }
     }
    
     ret.push('return __data__.join(&quot;&quot;)')
     return new Function(&quot;data&quot;, ret.join('\n'))
 }
 var fn = render(tpl)
 console.log(fn + &quot;&quot;)
 console.log(fn(data))" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript"> <span class="hljs-keyword">var</span> tpl = <span class="hljs-string">'你好,我的名字叫&lt;%@name%&gt;, 今年已经 &lt;%@info.age%&gt;岁了,喜欢&lt;% for(var i = 0, el; el = @list[i++];){%&gt;&lt;% el %&gt; &lt;% } %&gt;'</span>
 <span class="hljs-keyword">var</span> rguide = <span class="hljs-regexp">/(^|[^\w\u00c0-\uFFFF_])(@|##)(?=[$\w])/g</span>
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addPrefix</span>(<span class="hljs-params">str</span>) </span>{
     <span class="hljs-keyword">return</span> str.replace(rguide, <span class="hljs-string">'$1data.'</span>)
 }
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">str</span>) </span>{
     stringPool = {}
     <span class="hljs-keyword">var</span> tokens = tokenize(str)
     <span class="hljs-keyword">var</span> ret = [<span class="hljs-string">'var __data__ = [];'</span>]
     <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, token; token = tokens[i++]; ) {
         <span class="hljs-keyword">if</span> (token.type === <span class="hljs-string">'text'</span>) {
             ret.push(addView(quote(token.expr)))
         } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (token.type === <span class="hljs-string">'logic'</span>) {
             <span class="hljs-comment">//逻辑部分都经过addPrefix方法处理</span>
             ret.push(addPrefix(token.expr))
         } <span class="hljs-keyword">else</span> {
             ret.push(addView(addPrefix(token.expr)))
         }
     }
    
     ret.push(<span class="hljs-string">'return __data__.join("")'</span>)
     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">"data"</span>, ret.join(<span class="hljs-string">'\n'</span>))
 }
 <span class="hljs-keyword">var</span> fn = render(tpl)
 <span class="hljs-built_in">console</span>.log(fn + <span class="hljs-string">""</span>)
 <span class="hljs-built_in">console</span>.log(fn(data))</code></pre>
<p><span class="img-wrap"><img data-src="/img/bVDuzx?w=398&amp;h=237" src="https://static.alili.tech/img/bVDuzx?w=398&amp;h=237" alt="clipboard.png" title="clipboard.png" style="cursor: pointer; display: inline;"></span></p>
<p>第二种比第一种的优势在于，性能更高，并且避开es5严格模式的限制。</p>
<p>我们再认真思考一下，其实循环语句与条件语句，不单是for, if两个，还有while, do while, else什么。因此这需要优化。这也有两种方法，添加更多语法符合，比如上面所说的<code>=</code>就是输出，没有则不输出。这是ASP/JSP/PHP等模板采用的手段：</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="//tokenize方法
if (value.charAt(0) === '=') {
     ret.push({
         expr: value, 
         type: 'js'
     })
 } else {
     ret.push({
         expr: value, 
         type: 'logic'
     })
 }" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript"><span class="hljs-comment">//tokenize方法</span>
<span class="hljs-keyword">if</span> (value.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">'='</span>) {
     ret.push({
         <span class="hljs-attr">expr</span>: value, 
         <span class="hljs-attr">type</span>: <span class="hljs-string">'js'</span>
     })
 } <span class="hljs-keyword">else</span> {
     ret.push({
         <span class="hljs-attr">expr</span>: value, 
         <span class="hljs-attr">type</span>: <span class="hljs-string">'logic'</span>
     })
 }</code></pre>
<p>另一种，使用语法糖，如<code>#each (el, index) in @list </code>, '#eachEnd', '#if ','#ifEnd'。还是改动tokenize方法</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text=" if (value.charAt(0) === '#') {
    if (value === '#eachEnd' || value === '#ifEnd') {
        ret.push({
            expr: '}',
            type: 'logic'
        })
    } else if (value.slice(0, 4) === '#if ') {
        ret.push({
            expr: 'if(' + value.slice(4) + '){',
            type: 'logic'
        })
    } else if (value.slice(0, 6) === '#each ') {
        var arr = value.slice(6).split(' in ')
        var arrayName = arr[1]
        var args = arr[0].match(/[$\w_]+/g)
        var itemName = args.pop()
        var indexName = args.pop() || '$index'
        value = ['for(var ', ' = 0;', '<' + arrayName + '.length;', '++){'].join(indexName) +
                '\nvar ' + itemName + ' = ' + arrayName + '[' + indexName + '];'
        ret.push({
            expr: value,
            type: 'logic'
        })
    
    }
    
} else{
   //...
}
" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs cs"><code> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">value</span>.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">'#'</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">value</span> === <span class="hljs-string">'#eachEnd'</span> || <span class="hljs-keyword">value</span> === <span class="hljs-string">'#ifEnd'</span>) {
        ret.push({
            expr: <span class="hljs-string">'}'</span>,
            type: <span class="hljs-string">'logic'</span>
        })
    } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> (<span class="hljs-params"><span class="hljs-keyword">value</span>.slice(<span class="hljs-number">0</span>, <span class="hljs-number">4</span></span>) </span>=== <span class="hljs-string">'#if '</span>) {
        ret.push({
            expr: <span class="hljs-string">'if('</span> + <span class="hljs-keyword">value</span>.slice(<span class="hljs-number">4</span>) + <span class="hljs-string">'){'</span>,
            type: <span class="hljs-string">'logic'</span>
        })
    } <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> (<span class="hljs-params"><span class="hljs-keyword">value</span>.slice(<span class="hljs-number">0</span>, <span class="hljs-number">6</span></span>) </span>=== <span class="hljs-string">'#each '</span>) {
        <span class="hljs-keyword">var</span> arr = <span class="hljs-keyword">value</span>.slice(<span class="hljs-number">6</span>).split(<span class="hljs-string">' in '</span>)
        <span class="hljs-keyword">var</span> arrayName = arr[<span class="hljs-number">1</span>]
        <span class="hljs-keyword">var</span> args = arr[<span class="hljs-number">0</span>].match(/[$\w_]+/g)
        <span class="hljs-keyword">var</span> itemName = args.pop()
        <span class="hljs-keyword">var</span> indexName = args.pop() || <span class="hljs-string">'$index'</span>
        <span class="hljs-keyword">value</span> = [<span class="hljs-string">'for(var '</span>, <span class="hljs-string">' = 0;'</span>, <span class="hljs-string">'&lt;'</span> + arrayName + <span class="hljs-string">'.length;'</span>, <span class="hljs-string">'++){'</span>].<span class="hljs-keyword">join</span>(indexName) +
                <span class="hljs-string">'\nvar '</span> + itemName + <span class="hljs-string">' = '</span> + arrayName + <span class="hljs-string">'['</span> + indexName + <span class="hljs-string">'];'</span>
        ret.push({
            expr: <span class="hljs-keyword">value</span>,
            type: <span class="hljs-string">'logic'</span>
        })
    
    }
    
} <span class="hljs-keyword">else</span>{
   <span class="hljs-comment">//...</span>
}
</code></pre>
<p>对应的模板改成</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="var tpl = '你好,我的名字叫<%@name%>, 今年已经 <%@info.age%>岁了,喜欢<%#each el in @list %><% el %> <% #eachEnd %>'
var fn = render(tpl)
console.log(fn + &quot;&quot;)
console.log(fn(data))" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="javascript hljs"><code class="javascript"><span class="hljs-keyword">var</span> tpl = <span class="hljs-string">'你好,我的名字叫&lt;%@name%&gt;, 今年已经 &lt;%@info.age%&gt;岁了,喜欢&lt;%#each el in @list %&gt;&lt;% el %&gt; &lt;% #eachEnd %&gt;'</span>
<span class="hljs-keyword">var</span> fn = render(tpl)
<span class="hljs-built_in">console</span>.log(fn + <span class="hljs-string">""</span>)
<span class="hljs-built_in">console</span>.log(fn(data))</code></pre>
<p><span class="img-wrap"><img data-src="/img/bVDuAk?w=463&amp;h=248" src="https://static.alili.tech/img/bVDuAk?w=463&amp;h=248" alt="clipboard.png" title="clipboard.png" style="cursor: pointer;"></span></p>
<p>可能有人觉#for, #forEnd这样的语法糖比较丑，无问题，这个可以改，主要我们的tokenize方法足够强大，就能实现mustache这样的模板引擎。但所有模板引擎也基本上是这么实现的，有的还支持过滤器，也就是在js 类型的语句再进行处理，将｜后面的字符器再切割出来。</p>
<p>如果虚拟DOM呢？那就需要一个html parser，这个工程巨大，比如reactive这个库，早期不使用html parser与虚拟DOM，只有3，4千行，加入这些炫酷功能后就达到1W6K行。返回一个字符串与返回一个类似DOM树的对象树结构是不一样。</p>

                
{{< /raw >}}

# 版权声明
本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，

本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。

原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！

## 原文标题
前端模板的原理与实现

## 原文链接
[https://segmentfault.com/a/1190000006990480](https://segmentfault.com/a/1190000006990480)

