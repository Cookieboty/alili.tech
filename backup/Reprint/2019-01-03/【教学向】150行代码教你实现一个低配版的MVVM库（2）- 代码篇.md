---
title: '【教学向】150行代码教你实现一个低配版的MVVM库（2）- 代码篇' 
date: 2019-01-03 2:30:11
hidden: true
slug: btchnsqfmua
categories: [reprint]
---

{{< raw >}}

                    
<p>书接上一篇： <a href="https://segmentfault.com/a/1190000010744960">150行代码教你实现一个低配版的MVVM库（1）- 原理篇</a></p>
<h2 id="articleHeader0">写在前面</h2>
<p>为了便于分模块，和阅读，我使用了Typescript来进行coding，总行数是正好150行，最早写DEMO的时候用了ES2015，代码行数应该在100行出头，如果你不会搭ts+webpack的编译UMD环境，你也可以把本文中的ts语法人肉转成es6或者es2015，我相信这对你（一个有志于学写mvvm库的青年）来说没有什么难度。</p>
<p>作为作者呢，虽然最后我会放出源码的地址，你可以去github上扫一眼代码，但我还是希望你们可以跟我一起，打开个文本编辑器，一个模块一个模块把代码人肉敲出来，这样的感觉是不一样的，就好比是你可能之前就阅读过angular，vue的源码，但你现在还不是在读我的文章么？</p>
<h3 id="articleHeader1">第一步 先把骨架搭好, 血肉晚点再填充</h3>
<p>还是再上一遍设计图<br><span class="img-wrap"><img data-src="/img/bVTeUK?w=2306&amp;h=1478" src="https://static.alili.tech/img/bVTeUK?w=2306&amp;h=1478" alt="图片描述" title="图片描述" style="cursor: pointer; display: inline;"></span><br>设计的类不多，一共就5个</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="//SegmentFault.ts
export let SegmentFault = class SegmentFault {
    private viewModelPool = {};   //用来维护viewModel的别名alias与viewModel之间的关系
    private viewViewModelMap = {};//用来维护viewModel和被绑定的view之间的关系
    public registerViewModel(alias:string, vm:object) {};//在sf正式运作之前我们先要注册一个下viewModel并给他起一个别名
    public init() {};  //sf库开始运作的入口函数
    
    public refresh(alias:string){}; // 暴露一个强制刷新整个viewModel的方法，因为毕竟有你监控不到的角落
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs cs"><code><span class="hljs-comment">//SegmentFault.ts</span>
export <span class="hljs-keyword">let</span> SegmentFault = <span class="hljs-keyword">class</span> <span class="hljs-title">SegmentFault</span> {
    <span class="hljs-keyword">private</span> viewModelPool = {};   <span class="hljs-comment">//用来维护viewModel的别名alias与viewModel之间的关系</span>
    <span class="hljs-keyword">private</span> viewViewModelMap = {};<span class="hljs-comment">//用来维护viewModel和被绑定的view之间的关系</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">registerViewModel</span>(<span class="hljs-params"><span class="hljs-keyword">alias</span>:<span class="hljs-keyword">string</span>, vm:<span class="hljs-keyword">object</span></span>) </span>{};<span class="hljs-comment">//在sf正式运作之前我们先要注册一个下viewModel并给他起一个别名</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{};  <span class="hljs-comment">//sf库开始运作的入口函数</span>
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">refresh</span>(<span class="hljs-params"><span class="hljs-keyword">alias</span>:<span class="hljs-keyword">string</span></span>)</span>{}; <span class="hljs-comment">// 暴露一个强制刷新整个viewModel的方法，因为毕竟有你监控不到的角落</span>
}</code></pre>
<p>SegmentFault是对用户暴露的唯一的对象，就像Angular他会暴露一个angular对象给用户使用一样。<br>最终，用户会这样来操作SF以达到双向绑定的目的<br>不妨再看看使用效果</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="<script src=&quot;dist/sf.js&quot;></script> <!-- 这里引入我们的sf.js库-->
<script>
    var sf = new SegmentFault();   //生成一个sf的实例
    sf.registerViewModel(&quot;vm&quot;, new ViewModel());  //注册一个viewModel，起一个叫vm的别名
    sf.init();  //调用init方法，开始初始化，sf正式开始一些列工作

    //以下是viewModel的定义
    function ViewModel() {
        this.message = &quot;hello, SegmentFault&quot;;
        this.buttonClickHandler = function() {
            this.message = &quot;clicked: &quot; + this.message;
        }
    }
</script>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs xml"><code><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"dist/sf.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span> <span class="hljs-comment">&lt;!-- 这里引入我们的sf.js库--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
    <span class="hljs-keyword">var</span> sf = <span class="hljs-keyword">new</span> SegmentFault();   <span class="hljs-comment">//生成一个sf的实例</span>
    sf.registerViewModel(<span class="hljs-string">"vm"</span>, <span class="hljs-keyword">new</span> ViewModel());  <span class="hljs-comment">//注册一个viewModel，起一个叫vm的别名</span>
    sf.init();  <span class="hljs-comment">//调用init方法，开始初始化，sf正式开始一些列工作</span>

    <span class="hljs-comment">//以下是viewModel的定义</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ViewModel</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.message = <span class="hljs-string">"hello, SegmentFault"</span>;
        <span class="hljs-keyword">this</span>.buttonClickHandler = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">this</span>.message = <span class="hljs-string">"clicked: "</span> + <span class="hljs-keyword">this</span>.message;
        }
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></code></pre>
<p>有没有觉得SF的API干净利落，清新爽洁！</p>
<p>根据设计图的Step 1，先给已注册的viewModel加上监视，这里我们需要一个Watcher类</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="export class Watcher {
    private sf;
    
    //构造函数里传入一个sf的对象，便于callback调用时的作用域确定。。。这是后话
    constructor(sf) {
        this.sf = sf;
    }
    public observe(viewModel, callback) {} //暗中观察
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs typescript"><code><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> Watcher {
    <span class="hljs-keyword">private</span> sf;
    
    <span class="hljs-comment">//构造函数里传入一个sf的对象，便于callback调用时的作用域确定。。。这是后话</span>
    <span class="hljs-keyword">constructor</span>(<span class="hljs-params">sf</span>) {
        <span class="hljs-keyword">this</span>.sf = sf;
    }
    <span class="hljs-keyword">public</span> observe(viewModel, callback) {} <span class="hljs-comment">//暗中观察</span>
}</code></pre>
<p>再来看一下Step 2, 另一个主要的类<strong>Scanner</strong>，Scanner是干什么的呢？作用就一个遍历整个DOM Tree把出现sf-xxxx这个attribute的Elements全部挑出来，然后找sf-xxxx = expression，等号右边这个表达式里如果出现了viewModel的alias，那就说么这个element是跟viewModel搭界了，是绑定在一起了，scanner负责把这对"恋人"关系用一个数据结构维护一下，等全部扫描完了一起返回给SegmentFault去听候发落。<br><span class="img-wrap"><img data-src="/img/bVTg9i?w=1604&amp;h=1108" src="https://static.alili.tech/img/bVTg9i?w=1604&amp;h=1108" alt="图片描述" title="图片描述" style="cursor: pointer; display: inline;"></span></p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="//Scanner.ts
export class Scanner {

    private prefix = &quot;sf-&quot;; //库的前缀
    private viewModelPool;
    
    constructor(viewModelPool) {
        this.viewModelPool = viewModelPool; //Scanner肯定是为SegmentFault服务的，所以初始化的时候SegmentFault会把之前注册过的viewModel信息传给Scanner，便于它去扫描。
    }
    
    public scanBindDOM():object {} //找出attribute里带sf-，且等号右边表达式里含有viewModel的alias的Element，并返回一个view与viewModel的map

}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs kotlin"><code><span class="hljs-comment">//Scanner.ts</span>
export <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Scanner</span> </span>{

    <span class="hljs-keyword">private</span> prefix = <span class="hljs-string">"sf-"</span>; <span class="hljs-comment">//库的前缀</span>
    <span class="hljs-keyword">private</span> viewModelPool;
    
    <span class="hljs-keyword">constructor</span>(viewModelPool) {
        <span class="hljs-keyword">this</span>.viewModelPool = viewModelPool; <span class="hljs-comment">//Scanner肯定是为SegmentFault服务的，所以初始化的时候SegmentFault会把之前注册过的viewModel信息传给Scanner，便于它去扫描。</span>
    }
    
    <span class="hljs-keyword">public</span> scanBindDOM():<span class="hljs-keyword">object</span> {} <span class="hljs-comment">//找出attribute里带sf-，且等号右边表达式里含有viewModel的alias的Element，并返回一个view与viewModel的map</span>

}</code></pre>
<p>接下去，SegmentFault会获得Scanner.scanBindDOM()所返回的view_viewModel Map,来看看这个Map的具体数据结构</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="//template
{
    &quot;vm_alias&quot;:[
        {
            &quot;viewModel&quot;:viewModel,
            &quot;element&quot;:element,
            &quot;expression&quot;:expression,
            &quot;attributeName&quot;:attributeName
        }
    ]
}
//如果实际中的DOM Tree是这样的，
<body>
    <p sf-text=&quot;userVM.username&quot;></p>
    <input type=&quot;text&quot; sf-value=&quot;userVM.username&quot;>
</body>
//那么，Scanner扫描到的结果应该是
{
    &quot;userVM&quot;:[
        {
            &quot;viewModel&quot;: userViewModel,
            &quot;element&quot;: <p/>,
            &quot;expression&quot;: &quot;vm.username&quot;,
            &quot;attributeName&quot;: &quot;sf-text&quot;
        },
        {
            &quot;viewModel&quot;: userViewModel,
            &quot;element&quot;: <input>,
            &quot;expression&quot;: &quot;vm.username&quot;,
            &quot;attributeName&quot;: &quot;sf-value&quot;
        }
    ]
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs dts"><code><span class="hljs-comment">//template</span>
{
    <span class="hljs-string">"vm_alias"</span>:[
        {
            <span class="hljs-string">"viewModel"</span>:viewModel,
            <span class="hljs-string">"element"</span>:element,
            <span class="hljs-string">"expression"</span>:expression,
            <span class="hljs-string">"attributeName"</span>:attributeName
        }
    ]
}
<span class="hljs-comment">//如果实际中的DOM Tree是这样的，</span>
<span class="hljs-params">&lt;body&gt;</span>
    <span class="hljs-params">&lt;p sf-text="userVM.username"&gt;</span><span class="hljs-params">&lt;/p&gt;</span>
    <span class="hljs-params">&lt;input type="text" sf-value="userVM.username"&gt;</span>
<span class="hljs-params">&lt;/body&gt;</span>
<span class="hljs-comment">//那么，Scanner扫描到的结果应该是</span>
{
    <span class="hljs-string">"userVM"</span>:[
        {
            <span class="hljs-string">"viewModel"</span>: userViewModel,
            <span class="hljs-string">"element"</span>: <span class="hljs-params">&lt;p/&gt;</span>,
            <span class="hljs-string">"expression"</span>: <span class="hljs-string">"vm.username"</span>,
            <span class="hljs-string">"attributeName"</span>: <span class="hljs-string">"sf-text"</span>
        },
        {
            <span class="hljs-string">"viewModel"</span>: userViewModel,
            <span class="hljs-string">"element"</span>: <span class="hljs-params">&lt;input&gt;</span>,
            <span class="hljs-string">"expression"</span>: <span class="hljs-string">"vm.username"</span>,
            <span class="hljs-string">"attributeName"</span>: <span class="hljs-string">"sf-value"</span>
        }
    ]
}</code></pre>
<p>我的实现中特地定一个了一个BoundItem类来描述 {"viewModel":viewModel,"element":element,"expression":expression,"attributeName":attributeName}</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="//BoundItem.ts
export class BoundItem {
    public viewModel: object;
    public element: Element;
    public expression: string;
    public attributeName: string;
 
    constructor(viewModel: object, element: Element, expression: string, attributeName: string) {
        this.viewModel = viewModel;
        this.element = element;
        this.expression = expression;
        this.attributeName = attributeName;
    } 
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs groovy"><code><span class="hljs-comment">//BoundItem.ts</span>
export <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BoundItem</span> {</span>
    <span class="hljs-keyword">public</span> <span class="hljs-string">viewModel:</span> object;
    <span class="hljs-keyword">public</span> <span class="hljs-string">element:</span> Element;
    <span class="hljs-keyword">public</span> <span class="hljs-string">expression:</span> string;
    <span class="hljs-keyword">public</span> <span class="hljs-string">attributeName:</span> string;
 
    constructor(<span class="hljs-string">viewModel:</span> object, <span class="hljs-string">element:</span> Element, <span class="hljs-string">expression:</span> string, <span class="hljs-string">attributeName:</span> string) {
        <span class="hljs-keyword">this</span>.viewModel = viewModel;
        <span class="hljs-keyword">this</span>.element = element;
        <span class="hljs-keyword">this</span>.expression = expression;
        <span class="hljs-keyword">this</span>.attributeName = attributeName;
    } 
}</code></pre>
<p>拿到view_viewModel map后，SegmentFault会调用<strong>Renderer</strong>去挨个渲染每一个BoundItem。<br><span class="img-wrap"><img data-src="/img/bVTg9Q?w=1508&amp;h=914" src="https://static.alili.tech/img/bVTg9Q?w=1508&amp;h=914" alt="图片描述" title="图片描述" style="cursor: pointer; display: inline;"></span></p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="export class Renderer{
    public render(boundItem:BoundItem) {};
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs cpp"><code><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> Renderer{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">render</span><span class="hljs-params">(boundItem:BoundItem)</span> </span>{};
}</code></pre>
<p>好至此，几个主要的类都一一登场了，接下去我们完善下SegmentFault类，让ta和其它几个类联动起来</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="import {Scanner} from &quot;./Scanner&quot;;
import {Watcher} from &quot;./Watcher&quot;;
import {Renderer} from &quot;./Renderer&quot;;
export let SegmentFault = class SegmentFault {
    private viewModelPool = {};
    private viewViewModelMap = {};
    private renderer = new Renderer();
    public init() {
        let scanner = new Scanner(this.viewModelPool);
        let watcher = new Watcher(this);
        //step 1, 暗中观察各个viewModel
        for (let key in this.viewModelPool) {
            watcher.observe(this.viewModelPool[key],this.viewModelChangedHandler);
        }
        /step 2 3, 扫描DOM Tree并返回Map 
        this.viewViewModelMap = scanner.scanBindDOM();
        //step 4, 渲染DOM
        Object.keys(this.viewViewModelMap).forEach(alias=>{
            this.refresh(alias);
        });   
    };
    public registerViewModel(alias:string, viewModel:object) {
        viewModel[&quot;_alias&quot;] = alias;
        window[alias] = this.viewModelPool[alias] = viewModel;
    };
    public refresh(alias:string){
        let boundItems = this.viewViewModelMap[alias];
        boundItems.forEach(boundItem => {
            this.renderer.render(boundItem);
        });
    }
    private viewModelChangedHandler(viewModel,prop) {
        this.refresh(viewModel._alias);
    }
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs cs"><code>import {Scanner} <span class="hljs-keyword">from</span> <span class="hljs-string">"./Scanner"</span>;
import {Watcher} <span class="hljs-keyword">from</span> <span class="hljs-string">"./Watcher"</span>;
import {Renderer} <span class="hljs-keyword">from</span> <span class="hljs-string">"./Renderer"</span>;
export <span class="hljs-keyword">let</span> SegmentFault = <span class="hljs-keyword">class</span> <span class="hljs-title">SegmentFault</span> {
    <span class="hljs-keyword">private</span> viewModelPool = {};
    <span class="hljs-keyword">private</span> viewViewModelMap = {};
    <span class="hljs-keyword">private</span> renderer = <span class="hljs-keyword">new</span> Renderer();
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">let</span> scanner = <span class="hljs-keyword">new</span> Scanner(<span class="hljs-keyword">this</span>.viewModelPool);
        <span class="hljs-keyword">let</span> watcher = <span class="hljs-keyword">new</span> Watcher(<span class="hljs-keyword">this</span>);
        <span class="hljs-comment">//step 1, 暗中观察各个viewModel</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.viewModelPool) {
            watcher.observe(<span class="hljs-keyword">this</span>.viewModelPool[key],<span class="hljs-keyword">this</span>.viewModelChangedHandler);
        }
        /step <span class="hljs-number">2</span> <span class="hljs-number">3</span>, 扫描DOM Tree并返回Map 
        <span class="hljs-keyword">this</span>.viewViewModelMap = scanner.scanBindDOM();
        <span class="hljs-comment">//step 4, 渲染DOM</span>
        Object.keys(<span class="hljs-keyword">this</span>.viewViewModelMap).forEach(<span class="hljs-keyword">alias</span>=&gt;{
            <span class="hljs-keyword">this</span>.refresh(<span class="hljs-keyword">alias</span>);
        });   
    };
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">registerViewModel</span>(<span class="hljs-params"><span class="hljs-keyword">alias</span>:<span class="hljs-keyword">string</span>, viewModel:<span class="hljs-keyword">object</span></span>) </span>{
        viewModel[<span class="hljs-string">"_alias"</span>] = <span class="hljs-keyword">alias</span>;
        window[<span class="hljs-keyword">alias</span>] = <span class="hljs-keyword">this</span>.viewModelPool[<span class="hljs-keyword">alias</span>] = viewModel;
    };
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">refresh</span>(<span class="hljs-params"><span class="hljs-keyword">alias</span>:<span class="hljs-keyword">string</span></span>)</span>{
        <span class="hljs-keyword">let</span> boundItems = <span class="hljs-keyword">this</span>.viewViewModelMap[<span class="hljs-keyword">alias</span>];
        boundItems.forEach(boundItem =&gt; {
            <span class="hljs-keyword">this</span>.renderer.render(boundItem);
        });
    }
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">viewModelChangedHandler</span>(<span class="hljs-params">viewModel,prop</span>) </span>{
        <span class="hljs-keyword">this</span>.refresh(viewModel._alias);
    }
}</code></pre>
<p><strong>好，写到这里，骨架全部构建完成，你有没有兴趣自己花点时间去填充血肉呢?</strong><br>我希望你能做到</p>
<p>这里贴出其它几个类的具体实现，仅供参考，你一定可以写得比我更好。</p>
<p>也放出github地址，上面有完整工程<br><a href="https://github.com/momoko8443/how_to_write_a_mvvm_library" rel="nofollow noreferrer" target="_blank"></a><a href="https://github.com/momoko8443/how_to_write_a_mvvm_library" rel="nofollow noreferrer" target="_blank">https://github.com/momoko8443...</a></p>
<p>以及在线演示地址<br><a href="https://momoko8443.github.io/how_to_write_a_mvvm_library/index.html" rel="nofollow noreferrer" target="_blank"></a><a href="https://momoko8443.github.io/how_to_write_a_mvvm_library/index.html" rel="nofollow noreferrer" target="_blank">https://momoko8443.github.io/...</a></p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="//Watcher.ts
export class Watcher {
    private sf;
    constructor(sf) {
        this.sf = sf;
    }
    public observe(viewModel, callback) {
        let host = this.sf;
        for (var key in viewModel) {
            var defaultValue = viewModel[key];
            (function (k, dv) {
                if (k !== &quot;_alias&quot;) {
                    Object.defineProperty(viewModel, k, {
                        get: function () {
                            return dv;
                        },
                        set: function (value) {
                            dv = value;
                            console.log(&quot;do something after set a new value&quot;);
                            callback.call(host, viewModel, k);
                        }
                    });
                }
            })(key, defaultValue);
        }
    }
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs typescript"><code><span class="hljs-comment">//Watcher.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> Watcher {
    <span class="hljs-keyword">private</span> sf;
    <span class="hljs-keyword">constructor</span>(<span class="hljs-params">sf</span>) {
        <span class="hljs-keyword">this</span>.sf = sf;
    }
    <span class="hljs-keyword">public</span> observe(viewModel, callback) {
        <span class="hljs-keyword">let</span> host = <span class="hljs-keyword">this</span>.sf;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> viewModel) {
            <span class="hljs-keyword">var</span> defaultValue = viewModel[key];
            (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">k, dv</span>) </span>{
                <span class="hljs-keyword">if</span> (k !== <span class="hljs-string">"_alias"</span>) {
                    <span class="hljs-built_in">Object</span>.defineProperty(viewModel, k, {
                        <span class="hljs-keyword">get</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                            <span class="hljs-keyword">return</span> dv;
                        },
                        <span class="hljs-keyword">set</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) </span>{
                            dv = value;
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"do something after set a new value"</span>);
                            callback.call(host, viewModel, k);
                        }
                    });
                }
            })(key, defaultValue);
        }
    }
}</code></pre>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="//Scanner.ts
import { BoundItem } from &quot;./BoundItem&quot;;
export class Scanner {
    private prefix = &quot;sf-&quot;;
    private viewModelPool;

    constructor(viewModelPool) {
        this.viewModelPool = viewModelPool;
    }
    public scanBindDOM() :object{
        let boundMap = {};
        
        let boundElements = this.getAllBoundElements(this.prefix);
        boundElements.forEach(element => {
           for (let i = 0; i < element.attributes.length; i++) {
                let attr = element.attributes[i];
                if (attr.nodeName.search(this.prefix) > -1) {
                    let attributeName = attr.nodeName;
                    let expression = element.getAttribute(attributeName);
                    for (let alias in this.viewModelPool) {
                        if (expression.search(alias + &quot;.&quot;) != -1) {
                            let boundItem = new BoundItem(this.viewModelPool[alias], element, expression,attributeName);
                            if (!boundMap[alias]) {
                                boundMap[alias] = [boundItem];
                            } else {
                                boundMap[alias].push(boundItem);
                            }
                        }
                    }
                }
            }
        });  
        return boundMap;
    }

    private fuzzyFind(element:HTMLElement,text:string):HTMLElement {
        if (element &amp;&amp; element.attributes) {
            for (let i = 0; i < element.attributes.length; i++) {
                let attr = element.attributes[i];
                if (attr.nodeName.search(text) > -1) {
                    return element;
                }
            }
        }
        return null;
    }
     private getAllBoundElements(prefix): Array<HTMLElement> {
        let elements = [];
        let allChildren = document.querySelectorAll(&quot;*&quot;);
        for (let i = 0; i < allChildren.length; i++) {
            let child: HTMLElement = allChildren[i] as HTMLElement;
            let matchElement = this.fuzzyFind(child, prefix);
            if (matchElement) {
                elements.push(matchElement);
            }
        }
        return elements;
    }
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs cs"><code><span class="hljs-comment">//Scanner.ts</span>
import { BoundItem } <span class="hljs-keyword">from</span> <span class="hljs-string">"./BoundItem"</span>;
export <span class="hljs-keyword">class</span> <span class="hljs-title">Scanner</span> {
    <span class="hljs-keyword">private</span> prefix = <span class="hljs-string">"sf-"</span>;
    <span class="hljs-keyword">private</span> viewModelPool;

    constructor(viewModelPool) {
        <span class="hljs-keyword">this</span>.viewModelPool = viewModelPool;
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">scanBindDOM</span>(<span class="hljs-params"></span>) :<span class="hljs-keyword">object</span></span>{
        <span class="hljs-keyword">let</span> boundMap = {};
        
        <span class="hljs-keyword">let</span> boundElements = <span class="hljs-keyword">this</span>.getAllBoundElements(<span class="hljs-keyword">this</span>.prefix);
        boundElements.forEach(element =&gt; {
           <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; element.attributes.length; i++) {
                <span class="hljs-keyword">let</span> attr = element.attributes[i];
                <span class="hljs-keyword">if</span> (attr.nodeName.search(<span class="hljs-keyword">this</span>.prefix) &gt; <span class="hljs-number">-1</span>) {
                    <span class="hljs-keyword">let</span> attributeName = attr.nodeName;
                    <span class="hljs-keyword">let</span> expression = element.getAttribute(attributeName);
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-keyword">alias</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.viewModelPool) {
                        <span class="hljs-keyword">if</span> (expression.search(<span class="hljs-keyword">alias</span> + <span class="hljs-string">"."</span>) != <span class="hljs-number">-1</span>) {
                            <span class="hljs-keyword">let</span> boundItem = <span class="hljs-keyword">new</span> BoundItem(<span class="hljs-keyword">this</span>.viewModelPool[<span class="hljs-keyword">alias</span>], element, expression,attributeName);
                            <span class="hljs-keyword">if</span> (!boundMap[<span class="hljs-keyword">alias</span>]) {
                                boundMap[<span class="hljs-keyword">alias</span>] = [boundItem];
                            } <span class="hljs-keyword">else</span> {
                                boundMap[<span class="hljs-keyword">alias</span>].push(boundItem);
                            }
                        }
                    }
                }
            }
        });  
        <span class="hljs-keyword">return</span> boundMap;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">fuzzyFind</span>(<span class="hljs-params">element:HTMLElement,text:<span class="hljs-keyword">string</span></span>):HTMLElement </span>{
        <span class="hljs-keyword">if</span> (element &amp;&amp; element.attributes) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; element.attributes.length; i++) {
                <span class="hljs-keyword">let</span> attr = element.attributes[i];
                <span class="hljs-keyword">if</span> (attr.nodeName.search(text) &gt; <span class="hljs-number">-1</span>) {
                    <span class="hljs-keyword">return</span> element;
                }
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
     <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">getAllBoundElements</span>(<span class="hljs-params">prefix</span>): Array&lt;HTMLElement&gt; </span>{
        <span class="hljs-keyword">let</span> elements = [];
        <span class="hljs-keyword">let</span> allChildren = document.querySelectorAll(<span class="hljs-string">"*"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; allChildren.length; i++) {
            <span class="hljs-keyword">let</span> child: HTMLElement = allChildren[i] <span class="hljs-keyword">as</span> HTMLElement;
            <span class="hljs-keyword">let</span> matchElement = <span class="hljs-keyword">this</span>.fuzzyFind(child, prefix);
            <span class="hljs-keyword">if</span> (matchElement) {
                elements.push(matchElement);
            }
        }
        <span class="hljs-keyword">return</span> elements;
    }
}</code></pre>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="//BoundItem.ts
export class BoundItem {
    public viewModel: object;
    public element: Element;
    public expression: string;
    public attributeName: string;
    private interactiveDomConfig = {
        &quot;INPUT&quot;:{
            &quot;text&quot;:&quot;input&quot;,
            &quot;password&quot;:&quot;input&quot;,
            &quot;email&quot;:&quot;input&quot;,
            &quot;url&quot;:&quot;input&quot;,
            &quot;tel&quot;:&quot;input&quot;,
            &quot;radio&quot;:&quot;change&quot;,
            &quot;checkbox&quot;:&quot;change&quot;,
            &quot;color&quot;:&quot;change&quot;,
            &quot;date&quot;:&quot;change&quot;,
            &quot;datetime&quot;:&quot;change&quot;,
            &quot;datetime-local&quot;:&quot;change&quot;,
            &quot;month&quot;:&quot;change&quot;,
            &quot;number&quot;:&quot;change&quot;,
            &quot;range&quot;:&quot;change&quot;,
            &quot;search&quot;:&quot;change&quot;,
            &quot;time&quot;:&quot;change&quot;,
            &quot;week&quot;:&quot;change&quot;,
            &quot;button&quot;:&quot;N/A&quot;,
            &quot;submit&quot;:&quot;N/A&quot;
        },
        &quot;SELECT&quot;:&quot;change&quot;,
        &quot;TEXTAREA&quot;:&quot;change&quot;
    }
    constructor(viewModel: object, element: Element, expression: string, attributeName: string) {
        this.viewModel = viewModel;
        this.element = element;
        this.expression = expression;
        this.attributeName = attributeName;
        this.addListener(this.element,this.expression);
    }

    private addListener(element,expression){
        let tagName = element.tagName;
        let eventName = this.interactiveDomConfig[tagName];
        if(!eventName){
            return;
        }
        if(typeof eventName === &quot;object&quot;){
            let type = element.getAttribute(&quot;type&quot;);
            eventName = eventName[type];
        }
        element.addEventListener(eventName, (e)=> {
            let newValue = (element as HTMLInputElement).value;
            let cmd = expression + &quot;= \&quot;&quot; + newValue + &quot;\&quot;&quot;;
            try{
                eval(cmd);
            }catch(e){
                console.error(e);
            }
        });
    }
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs typescript"><code><span class="hljs-comment">//BoundItem.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> BoundItem {
    <span class="hljs-keyword">public</span> viewModel: object;
    <span class="hljs-keyword">public</span> element: Element;
    <span class="hljs-keyword">public</span> expression: <span class="hljs-built_in">string</span>;
    <span class="hljs-keyword">public</span> attributeName: <span class="hljs-built_in">string</span>;
    <span class="hljs-keyword">private</span> interactiveDomConfig = {
        <span class="hljs-string">"INPUT"</span>:{
            <span class="hljs-string">"text"</span>:<span class="hljs-string">"input"</span>,
            <span class="hljs-string">"password"</span>:<span class="hljs-string">"input"</span>,
            <span class="hljs-string">"email"</span>:<span class="hljs-string">"input"</span>,
            <span class="hljs-string">"url"</span>:<span class="hljs-string">"input"</span>,
            <span class="hljs-string">"tel"</span>:<span class="hljs-string">"input"</span>,
            <span class="hljs-string">"radio"</span>:<span class="hljs-string">"change"</span>,
            <span class="hljs-string">"checkbox"</span>:<span class="hljs-string">"change"</span>,
            <span class="hljs-string">"color"</span>:<span class="hljs-string">"change"</span>,
            <span class="hljs-string">"date"</span>:<span class="hljs-string">"change"</span>,
            <span class="hljs-string">"datetime"</span>:<span class="hljs-string">"change"</span>,
            <span class="hljs-string">"datetime-local"</span>:<span class="hljs-string">"change"</span>,
            <span class="hljs-string">"month"</span>:<span class="hljs-string">"change"</span>,
            <span class="hljs-string">"number"</span>:<span class="hljs-string">"change"</span>,
            <span class="hljs-string">"range"</span>:<span class="hljs-string">"change"</span>,
            <span class="hljs-string">"search"</span>:<span class="hljs-string">"change"</span>,
            <span class="hljs-string">"time"</span>:<span class="hljs-string">"change"</span>,
            <span class="hljs-string">"week"</span>:<span class="hljs-string">"change"</span>,
            <span class="hljs-string">"button"</span>:<span class="hljs-string">"N/A"</span>,
            <span class="hljs-string">"submit"</span>:<span class="hljs-string">"N/A"</span>
        },
        <span class="hljs-string">"SELECT"</span>:<span class="hljs-string">"change"</span>,
        <span class="hljs-string">"TEXTAREA"</span>:<span class="hljs-string">"change"</span>
    }
    <span class="hljs-keyword">constructor</span>(<span class="hljs-params">viewModel: object, element: Element, expression: <span class="hljs-built_in">string</span>, attributeName: <span class="hljs-built_in">string</span></span>) {
        <span class="hljs-keyword">this</span>.viewModel = viewModel;
        <span class="hljs-keyword">this</span>.element = element;
        <span class="hljs-keyword">this</span>.expression = expression;
        <span class="hljs-keyword">this</span>.attributeName = attributeName;
        <span class="hljs-keyword">this</span>.addListener(<span class="hljs-keyword">this</span>.element,<span class="hljs-keyword">this</span>.expression);
    }

    <span class="hljs-keyword">private</span> addListener(element,expression){
        <span class="hljs-keyword">let</span> tagName = element.tagName;
        <span class="hljs-keyword">let</span> eventName = <span class="hljs-keyword">this</span>.interactiveDomConfig[tagName];
        <span class="hljs-keyword">if</span>(!eventName){
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> eventName === <span class="hljs-string">"object"</span>){
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">type</span> = element.getAttribute(<span class="hljs-string">"type"</span>);
            eventName = eventName[<span class="hljs-keyword">type</span>];
        }
        element.addEventListener(eventName, <span class="hljs-function">(<span class="hljs-params">e</span>)=&gt;</span> {
            <span class="hljs-keyword">let</span> newValue = (element <span class="hljs-keyword">as</span> HTMLInputElement).value;
            <span class="hljs-keyword">let</span> cmd = expression + <span class="hljs-string">"= \""</span> + newValue + <span class="hljs-string">"\""</span>;
            <span class="hljs-keyword">try</span>{
                <span class="hljs-built_in">eval</span>(cmd);
            }<span class="hljs-keyword">catch</span>(e){
                <span class="hljs-built_in">console</span>.error(e);
            }
        });
    }
}</code></pre>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="//Renderer.ts
import {BoundItem} from &quot;./BoundItem&quot;;
export class Renderer{
    public render(boundItem:BoundItem) {
        var value = this.getValue(boundItem.viewModel, boundItem.expression);
        var attribute = boundItem.attributeName.split('-')[1];

        if (attribute.toLowerCase() === &quot;innertext&quot;) {
            attribute = &quot;innerText&quot;;
        }
        boundItem.element[attribute] = value;
    };
    private getValue(viewModel, expression) {
        return (function () {
            var alias = viewModel._alias;
            var tempScope = {};
            tempScope[alias] = viewModel;
            try {
                var pattern = new RegExp(&quot;\\b&quot; + alias + &quot;\\b&quot;, &quot;gm&quot;);
                expression = expression.replace(pattern, &quot;tempScope.&quot; + alias);
                var result = eval(expression);
                tempScope = null;
                return result;
            } catch (e) {
                throw e;
            }
        })();
    }
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs cs"><code><span class="hljs-comment">//Renderer.ts</span>
import {BoundItem} <span class="hljs-keyword">from</span> <span class="hljs-string">"./BoundItem"</span>;
export <span class="hljs-keyword">class</span> <span class="hljs-title">Renderer</span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">render</span>(<span class="hljs-params">boundItem:BoundItem</span>) </span>{
        <span class="hljs-keyword">var</span> <span class="hljs-keyword">value</span> = <span class="hljs-keyword">this</span>.getValue(boundItem.viewModel, boundItem.expression);
        <span class="hljs-keyword">var</span> attribute = boundItem.attributeName.split(<span class="hljs-string">'-'</span>)[<span class="hljs-number">1</span>];

        <span class="hljs-keyword">if</span> (attribute.toLowerCase() === <span class="hljs-string">"innertext"</span>) {
            attribute = <span class="hljs-string">"innerText"</span>;
        }
        boundItem.element[attribute] = <span class="hljs-keyword">value</span>;
    };
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">getValue</span>(<span class="hljs-params">viewModel, expression</span>) </span>{
        <span class="hljs-keyword">return</span> (function () {
            <span class="hljs-keyword">var</span> <span class="hljs-keyword">alias</span> = viewModel._alias;
            <span class="hljs-keyword">var</span> tempScope = {};
            tempScope[<span class="hljs-keyword">alias</span>] = viewModel;
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">var</span> pattern = <span class="hljs-keyword">new</span> RegExp(<span class="hljs-string">"\\b"</span> + <span class="hljs-keyword">alias</span> + <span class="hljs-string">"\\b"</span>, <span class="hljs-string">"gm"</span>);
                expression = expression.replace(pattern, <span class="hljs-string">"tempScope."</span> + <span class="hljs-keyword">alias</span>);
                <span class="hljs-keyword">var</span> result = eval(expression);
                tempScope = <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">return</span> result;
            } <span class="hljs-keyword">catch</span> (e) {
                <span class="hljs-keyword">throw</span> e;
            }
        })();
    }
}</code></pre>
<h3 id="articleHeader2">相关阅读</h3>
<p><a href="https://segmentfault.com/a/1190000010744960">【教学向】150行代码教你实现一个低配版的MVVM库（1）- 原理篇</a><br><a href="https://segmentfault.com/a/1190000010752076" target="_blank">【教学向】150行代码教你实现一个低配版的MVVM库（2）- 代码篇</a><br><a href="https://segmentfault.com/a/1190000010877602">【教学向】再加150行代码教你实现一个低配版的web component库（1） —设计篇</a><br><a href="https://segmentfault.com/a/1190000010895646" target="_blank">【教学向】再加150行代码教你实现一个低配版的web component库（2） —原理篇</a></p>

                
{{< /raw >}}

# 版权声明
本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，

本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。

原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！

## 原文标题
【教学向】150行代码教你实现一个低配版的MVVM库（2）- 代码篇

## 原文链接
[https://segmentfault.com/a/1190000010752076](https://segmentfault.com/a/1190000010752076)

