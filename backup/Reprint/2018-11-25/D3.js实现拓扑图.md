---
title: 'D3.js实现拓扑图' 
date: 2018-11-25 2:30:07
hidden: true
slug: jjvh0augatb
categories: [reprint]
---

{{< raw >}}
<p>&#x6700;&#x8FD1;&#x5199;&#x9879;&#x76EE;&#x9700;&#x8981;&#x753B;&#x51FA;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8C03;&#x7528;&#x94FE;&#x7684;&#x7F51;&#x8DEF;&#x62D3;&#x6251;&#x56FE;&#xFF0C;&#x5B8C;&#x5168;&#x81EA;&#x5DF1;&#x5199;&#x9700;&#x8981;&#x82B1;&#x8D39;&#x4E9B;&#x65F6;&#x95F4;&#xFF0C;&#x90A3;&#x4E48;&#x9996;&#x5148;&#x60F3;&#x5230;&#x7684;&#x662F;echarts,&#x4F46;echarts&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#x5199;&#x6CD5;&#x5199;&#x8D77;&#x6765;&#x975E;&#x5E38;&#x9EBB;&#x70E6;&#xFF0C;&#x800C;&#x4E14;&#x5B83;&#x7684;&#x6587;&#x6863;&#x90FD;&#x662F;&#x57FA;&#x4E8E;&#x914D;&#x7F6E;&#x8BF4;&#x660E;&#x7684;&#xFF0C;&#x5BF9;&#x4E8E;&#x81EA;&#x5B9A;&#x4E49;&#x5F00;&#x53D1;&#x4E0D;&#x592A;&#x65B9;&#x4FBF;&#xFF0C;&#x5C1D;&#x8BD5;&#x540E;&#x679C;&#x65AD;&#x653E;&#x5F03;&#xFF0C;&#x6539;&#x7528;D3.js&#xFF0C;&#x81EA;&#x5DF1;&#x5B8C;&#x5168;&#x53EF;&#x63A7;&#x3002;</p><p>&#x6211;&#x4EEC;&#x5148;&#x770B;&#x770B;&#x6548;&#x679C;<br><span class="img-wrap"><img data-src="/img/bVbcVDR?w=1182&amp;h=652" src="https://static.alili.tech/img/bVbcVDR?w=1182&amp;h=652" alt="&#x56FE;&#x7247;&#x63CF;&#x8FF0;" title="&#x56FE;&#x7247;&#x63CF;&#x8FF0;" style="cursor:pointer;display:inline"></span></p><p>&#x6211;&#x628A;&#x4EE3;&#x7801;&#x5206;&#x4EAB;&#x4E0B;&#xFF0C;&#x4F9B;&#x548C;&#x6211;&#x4E00;&#x6837;&#x521A;&#x63A5;&#x89E6;D3&#x7684;&#x540C;&#x5B66;&#x53C2;&#x8003;&#xFF0C;&#x4E0D;&#x5BF9;&#x7684;&#x5730;&#x65B9;&#x6B22;&#x8FCE;&#x6307;&#x6B63;&#xFF01;</p><p>&#x5B8C;&#x6574;&#x4EE3;&#x7801;&#xFF1A;</p><p>html&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;title&gt;Title&lt;/title&gt;
    &lt;script type=&quot;text/javascript&quot; src=&quot;http://d3js.org/d3.v5.min.js&quot;&gt;
    &lt;/script&gt;
    &lt;style&gt;
        body{
            overflow: hidden;
        }
        #togo{
            width: 800px;
            height:500px;
            border:1px solid #ccc;
            user-select: none;
        }
        #togo text{
            font-size:10px;/*&#x548C;js&#x91CC;&#x4FDD;&#x6301;&#x4E00;&#x81F4;*/
            fill:#1A2C3F;
            text-anchor: middle;
        }
        #togo .node-other{

            text-anchor: start;
        }
        #togo .health1{
            stroke:#92E1A2;
        }
        #togo .health2{
            stroke:orange;
        }
        #togo .health3{
            stroke:red;
        }
        #togo #cloud,#togo #database{
            fill:#ccc;
        }
        #togo .link{
            stroke:#E4E8ED;
        }
        #togo .node-title{
            font-size: 14px;
        }
        #togo .node-code circle{
           fill:#3F86F5;
        }
        #togo .node-code text{
            fill:#fff;
        }
        #togo .node-bg{
            fill:#fff;
        }
        #togo .arrow{
            fill:#E4E8ED;
        }
    &lt;/style&gt;
    &lt;script src=&quot;data.js&quot;&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
 &lt;svg id=&quot;togo&quot; width=&quot;800&quot; height=&quot;500&quot;&gt;

 &lt;/svg&gt;
 &lt;script src=&quot;togo.js&quot;&gt;&lt;/script&gt;
 &lt;script&gt;

 &lt;/script&gt;

 &lt;script&gt;
    let t=new Togo(&apos;#togo&apos;,__options);
    t.render();
 &lt;/script&gt;


&lt;/body&gt;
&lt;/html&gt;" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs xml"><code><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://d3js.org/d3.v5.min.js&quot;</span>&gt;</span><span class="undefined">
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span>{
            <span class="hljs-attribute">overflow</span>: hidden;
        }
        <span class="hljs-selector-id">#togo</span>{
            <span class="hljs-attribute">width</span>: <span class="hljs-number">800px</span>;
            <span class="hljs-attribute">height</span>:<span class="hljs-number">500px</span>;
            <span class="hljs-attribute">border</span>:<span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
            <span class="hljs-attribute">user-select</span>: none;
        }
        <span class="hljs-selector-id">#togo</span> <span class="hljs-selector-tag">text</span>{
            <span class="hljs-attribute">font-size</span>:<span class="hljs-number">10px</span>;<span class="hljs-comment">/*&#x548C;js&#x91CC;&#x4FDD;&#x6301;&#x4E00;&#x81F4;*/</span>
            <span class="hljs-attribute">fill</span>:<span class="hljs-number">#1A2C3F</span>;
            <span class="hljs-attribute">text-anchor</span>: middle;
        }
        <span class="hljs-selector-id">#togo</span> <span class="hljs-selector-class">.node-other</span>{

            <span class="hljs-attribute">text-anchor</span>: start;
        }
        <span class="hljs-selector-id">#togo</span> <span class="hljs-selector-class">.health1</span>{
            <span class="hljs-attribute">stroke</span>:<span class="hljs-number">#92E1A2</span>;
        }
        <span class="hljs-selector-id">#togo</span> <span class="hljs-selector-class">.health2</span>{
            <span class="hljs-attribute">stroke</span>:orange;
        }
        <span class="hljs-selector-id">#togo</span> <span class="hljs-selector-class">.health3</span>{
            <span class="hljs-attribute">stroke</span>:red;
        }
        <span class="hljs-selector-id">#togo</span> <span class="hljs-selector-id">#cloud</span>,<span class="hljs-selector-id">#togo</span> <span class="hljs-selector-id">#database</span>{
            <span class="hljs-attribute">fill</span>:<span class="hljs-number">#ccc</span>;
        }
        <span class="hljs-selector-id">#togo</span> <span class="hljs-selector-class">.link</span>{
            <span class="hljs-attribute">stroke</span>:<span class="hljs-number">#E4E8ED</span>;
        }
        <span class="hljs-selector-id">#togo</span> <span class="hljs-selector-class">.node-title</span>{
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
        }
        <span class="hljs-selector-id">#togo</span> <span class="hljs-selector-class">.node-code</span> <span class="hljs-selector-tag">circle</span>{
           <span class="hljs-attribute">fill</span>:<span class="hljs-number">#3F86F5</span>;
        }
        <span class="hljs-selector-id">#togo</span> <span class="hljs-selector-class">.node-code</span> <span class="hljs-selector-tag">text</span>{
            <span class="hljs-attribute">fill</span>:<span class="hljs-number">#fff</span>;
        }
        <span class="hljs-selector-id">#togo</span> <span class="hljs-selector-class">.node-bg</span>{
            <span class="hljs-attribute">fill</span>:<span class="hljs-number">#fff</span>;
        }
        <span class="hljs-selector-id">#togo</span> <span class="hljs-selector-class">.arrow</span>{
            <span class="hljs-attribute">fill</span>:<span class="hljs-number">#E4E8ED</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;data.js&quot;</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;togo&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;800&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&quot;500&quot;</span>&gt;</span>

 <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;togo.js&quot;</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="undefined">

 </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

 <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">let</span> t=<span class="hljs-keyword">new</span> Togo(<span class="hljs-string">&apos;#togo&apos;</span>,__options);
    t.render();
 </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>


<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><p>JS&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="
const fontSize = 10;
const symbolSize = 40;
const padding = 10;

/*
* &#x8C03;&#x7528; new Togo(svg,option).render();
* */
class Togo {
  /**/
  constructor(svg, option) {
    this.data = option.data;
    this.edges = option.edges;
    this.svg = d3.select(svg);

  }

  //&#x4E3B;&#x6E32;&#x67D3;&#x65B9;&#x6CD5;
  render() {
    this.scale = 1;
    this.width = this.svg.attr(&apos;width&apos;);
    this.height = this.svg.attr(&apos;height&apos;);
    this.container = this.svg.append(&apos;g&apos;)
    .attr(&apos;transform&apos;, &apos;scale(&apos; + this.scale + &apos;)&apos;);


    this.initPosition();
    this.initDefineSymbol();
    this.initLink();
    this.initNode();
    this.initZoom();

  }

  //&#x521D;&#x59CB;&#x5316;&#x8282;&#x70B9;&#x4F4D;&#x7F6E;
  initPosition() {
    let origin = [this.width / 2, this.height / 2];
    let points = this.getVertices(origin, Math.min(this.width, this.height) * 0.3, this.data.length);
    this.data.forEach((item, i) =&gt; {
      item.x = points[i].x;
      item.y = points[i].y;
    })
  }

  //&#x6839;&#x636E;&#x591A;&#x8FB9;&#x5F62;&#x83B7;&#x53D6;&#x5B9A;&#x4F4D;&#x70B9;
  getVertices(origin, r, n) {
    if (typeof n !== &apos;number&apos;) return;
    var ox = origin[0];
    var oy = origin[1];
    var angle = 360 / n;
    var i = 0;
    var points = [];
    var tempAngle = 0;
    while (i &lt; n) {
      tempAngle = (i * angle * Math.PI) / 180;
      points.push({
        x: ox + r * Math.sin(tempAngle),
        y: oy + r * Math.cos(tempAngle),
      });
      i++;
    }
    return points;
  }

  //&#x4E24;&#x70B9;&#x7684;&#x4E2D;&#x5FC3;&#x70B9;
  getCenter(x1, y1, x2, y2) {
    return [(x1 + x2) / 2, (y1 + y2) / 2]
  }

  //&#x4E24;&#x70B9;&#x7684;&#x8DDD;&#x79BB;
  getDistance(x1, y1, x2, y2) {
    return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
  }

  //&#x4E24;&#x70B9;&#x89D2;&#x5EA6;
  getAngle(x1, y1, x2, y2) {
    var x = Math.abs(x1 - x2);
    var y = Math.abs(y1 - y2);
    var z = Math.sqrt(x * x + y * y);
    return Math.round((Math.asin(y / z) / Math.PI * 180));
  }


  //&#x521D;&#x59CB;&#x5316;&#x7F29;&#x653E;&#x5668;
  initZoom() {
    let self = this;
    let zoom = d3.zoom()
    .scaleExtent([0.7, 3])
    .on(&apos;zoom&apos;, function () {
      self.onZoom(this)
    });
    this.svg.call(zoom)
  }

  //&#x521D;&#x59CB;&#x5316;&#x56FE;&#x6807;
  initDefineSymbol() {
    let defs=this.container.append(&apos;svg:defs&apos;);

    //&#x7BAD;&#x5934;
    const marker = defs
    .selectAll(&apos;marker&apos;)
    .data(this.edges)
    .enter()
    .append(&apos;svg:marker&apos;)
    .attr(&apos;id&apos;, (link, i) =&gt; &apos;marker-&apos; + i)
    .attr(&apos;markerUnits&apos;, &apos;userSpaceOnUse&apos;)
    .attr(&apos;viewBox&apos;, &apos;0 -5 10 10&apos;)
    .attr(&apos;refX&apos;, symbolSize / 2 + padding)
    .attr(&apos;refY&apos;, 0)
    .attr(&apos;markerWidth&apos;, 14)
    .attr(&apos;markerHeight&apos;, 14)
    .attr(&apos;orient&apos;, &apos;auto&apos;)
    .attr(&apos;stroke-width&apos;, 2)
    .append(&apos;svg:path&apos;)
    .attr(&apos;d&apos;, &apos;M2,0 L0,-3 L9,0 L0,3 M2,0 L0,-3&apos;)
    .attr(&apos;class&apos;,&apos;arrow&apos;)


    //&#x6570;&#x636E;&#x5E93;
    let database =defs.append(&apos;g&apos;)
      .attr(&apos;id&apos;,&apos;database&apos;)
    .attr(&apos;transform&apos;,&apos;scale(0.042)&apos;);

    database.append(&apos;path&apos;)
    .attr(&apos;d&apos;,&apos;M512 800c-247.42 0-448-71.63-448-160v160c0 88.37 200.58 160 448 160s448-71.63 448-160V640c0 88.37-200.58 160-448 160z&apos;)

    database.append(&apos;path&apos;)
    .attr(&apos;d&apos;,&apos;M512 608c-247.42 0-448-71.63-448-160v160c0 88.37 200.58 160 448 160s448-71.63 448-160V448c0 88.37-200.58 160-448 160z&apos;) ;

    database.append(&apos;path&apos;)
    .attr(&apos;d&apos;,&apos;M512 416c-247.42 0-448-71.63-448-160v160c0 88.37 200.58 160 448 160s448-71.63 448-160V256c0 88.37-200.58 160-448 160z&apos;) ;

    database.append(&apos;path&apos;)
    .attr(&apos;d&apos;,&apos;M64 224a448 160 0 1 0 896 0 448 160 0 1 0-896 0Z&apos;);

    //&#x4E91;
    let cloud=defs.append(&apos;g&apos;)
    .attr(&apos;id&apos;,&apos;cloud&apos;)
    .attr(&apos;transform&apos;,&apos;scale(0.042)&apos;)
    .append(&apos;path&apos;)
    .attr(&apos;d&apos;,&apos;M709.3 285.8C668.3 202.7 583 145.4 484 145.4c-132.6 0-241 102.8-250.4 233-97.5 27.8-168.5 113-168.5 213.8 0 118.9 98.8 216.6 223.4 223.4h418.9c138.7 0 251.3-118.8 251.3-265.3 0-141.2-110.3-256.2-249.4-264.5z&apos;)



  }

  //&#x521D;&#x59CB;&#x5316;&#x94FE;&#x63A5;&#x7EBF;
  initLink() {
    this.drawLinkLine();
    this.drawLinkText();
  }

  //&#x521D;&#x59CB;&#x5316;&#x8282;&#x70B9;
  initNode() {
    var self = this;
    //&#x8282;&#x70B9;&#x5BB9;&#x5668;
    this.nodes = this.container.selectAll(&quot;.node&quot;)
    .data(this.data)
    .enter()
    .append(&quot;g&quot;)
    .attr(&quot;transform&quot;, function (d) {
      return &quot;translate(&quot; + d.x + &quot;,&quot; + d.y + &quot;)&quot;;
    })
    .call(d3.drag()
      .on(&quot;drag&quot;, function (d) {
        self.onDrag(this, d)
      })
    )
    .on(&apos;click&apos;, function () {
      alert()
    })

    //&#x8282;&#x70B9;&#x80CC;&#x666F;&#x9ED8;&#x8BA4;&#x8986;&#x76D6;&#x5C42;
    this.nodes.append(&apos;circle&apos;)
    .attr(&apos;r&apos;, symbolSize / 2 + padding)
    .attr(&apos;class&apos;, &apos;node-bg&apos;);

    //&#x8282;&#x70B9;&#x56FE;&#x6807;
    this.drawNodeSymbol();
    //&#x8282;&#x70B9;&#x6807;&#x9898;
    this.drawNodeTitle();
    //&#x8282;&#x70B9;&#x5176;&#x4ED6;&#x8BF4;&#x660E;
    this.drawNodeOther();
    this.drawNodeCode();

  }

  //&#x753B;&#x8282;&#x70B9;&#x8BED;&#x8A00;&#x6807;&#x8BC6;
  drawNodeCode() {
    this.nodeCodes = this.nodes.filter(item =&gt; item.type == &apos;app&apos;)
    .append(&apos;g&apos;)
    .attr(&apos;class&apos;,&apos;node-code&apos;)
    .attr(&apos;transform&apos;, &apos;translate(&apos; + -symbolSize / 2 + &apos;,&apos; + symbolSize / 3 + &apos;)&apos;)

    this.nodeCodes
    .append(&apos;circle&apos;)
    .attr(&apos;r&apos;, d =&gt; fontSize / 2 * d.code.length / 2 + 3)

    this.nodeCodes
    .append(&apos;text&apos;)
    .attr(&apos;dy&apos;, fontSize / 2)
    .text(item =&gt; item.code);

  }

  //&#x753B;&#x8282;&#x70B9;&#x56FE;&#x6807;
  drawNodeSymbol() {
    //&#x7ED8;&#x5236;&#x8282;&#x70B9;
    this.nodes.filter(item=&gt;item.type==&apos;app&apos;)
    .append(&quot;circle&quot;)
    .attr(&quot;r&quot;, symbolSize / 2)
    .attr(&quot;fill&quot;, &apos;#fff&apos;)
    .attr(&apos;class&apos;, function (d) {
      return &apos;health&apos;+d.health;
    })
    .attr(&apos;stroke-width&apos;, &apos;5px&apos;)


    this.nodes.filter(item=&gt;item.type==&apos;database&apos;)
    .append(&apos;use&apos;)
    .attr(&apos;xlink:href&apos;,&apos;#database&apos;)
    .attr(&apos;x&apos;,function () {
      return -this.getBBox().width/2
    })
    .attr(&apos;y&apos;,function () {
      return -this.getBBox().height/2
    })

    this.nodes.filter(item=&gt;item.type==&apos;cloud&apos;)
    .append(&apos;use&apos;)
    .attr(&apos;xlink:href&apos;,&apos;#cloud&apos;)
    .attr(&apos;x&apos;,function () {
      return -this.getBBox().width/2
    })
    .attr(&apos;y&apos;,function () {
      return -this.getBBox().height/2
    })
  }

  //&#x753B;&#x8282;&#x70B9;&#x53F3;&#x4FA7;&#x4FE1;&#x606F;
  drawNodeOther() {
    //&#x5982;&#x679C;&#x662F;&#x5E94;&#x7528;&#x7684;&#x65F6;&#x5019;
    this.nodeOthers = this.nodes.filter(item =&gt; item.type == &apos;app&apos;)
    .append(&quot;text&quot;)
    .attr(&quot;x&quot;, symbolSize / 2 + padding)
    .attr(&quot;y&quot;, -5)
    .attr(&apos;class&apos;,&apos;node-other&apos;)

    this.nodeOthers.append(&apos;tspan&apos;)
    .text(d =&gt; d.time + &apos;ms&apos;);

    this.nodeOthers.append(&apos;tspan&apos;)
    .text(d =&gt; d.rpm + &apos;rpm&apos;)
    .attr(&apos;x&apos;, symbolSize / 2 + padding)
    .attr(&apos;dy&apos;, &apos;1em&apos;);

    this.nodeOthers.append(&apos;tspan&apos;)
    .text(d =&gt; d.epm + &apos;epm&apos;)
    .attr(&apos;x&apos;, symbolSize / 2 + padding)
    .attr(&apos;dy&apos;, &apos;1em&apos;)
  }

  //&#x753B;&#x8282;&#x70B9;&#x6807;&#x9898;
  drawNodeTitle() {
    //&#x8282;&#x70B9;&#x6807;&#x9898;
    this.nodes.append(&quot;text&quot;)
    .attr(&apos;class&apos;,&apos;node-title&apos;)
    .text(function (d) {
      return d.name;
    })
    .attr(&quot;dy&quot;, symbolSize)

    this.nodes.filter(item =&gt; item.type == &apos;app&apos;).append(&quot;text&quot;)
    .text(function (d) {
      return d.active + &apos;/&apos; + d.total;
    })
    .attr(&apos;dy&apos;, fontSize / 2)
    .attr(&apos;class&apos;,&apos;node-call&apos;)

  }

  //&#x753B;&#x8282;&#x70B9;&#x94FE;&#x63A5;&#x7EBF;
  drawLinkLine() {
    let data = this.data;
    if (this.lineGroup) {
      this.lineGroup.selectAll(&apos;.link&apos;)
      .attr(
        &apos;d&apos;, link =&gt; genLinkPath(link),
      )
    } else {
      this.lineGroup = this.container.append(&apos;g&apos;)


      this.lineGroup.selectAll(&apos;.link&apos;)
      .data(this.edges)
      .enter()
      .append(&apos;path&apos;)
      .attr(&apos;class&apos;, &apos;link&apos;)
      .attr(
        &apos;marker-end&apos;, (link, i) =&gt; &apos;url(#&apos; + &apos;marker-&apos; + i + &apos;)&apos;
      ).attr(
        &apos;d&apos;, link =&gt; genLinkPath(link),
      ).attr(
        &apos;id&apos;, (link, i) =&gt; &apos;link-&apos; + i
      )
      .on(&apos;click&apos;, () =&gt; { alert() })
    }

    function genLinkPath(d) {
      let sx = data[d.source].x;
      let tx = data[d.target].x;
      let sy = data[d.source].y;
      let ty = data[d.target].y;
      return &apos;M&apos; + sx + &apos;,&apos; + sy + &apos; L&apos; + tx + &apos;,&apos; + ty;
    }
  }


  drawLinkText() {
    let data = this.data;
    let self = this;
    if (this.lineTextGroup) {
      this.lineTexts
      .attr(&apos;transform&apos;, getTransform)

    } else {
      this.lineTextGroup = this.container.append(&apos;g&apos;)

      this.lineTexts = this.lineTextGroup
      .selectAll(&apos;.linetext&apos;)
      .data(this.edges)
      .enter()
      .append(&apos;text&apos;)
      .attr(&apos;dy&apos;, -2)
      .attr(&apos;transform&apos;, getTransform)
      .on(&apos;click&apos;, () =&gt; { alert() })

      this.lineTexts
      .append(&apos;tspan&apos;)
      .text((d, i) =&gt; this.data[d.source].lineTime + &apos;ms,&apos; + this.data[d.source].lineRpm + &apos;rpm&apos;);

      this.lineTexts
      .append(&apos;tspan&apos;)
      .text((d, i) =&gt; this.data[d.source].lineProtocol)
      .attr(&apos;dy&apos;, &apos;1em&apos;)
      .attr(&apos;dx&apos;, function () {
        return -this.getBBox().width / 2
      })
    }

    function getTransform(link) {
      let s = data[link.source];
      let t = data[link.target];
      let p = self.getCenter(s.x, s.y, t.x, t.y);
      let angle = self.getAngle(s.x, s.y, t.x, t.y);
      if (s.x &gt; t.x &amp;&amp; s.y &lt; t.y || s.x &lt; t.x &amp;&amp; s.y &gt; t.y) {
        angle = -angle
      }
      return &apos;translate(&apos; + p[0] + &apos;,&apos; + p[1] + &apos;) rotate(&apos; + angle + &apos;)&apos;
    }
  }


  update(d) {
    this.drawLinkLine();
    this.drawLinkText();
  }

  //&#x62D6;&#x62FD;&#x65B9;&#x6CD5;
  onDrag(ele, d) {
    d.x = d3.event.x;
    d.y = d3.event.y;
    d3.select(ele)
    .attr(&apos;transform&apos;, &quot;translate(&quot; + d3.event.x + &quot;,&quot; + d3.event.y + &quot;)&quot;)
    this.update(d);
  }

  //&#x7F29;&#x653E;&#x65B9;&#x6CD5;
  onZoom(ele) {
    var transform = d3.zoomTransform(ele);
    this.scale = transform.k;
    this.container.attr(&apos;transform&apos;, &quot;translate(&quot; + transform.x + &quot;,&quot; + transform.y + &quot;)scale(&quot; + transform.k + &quot;)&quot;)
  }

}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs typescript"><code>
<span class="hljs-keyword">const</span> fontSize = <span class="hljs-number">10</span>;
<span class="hljs-keyword">const</span> symbolSize = <span class="hljs-number">40</span>;
<span class="hljs-keyword">const</span> padding = <span class="hljs-number">10</span>;

<span class="hljs-comment">/*
* &#x8C03;&#x7528; new Togo(svg,option).render();
* */</span>
<span class="hljs-keyword">class</span> Togo {
  <span class="hljs-comment">/**/</span>
  <span class="hljs-keyword">constructor</span>(<span class="hljs-params">svg, option</span>) {
    <span class="hljs-keyword">this</span>.data = option.data;
    <span class="hljs-keyword">this</span>.edges = option.edges;
    <span class="hljs-keyword">this</span>.svg = d3.select(svg);

  }

  <span class="hljs-comment">//&#x4E3B;&#x6E32;&#x67D3;&#x65B9;&#x6CD5;</span>
  render() {
    <span class="hljs-keyword">this</span>.scale = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>.width = <span class="hljs-keyword">this</span>.svg.attr(<span class="hljs-string">&apos;width&apos;</span>);
    <span class="hljs-keyword">this</span>.height = <span class="hljs-keyword">this</span>.svg.attr(<span class="hljs-string">&apos;height&apos;</span>);
    <span class="hljs-keyword">this</span>.container = <span class="hljs-keyword">this</span>.svg.append(<span class="hljs-string">&apos;g&apos;</span>)
    .attr(<span class="hljs-string">&apos;transform&apos;</span>, <span class="hljs-string">&apos;scale(&apos;</span> + <span class="hljs-keyword">this</span>.scale + <span class="hljs-string">&apos;)&apos;</span>);


    <span class="hljs-keyword">this</span>.initPosition();
    <span class="hljs-keyword">this</span>.initDefineSymbol();
    <span class="hljs-keyword">this</span>.initLink();
    <span class="hljs-keyword">this</span>.initNode();
    <span class="hljs-keyword">this</span>.initZoom();

  }

  <span class="hljs-comment">//&#x521D;&#x59CB;&#x5316;&#x8282;&#x70B9;&#x4F4D;&#x7F6E;</span>
  initPosition() {
    <span class="hljs-keyword">let</span> origin = [<span class="hljs-keyword">this</span>.width / <span class="hljs-number">2</span>, <span class="hljs-keyword">this</span>.height / <span class="hljs-number">2</span>];
    <span class="hljs-keyword">let</span> points = <span class="hljs-keyword">this</span>.getVertices(origin, <span class="hljs-built_in">Math</span>.min(<span class="hljs-keyword">this</span>.width, <span class="hljs-keyword">this</span>.height) * <span class="hljs-number">0.3</span>, <span class="hljs-keyword">this</span>.data.length);
    <span class="hljs-keyword">this</span>.data.forEach(<span class="hljs-function">(<span class="hljs-params">item, i</span>) =&gt;</span> {
      item.x = points[i].x;
      item.y = points[i].y;
    })
  }

  <span class="hljs-comment">//&#x6839;&#x636E;&#x591A;&#x8FB9;&#x5F62;&#x83B7;&#x53D6;&#x5B9A;&#x4F4D;&#x70B9;</span>
  getVertices(origin, r, n) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> n !== <span class="hljs-string">&apos;number&apos;</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> ox = origin[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">var</span> oy = origin[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">var</span> angle = <span class="hljs-number">360</span> / n;
    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> points = [];
    <span class="hljs-keyword">var</span> tempAngle = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> (i &lt; n) {
      tempAngle = (i * angle * <span class="hljs-built_in">Math</span>.PI) / <span class="hljs-number">180</span>;
      points.push({
        x: ox + r * <span class="hljs-built_in">Math</span>.sin(tempAngle),
        y: oy + r * <span class="hljs-built_in">Math</span>.cos(tempAngle),
      });
      i++;
    }
    <span class="hljs-keyword">return</span> points;
  }

  <span class="hljs-comment">//&#x4E24;&#x70B9;&#x7684;&#x4E2D;&#x5FC3;&#x70B9;</span>
  getCenter(x1, y1, x2, y2) {
    <span class="hljs-keyword">return</span> [(x1 + x2) / <span class="hljs-number">2</span>, (y1 + y2) / <span class="hljs-number">2</span>]
  }

  <span class="hljs-comment">//&#x4E24;&#x70B9;&#x7684;&#x8DDD;&#x79BB;</span>
  getDistance(x1, y1, x2, y2) {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.sqrt(<span class="hljs-built_in">Math</span>.pow(x2 - x1, <span class="hljs-number">2</span>) + <span class="hljs-built_in">Math</span>.pow(y2 - y1, <span class="hljs-number">2</span>));
  }

  <span class="hljs-comment">//&#x4E24;&#x70B9;&#x89D2;&#x5EA6;</span>
  getAngle(x1, y1, x2, y2) {
    <span class="hljs-keyword">var</span> x = <span class="hljs-built_in">Math</span>.abs(x1 - x2);
    <span class="hljs-keyword">var</span> y = <span class="hljs-built_in">Math</span>.abs(y1 - y2);
    <span class="hljs-keyword">var</span> z = <span class="hljs-built_in">Math</span>.sqrt(x * x + y * y);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.round((<span class="hljs-built_in">Math</span>.asin(y / z) / <span class="hljs-built_in">Math</span>.PI * <span class="hljs-number">180</span>));
  }


  <span class="hljs-comment">//&#x521D;&#x59CB;&#x5316;&#x7F29;&#x653E;&#x5668;</span>
  initZoom() {
    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">let</span> zoom = d3.zoom()
    .scaleExtent([<span class="hljs-number">0.7</span>, <span class="hljs-number">3</span>])
    .on(<span class="hljs-string">&apos;zoom&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      self.onZoom(<span class="hljs-keyword">this</span>)
    });
    <span class="hljs-keyword">this</span>.svg.call(zoom)
  }

  <span class="hljs-comment">//&#x521D;&#x59CB;&#x5316;&#x56FE;&#x6807;</span>
  initDefineSymbol() {
    <span class="hljs-keyword">let</span> defs=<span class="hljs-keyword">this</span>.container.append(<span class="hljs-string">&apos;svg:defs&apos;</span>);

    <span class="hljs-comment">//&#x7BAD;&#x5934;</span>
    <span class="hljs-keyword">const</span> marker = defs
    .selectAll(<span class="hljs-string">&apos;marker&apos;</span>)
    .data(<span class="hljs-keyword">this</span>.edges)
    .enter()
    .append(<span class="hljs-string">&apos;svg:marker&apos;</span>)
    .attr(<span class="hljs-string">&apos;id&apos;</span>, <span class="hljs-function">(<span class="hljs-params">link, i</span>) =&gt;</span> <span class="hljs-string">&apos;marker-&apos;</span> + i)
    .attr(<span class="hljs-string">&apos;markerUnits&apos;</span>, <span class="hljs-string">&apos;userSpaceOnUse&apos;</span>)
    .attr(<span class="hljs-string">&apos;viewBox&apos;</span>, <span class="hljs-string">&apos;0 -5 10 10&apos;</span>)
    .attr(<span class="hljs-string">&apos;refX&apos;</span>, symbolSize / <span class="hljs-number">2</span> + padding)
    .attr(<span class="hljs-string">&apos;refY&apos;</span>, <span class="hljs-number">0</span>)
    .attr(<span class="hljs-string">&apos;markerWidth&apos;</span>, <span class="hljs-number">14</span>)
    .attr(<span class="hljs-string">&apos;markerHeight&apos;</span>, <span class="hljs-number">14</span>)
    .attr(<span class="hljs-string">&apos;orient&apos;</span>, <span class="hljs-string">&apos;auto&apos;</span>)
    .attr(<span class="hljs-string">&apos;stroke-width&apos;</span>, <span class="hljs-number">2</span>)
    .append(<span class="hljs-string">&apos;svg:path&apos;</span>)
    .attr(<span class="hljs-string">&apos;d&apos;</span>, <span class="hljs-string">&apos;M2,0 L0,-3 L9,0 L0,3 M2,0 L0,-3&apos;</span>)
    .attr(<span class="hljs-string">&apos;class&apos;</span>,<span class="hljs-string">&apos;arrow&apos;</span>)


    <span class="hljs-comment">//&#x6570;&#x636E;&#x5E93;</span>
    <span class="hljs-keyword">let</span> database =defs.append(<span class="hljs-string">&apos;g&apos;</span>)
      .attr(<span class="hljs-string">&apos;id&apos;</span>,<span class="hljs-string">&apos;database&apos;</span>)
    .attr(<span class="hljs-string">&apos;transform&apos;</span>,<span class="hljs-string">&apos;scale(0.042)&apos;</span>);

    database.append(<span class="hljs-string">&apos;path&apos;</span>)
    .attr(<span class="hljs-string">&apos;d&apos;</span>,<span class="hljs-string">&apos;M512 800c-247.42 0-448-71.63-448-160v160c0 88.37 200.58 160 448 160s448-71.63 448-160V640c0 88.37-200.58 160-448 160z&apos;</span>)

    database.append(<span class="hljs-string">&apos;path&apos;</span>)
    .attr(<span class="hljs-string">&apos;d&apos;</span>,<span class="hljs-string">&apos;M512 608c-247.42 0-448-71.63-448-160v160c0 88.37 200.58 160 448 160s448-71.63 448-160V448c0 88.37-200.58 160-448 160z&apos;</span>) ;

    database.append(<span class="hljs-string">&apos;path&apos;</span>)
    .attr(<span class="hljs-string">&apos;d&apos;</span>,<span class="hljs-string">&apos;M512 416c-247.42 0-448-71.63-448-160v160c0 88.37 200.58 160 448 160s448-71.63 448-160V256c0 88.37-200.58 160-448 160z&apos;</span>) ;

    database.append(<span class="hljs-string">&apos;path&apos;</span>)
    .attr(<span class="hljs-string">&apos;d&apos;</span>,<span class="hljs-string">&apos;M64 224a448 160 0 1 0 896 0 448 160 0 1 0-896 0Z&apos;</span>);

    <span class="hljs-comment">//&#x4E91;</span>
    <span class="hljs-keyword">let</span> cloud=defs.append(<span class="hljs-string">&apos;g&apos;</span>)
    .attr(<span class="hljs-string">&apos;id&apos;</span>,<span class="hljs-string">&apos;cloud&apos;</span>)
    .attr(<span class="hljs-string">&apos;transform&apos;</span>,<span class="hljs-string">&apos;scale(0.042)&apos;</span>)
    .append(<span class="hljs-string">&apos;path&apos;</span>)
    .attr(<span class="hljs-string">&apos;d&apos;</span>,<span class="hljs-string">&apos;M709.3 285.8C668.3 202.7 583 145.4 484 145.4c-132.6 0-241 102.8-250.4 233-97.5 27.8-168.5 113-168.5 213.8 0 118.9 98.8 216.6 223.4 223.4h418.9c138.7 0 251.3-118.8 251.3-265.3 0-141.2-110.3-256.2-249.4-264.5z&apos;</span>)



  }

  <span class="hljs-comment">//&#x521D;&#x59CB;&#x5316;&#x94FE;&#x63A5;&#x7EBF;</span>
  initLink() {
    <span class="hljs-keyword">this</span>.drawLinkLine();
    <span class="hljs-keyword">this</span>.drawLinkText();
  }

  <span class="hljs-comment">//&#x521D;&#x59CB;&#x5316;&#x8282;&#x70B9;</span>
  initNode() {
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-comment">//&#x8282;&#x70B9;&#x5BB9;&#x5668;</span>
    <span class="hljs-keyword">this</span>.nodes = <span class="hljs-keyword">this</span>.container.selectAll(<span class="hljs-string">&quot;.node&quot;</span>)
    .data(<span class="hljs-keyword">this</span>.data)
    .enter()
    .append(<span class="hljs-string">&quot;g&quot;</span>)
    .attr(<span class="hljs-string">&quot;transform&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;translate(&quot;</span> + d.x + <span class="hljs-string">&quot;,&quot;</span> + d.y + <span class="hljs-string">&quot;)&quot;</span>;
    })
    .call(d3.drag()
      .on(<span class="hljs-string">&quot;drag&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{
        self.onDrag(<span class="hljs-keyword">this</span>, d)
      })
    )
    .on(<span class="hljs-string">&apos;click&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      alert()
    })

    <span class="hljs-comment">//&#x8282;&#x70B9;&#x80CC;&#x666F;&#x9ED8;&#x8BA4;&#x8986;&#x76D6;&#x5C42;</span>
    <span class="hljs-keyword">this</span>.nodes.append(<span class="hljs-string">&apos;circle&apos;</span>)
    .attr(<span class="hljs-string">&apos;r&apos;</span>, symbolSize / <span class="hljs-number">2</span> + padding)
    .attr(<span class="hljs-string">&apos;class&apos;</span>, <span class="hljs-string">&apos;node-bg&apos;</span>);

    <span class="hljs-comment">//&#x8282;&#x70B9;&#x56FE;&#x6807;</span>
    <span class="hljs-keyword">this</span>.drawNodeSymbol();
    <span class="hljs-comment">//&#x8282;&#x70B9;&#x6807;&#x9898;</span>
    <span class="hljs-keyword">this</span>.drawNodeTitle();
    <span class="hljs-comment">//&#x8282;&#x70B9;&#x5176;&#x4ED6;&#x8BF4;&#x660E;</span>
    <span class="hljs-keyword">this</span>.drawNodeOther();
    <span class="hljs-keyword">this</span>.drawNodeCode();

  }

  <span class="hljs-comment">//&#x753B;&#x8282;&#x70B9;&#x8BED;&#x8A00;&#x6807;&#x8BC6;</span>
  drawNodeCode() {
    <span class="hljs-keyword">this</span>.nodeCodes = <span class="hljs-keyword">this</span>.nodes.filter(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.type == <span class="hljs-string">&apos;app&apos;</span>)
    .append(<span class="hljs-string">&apos;g&apos;</span>)
    .attr(<span class="hljs-string">&apos;class&apos;</span>,<span class="hljs-string">&apos;node-code&apos;</span>)
    .attr(<span class="hljs-string">&apos;transform&apos;</span>, <span class="hljs-string">&apos;translate(&apos;</span> + -symbolSize / <span class="hljs-number">2</span> + <span class="hljs-string">&apos;,&apos;</span> + symbolSize / <span class="hljs-number">3</span> + <span class="hljs-string">&apos;)&apos;</span>)

    <span class="hljs-keyword">this</span>.nodeCodes
    .append(<span class="hljs-string">&apos;circle&apos;</span>)
    .attr(<span class="hljs-string">&apos;r&apos;</span>, <span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> fontSize / <span class="hljs-number">2</span> * d.code.length / <span class="hljs-number">2</span> + <span class="hljs-number">3</span>)

    <span class="hljs-keyword">this</span>.nodeCodes
    .append(<span class="hljs-string">&apos;text&apos;</span>)
    .attr(<span class="hljs-string">&apos;dy&apos;</span>, fontSize / <span class="hljs-number">2</span>)
    .text(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.code);

  }

  <span class="hljs-comment">//&#x753B;&#x8282;&#x70B9;&#x56FE;&#x6807;</span>
  drawNodeSymbol() {
    <span class="hljs-comment">//&#x7ED8;&#x5236;&#x8282;&#x70B9;</span>
    <span class="hljs-keyword">this</span>.nodes.filter(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>item.type==<span class="hljs-string">&apos;app&apos;</span>)
    .append(<span class="hljs-string">&quot;circle&quot;</span>)
    .attr(<span class="hljs-string">&quot;r&quot;</span>, symbolSize / <span class="hljs-number">2</span>)
    .attr(<span class="hljs-string">&quot;fill&quot;</span>, <span class="hljs-string">&apos;#fff&apos;</span>)
    .attr(<span class="hljs-string">&apos;class&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-string">&apos;health&apos;</span>+d.health;
    })
    .attr(<span class="hljs-string">&apos;stroke-width&apos;</span>, <span class="hljs-string">&apos;5px&apos;</span>)


    <span class="hljs-keyword">this</span>.nodes.filter(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>item.type==<span class="hljs-string">&apos;database&apos;</span>)
    .append(<span class="hljs-string">&apos;use&apos;</span>)
    .attr(<span class="hljs-string">&apos;xlink:href&apos;</span>,<span class="hljs-string">&apos;#database&apos;</span>)
    .attr(<span class="hljs-string">&apos;x&apos;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> -<span class="hljs-keyword">this</span>.getBBox().width/<span class="hljs-number">2</span>
    })
    .attr(<span class="hljs-string">&apos;y&apos;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> -<span class="hljs-keyword">this</span>.getBBox().height/<span class="hljs-number">2</span>
    })

    <span class="hljs-keyword">this</span>.nodes.filter(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>item.type==<span class="hljs-string">&apos;cloud&apos;</span>)
    .append(<span class="hljs-string">&apos;use&apos;</span>)
    .attr(<span class="hljs-string">&apos;xlink:href&apos;</span>,<span class="hljs-string">&apos;#cloud&apos;</span>)
    .attr(<span class="hljs-string">&apos;x&apos;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> -<span class="hljs-keyword">this</span>.getBBox().width/<span class="hljs-number">2</span>
    })
    .attr(<span class="hljs-string">&apos;y&apos;</span>,<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> -<span class="hljs-keyword">this</span>.getBBox().height/<span class="hljs-number">2</span>
    })
  }

  <span class="hljs-comment">//&#x753B;&#x8282;&#x70B9;&#x53F3;&#x4FA7;&#x4FE1;&#x606F;</span>
  drawNodeOther() {
    <span class="hljs-comment">//&#x5982;&#x679C;&#x662F;&#x5E94;&#x7528;&#x7684;&#x65F6;&#x5019;</span>
    <span class="hljs-keyword">this</span>.nodeOthers = <span class="hljs-keyword">this</span>.nodes.filter(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.type == <span class="hljs-string">&apos;app&apos;</span>)
    .append(<span class="hljs-string">&quot;text&quot;</span>)
    .attr(<span class="hljs-string">&quot;x&quot;</span>, symbolSize / <span class="hljs-number">2</span> + padding)
    .attr(<span class="hljs-string">&quot;y&quot;</span>, <span class="hljs-number">-5</span>)
    .attr(<span class="hljs-string">&apos;class&apos;</span>,<span class="hljs-string">&apos;node-other&apos;</span>)

    <span class="hljs-keyword">this</span>.nodeOthers.append(<span class="hljs-string">&apos;tspan&apos;</span>)
    .text(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.time + <span class="hljs-string">&apos;ms&apos;</span>);

    <span class="hljs-keyword">this</span>.nodeOthers.append(<span class="hljs-string">&apos;tspan&apos;</span>)
    .text(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.rpm + <span class="hljs-string">&apos;rpm&apos;</span>)
    .attr(<span class="hljs-string">&apos;x&apos;</span>, symbolSize / <span class="hljs-number">2</span> + padding)
    .attr(<span class="hljs-string">&apos;dy&apos;</span>, <span class="hljs-string">&apos;1em&apos;</span>);

    <span class="hljs-keyword">this</span>.nodeOthers.append(<span class="hljs-string">&apos;tspan&apos;</span>)
    .text(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> d.epm + <span class="hljs-string">&apos;epm&apos;</span>)
    .attr(<span class="hljs-string">&apos;x&apos;</span>, symbolSize / <span class="hljs-number">2</span> + padding)
    .attr(<span class="hljs-string">&apos;dy&apos;</span>, <span class="hljs-string">&apos;1em&apos;</span>)
  }

  <span class="hljs-comment">//&#x753B;&#x8282;&#x70B9;&#x6807;&#x9898;</span>
  drawNodeTitle() {
    <span class="hljs-comment">//&#x8282;&#x70B9;&#x6807;&#x9898;</span>
    <span class="hljs-keyword">this</span>.nodes.append(<span class="hljs-string">&quot;text&quot;</span>)
    .attr(<span class="hljs-string">&apos;class&apos;</span>,<span class="hljs-string">&apos;node-title&apos;</span>)
    .text(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{
      <span class="hljs-keyword">return</span> d.name;
    })
    .attr(<span class="hljs-string">&quot;dy&quot;</span>, symbolSize)

    <span class="hljs-keyword">this</span>.nodes.filter(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.type == <span class="hljs-string">&apos;app&apos;</span>).append(<span class="hljs-string">&quot;text&quot;</span>)
    .text(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>{
      <span class="hljs-keyword">return</span> d.active + <span class="hljs-string">&apos;/&apos;</span> + d.total;
    })
    .attr(<span class="hljs-string">&apos;dy&apos;</span>, fontSize / <span class="hljs-number">2</span>)
    .attr(<span class="hljs-string">&apos;class&apos;</span>,<span class="hljs-string">&apos;node-call&apos;</span>)

  }

  <span class="hljs-comment">//&#x753B;&#x8282;&#x70B9;&#x94FE;&#x63A5;&#x7EBF;</span>
  drawLinkLine() {
    <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">this</span>.data;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.lineGroup) {
      <span class="hljs-keyword">this</span>.lineGroup.selectAll(<span class="hljs-string">&apos;.link&apos;</span>)
      .attr(
        <span class="hljs-string">&apos;d&apos;</span>, <span class="hljs-function"><span class="hljs-params">link</span> =&gt;</span> genLinkPath(link),
      )
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.lineGroup = <span class="hljs-keyword">this</span>.container.append(<span class="hljs-string">&apos;g&apos;</span>)


      <span class="hljs-keyword">this</span>.lineGroup.selectAll(<span class="hljs-string">&apos;.link&apos;</span>)
      .data(<span class="hljs-keyword">this</span>.edges)
      .enter()
      .append(<span class="hljs-string">&apos;path&apos;</span>)
      .attr(<span class="hljs-string">&apos;class&apos;</span>, <span class="hljs-string">&apos;link&apos;</span>)
      .attr(
        <span class="hljs-string">&apos;marker-end&apos;</span>, <span class="hljs-function">(<span class="hljs-params">link, i</span>) =&gt;</span> <span class="hljs-string">&apos;url(#&apos;</span> + <span class="hljs-string">&apos;marker-&apos;</span> + i + <span class="hljs-string">&apos;)&apos;</span>
      ).attr(
        <span class="hljs-string">&apos;d&apos;</span>, <span class="hljs-function"><span class="hljs-params">link</span> =&gt;</span> genLinkPath(link),
      ).attr(
        <span class="hljs-string">&apos;id&apos;</span>, <span class="hljs-function">(<span class="hljs-params">link, i</span>) =&gt;</span> <span class="hljs-string">&apos;link-&apos;</span> + i
      )
      .on(<span class="hljs-string">&apos;click&apos;</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> { alert() })
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">genLinkPath</span>(<span class="hljs-params">d</span>) </span>{
      <span class="hljs-keyword">let</span> sx = data[d.source].x;
      <span class="hljs-keyword">let</span> tx = data[d.target].x;
      <span class="hljs-keyword">let</span> sy = data[d.source].y;
      <span class="hljs-keyword">let</span> ty = data[d.target].y;
      <span class="hljs-keyword">return</span> <span class="hljs-string">&apos;M&apos;</span> + sx + <span class="hljs-string">&apos;,&apos;</span> + sy + <span class="hljs-string">&apos; L&apos;</span> + tx + <span class="hljs-string">&apos;,&apos;</span> + ty;
    }
  }


  drawLinkText() {
    <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">this</span>.data;
    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.lineTextGroup) {
      <span class="hljs-keyword">this</span>.lineTexts
      .attr(<span class="hljs-string">&apos;transform&apos;</span>, getTransform)

    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.lineTextGroup = <span class="hljs-keyword">this</span>.container.append(<span class="hljs-string">&apos;g&apos;</span>)

      <span class="hljs-keyword">this</span>.lineTexts = <span class="hljs-keyword">this</span>.lineTextGroup
      .selectAll(<span class="hljs-string">&apos;.linetext&apos;</span>)
      .data(<span class="hljs-keyword">this</span>.edges)
      .enter()
      .append(<span class="hljs-string">&apos;text&apos;</span>)
      .attr(<span class="hljs-string">&apos;dy&apos;</span>, <span class="hljs-number">-2</span>)
      .attr(<span class="hljs-string">&apos;transform&apos;</span>, getTransform)
      .on(<span class="hljs-string">&apos;click&apos;</span>, <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> { alert() })

      <span class="hljs-keyword">this</span>.lineTexts
      .append(<span class="hljs-string">&apos;tspan&apos;</span>)
      .text(<span class="hljs-function">(<span class="hljs-params">d, i</span>) =&gt;</span> <span class="hljs-keyword">this</span>.data[d.source].lineTime + <span class="hljs-string">&apos;ms,&apos;</span> + <span class="hljs-keyword">this</span>.data[d.source].lineRpm + <span class="hljs-string">&apos;rpm&apos;</span>);

      <span class="hljs-keyword">this</span>.lineTexts
      .append(<span class="hljs-string">&apos;tspan&apos;</span>)
      .text(<span class="hljs-function">(<span class="hljs-params">d, i</span>) =&gt;</span> <span class="hljs-keyword">this</span>.data[d.source].lineProtocol)
      .attr(<span class="hljs-string">&apos;dy&apos;</span>, <span class="hljs-string">&apos;1em&apos;</span>)
      .attr(<span class="hljs-string">&apos;dx&apos;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">return</span> -<span class="hljs-keyword">this</span>.getBBox().width / <span class="hljs-number">2</span>
      })
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTransform</span>(<span class="hljs-params">link</span>) </span>{
      <span class="hljs-keyword">let</span> s = data[link.source];
      <span class="hljs-keyword">let</span> t = data[link.target];
      <span class="hljs-keyword">let</span> p = self.getCenter(s.x, s.y, t.x, t.y);
      <span class="hljs-keyword">let</span> angle = self.getAngle(s.x, s.y, t.x, t.y);
      <span class="hljs-keyword">if</span> (s.x &gt; t.x &amp;&amp; s.y &lt; t.y || s.x &lt; t.x &amp;&amp; s.y &gt; t.y) {
        angle = -angle
      }
      <span class="hljs-keyword">return</span> <span class="hljs-string">&apos;translate(&apos;</span> + p[<span class="hljs-number">0</span>] + <span class="hljs-string">&apos;,&apos;</span> + p[<span class="hljs-number">1</span>] + <span class="hljs-string">&apos;) rotate(&apos;</span> + angle + <span class="hljs-string">&apos;)&apos;</span>
    }
  }


  update(d) {
    <span class="hljs-keyword">this</span>.drawLinkLine();
    <span class="hljs-keyword">this</span>.drawLinkText();
  }

  <span class="hljs-comment">//&#x62D6;&#x62FD;&#x65B9;&#x6CD5;</span>
  onDrag(ele, d) {
    d.x = d3.event.x;
    d.y = d3.event.y;
    d3.select(ele)
    .attr(<span class="hljs-string">&apos;transform&apos;</span>, <span class="hljs-string">&quot;translate(&quot;</span> + d3.event.x + <span class="hljs-string">&quot;,&quot;</span> + d3.event.y + <span class="hljs-string">&quot;)&quot;</span>)
    <span class="hljs-keyword">this</span>.update(d);
  }

  <span class="hljs-comment">//&#x7F29;&#x653E;&#x65B9;&#x6CD5;</span>
  onZoom(ele) {
    <span class="hljs-keyword">var</span> transform = d3.zoomTransform(ele);
    <span class="hljs-keyword">this</span>.scale = transform.k;
    <span class="hljs-keyword">this</span>.container.attr(<span class="hljs-string">&apos;transform&apos;</span>, <span class="hljs-string">&quot;translate(&quot;</span> + transform.x + <span class="hljs-string">&quot;,&quot;</span> + transform.y + <span class="hljs-string">&quot;)scale(&quot;</span> + transform.k + <span class="hljs-string">&quot;)&quot;</span>)
  }

}</code></pre><p>&#x6570;&#x636E;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="let __options={
  data:[{
    type:&apos;app&apos;,
    name: &apos;monitor-web-server&apos;,
    time: 30,
    rpm: 40,
    epm: 50,
    active: 3,
    total: 5,
    code: &apos;java&apos;,
    health: 1,
    lineProtocol: &apos;http&apos;,
    lineTime: 12,
    lineRpm: 34,
  }, {
    type:&apos;database&apos;,
    name: &apos;Mysql&apos;,
    time: 30,
    rpm: 40,
    epm: 50,
    active: 3,
    total: 5,
    code: &apos;java&apos;,
    health: 2,
    lineProtocol: &apos;http&apos;,
    lineTime: 12,
    lineRpm: 34,

  },
    {
      type:&apos;app&apos;,
      name: &apos;Redis&apos;,
      time: 30,
      rpm: 40,
      epm: 50,
      active: 3,
      total: 5,
      code: &apos;java&apos;,
      health: 3,
      lineProtocol: &apos;http&apos;,
      lineTime: 12,
      lineRpm: 34,

    }, {
      type:&apos;cloud&apos;,
      name: &apos;ES&apos;,
      time: 30,
      rpm: 40,
      epm: 50,
      active: 3,
      total: 5,
      code: &apos;java&apos;,
      health: 1,
      lineProtocol: &apos;http&apos;,
      lineTime: 12,
      lineRpm: 34,
      value: 100
    }
  ],
  edges: [
     {
      source: 0,
      target: 3,
    }, {
      source: 1,
      target: 2,
    }
    , {
      source: 1,
      target: 3,
    },
    {
      source: 0,
      target: 1,
    },
    {
      source: 0,
      target: 2,
    }
    // {
    //   source: 3,
    //   target: 2,
    // },
  ]
}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs yaml"><code><span class="hljs-string">let</span> <span class="hljs-string">__options={</span>
<span class="hljs-attr">  data:</span><span class="hljs-string">[{</span>
<span class="hljs-attr">    type:</span><span class="hljs-string">&apos;app&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">    name:</span> <span class="hljs-string">&apos;monitor-web-server&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">    time:</span> <span class="hljs-number">30</span><span class="hljs-string">,</span>
<span class="hljs-attr">    rpm:</span> <span class="hljs-number">40</span><span class="hljs-string">,</span>
<span class="hljs-attr">    epm:</span> <span class="hljs-number">50</span><span class="hljs-string">,</span>
<span class="hljs-attr">    active:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span>
<span class="hljs-attr">    total:</span> <span class="hljs-number">5</span><span class="hljs-string">,</span>
<span class="hljs-attr">    code:</span> <span class="hljs-string">&apos;java&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">    health:</span> <span class="hljs-number">1</span><span class="hljs-string">,</span>
<span class="hljs-attr">    lineProtocol:</span> <span class="hljs-string">&apos;http&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">    lineTime:</span> <span class="hljs-number">12</span><span class="hljs-string">,</span>
<span class="hljs-attr">    lineRpm:</span> <span class="hljs-number">34</span><span class="hljs-string">,</span>
  <span class="hljs-string">},</span> <span class="hljs-string">{</span>
<span class="hljs-attr">    type:</span><span class="hljs-string">&apos;database&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">    name:</span> <span class="hljs-string">&apos;Mysql&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">    time:</span> <span class="hljs-number">30</span><span class="hljs-string">,</span>
<span class="hljs-attr">    rpm:</span> <span class="hljs-number">40</span><span class="hljs-string">,</span>
<span class="hljs-attr">    epm:</span> <span class="hljs-number">50</span><span class="hljs-string">,</span>
<span class="hljs-attr">    active:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span>
<span class="hljs-attr">    total:</span> <span class="hljs-number">5</span><span class="hljs-string">,</span>
<span class="hljs-attr">    code:</span> <span class="hljs-string">&apos;java&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">    health:</span> <span class="hljs-number">2</span><span class="hljs-string">,</span>
<span class="hljs-attr">    lineProtocol:</span> <span class="hljs-string">&apos;http&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">    lineTime:</span> <span class="hljs-number">12</span><span class="hljs-string">,</span>
<span class="hljs-attr">    lineRpm:</span> <span class="hljs-number">34</span><span class="hljs-string">,</span>

  <span class="hljs-string">},</span>
    <span class="hljs-string">{</span>
<span class="hljs-attr">      type:</span><span class="hljs-string">&apos;app&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">      name:</span> <span class="hljs-string">&apos;Redis&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">      time:</span> <span class="hljs-number">30</span><span class="hljs-string">,</span>
<span class="hljs-attr">      rpm:</span> <span class="hljs-number">40</span><span class="hljs-string">,</span>
<span class="hljs-attr">      epm:</span> <span class="hljs-number">50</span><span class="hljs-string">,</span>
<span class="hljs-attr">      active:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span>
<span class="hljs-attr">      total:</span> <span class="hljs-number">5</span><span class="hljs-string">,</span>
<span class="hljs-attr">      code:</span> <span class="hljs-string">&apos;java&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">      health:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span>
<span class="hljs-attr">      lineProtocol:</span> <span class="hljs-string">&apos;http&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">      lineTime:</span> <span class="hljs-number">12</span><span class="hljs-string">,</span>
<span class="hljs-attr">      lineRpm:</span> <span class="hljs-number">34</span><span class="hljs-string">,</span>

    <span class="hljs-string">},</span> <span class="hljs-string">{</span>
<span class="hljs-attr">      type:</span><span class="hljs-string">&apos;cloud&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">      name:</span> <span class="hljs-string">&apos;ES&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">      time:</span> <span class="hljs-number">30</span><span class="hljs-string">,</span>
<span class="hljs-attr">      rpm:</span> <span class="hljs-number">40</span><span class="hljs-string">,</span>
<span class="hljs-attr">      epm:</span> <span class="hljs-number">50</span><span class="hljs-string">,</span>
<span class="hljs-attr">      active:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span>
<span class="hljs-attr">      total:</span> <span class="hljs-number">5</span><span class="hljs-string">,</span>
<span class="hljs-attr">      code:</span> <span class="hljs-string">&apos;java&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">      health:</span> <span class="hljs-number">1</span><span class="hljs-string">,</span>
<span class="hljs-attr">      lineProtocol:</span> <span class="hljs-string">&apos;http&apos;</span><span class="hljs-string">,</span>
<span class="hljs-attr">      lineTime:</span> <span class="hljs-number">12</span><span class="hljs-string">,</span>
<span class="hljs-attr">      lineRpm:</span> <span class="hljs-number">34</span><span class="hljs-string">,</span>
<span class="hljs-attr">      value:</span> <span class="hljs-number">100</span>
    <span class="hljs-string">}</span>
  <span class="hljs-string">],</span>
<span class="hljs-attr">  edges:</span> <span class="hljs-string">[</span>
     <span class="hljs-string">{</span>
<span class="hljs-attr">      source:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span>
<span class="hljs-attr">      target:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span>
    <span class="hljs-string">},</span> <span class="hljs-string">{</span>
<span class="hljs-attr">      source:</span> <span class="hljs-number">1</span><span class="hljs-string">,</span>
<span class="hljs-attr">      target:</span> <span class="hljs-number">2</span><span class="hljs-string">,</span>
    <span class="hljs-string">}</span>
    <span class="hljs-string">,</span> <span class="hljs-string">{</span>
<span class="hljs-attr">      source:</span> <span class="hljs-number">1</span><span class="hljs-string">,</span>
<span class="hljs-attr">      target:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span>
    <span class="hljs-string">},</span>
    <span class="hljs-string">{</span>
<span class="hljs-attr">      source:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span>
<span class="hljs-attr">      target:</span> <span class="hljs-number">1</span><span class="hljs-string">,</span>
    <span class="hljs-string">},</span>
    <span class="hljs-string">{</span>
<span class="hljs-attr">      source:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span>
<span class="hljs-attr">      target:</span> <span class="hljs-number">2</span><span class="hljs-string">,</span>
    <span class="hljs-string">}</span>
    <span class="hljs-string">//</span> <span class="hljs-string">{</span>
    <span class="hljs-string">//</span>   <span class="hljs-attr">source:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span>
    <span class="hljs-string">//</span>   <span class="hljs-attr">target:</span> <span class="hljs-number">2</span><span class="hljs-string">,</span>
    <span class="hljs-string">//</span> <span class="hljs-string">},</span>
  <span class="hljs-string">]</span>
<span class="hljs-string">}</span></code></pre>
{{< /raw >}}

# 版权声明
本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，

本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。

原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！

## 原文标题
D3.js实现拓扑图

## 原文链接
[https://segmentfault.com/a/1190000015435525](https://segmentfault.com/a/1190000015435525)

