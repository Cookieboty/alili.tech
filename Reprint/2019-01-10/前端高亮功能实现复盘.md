---
title: '前端高亮功能实现复盘' 
date: 2019-01-10 2:30:08
hidden: true
slug: c37g4uz3oks
categories: [reprint]
---

{{< raw >}}

                    
<h1 id="articleHeader0">前端高亮功能实现复盘</h1>
<p>“高亮”功能，个人觉得没必要再解释什么了。作为一名程序猿，天天都会接触高亮：写代码时的语法高亮；使用搜索引擎时的搜索结果高亮。作为一名前端，如果你做过与搜索相关的功能，那么你很有可能就实现过高亮，本文也主要从前端的角度复盘一下“高亮”功能实现的关键知识点。</p>
<p><span class="img-wrap"><img data-src="/img/remote/1460000009956576?w=857&amp;h=526" src="https://static.alili.tech/img/remote/1460000009956576?w=857&amp;h=526" alt="高亮" title="高亮" style="cursor: pointer; display: inline;"></span></p>
<h3 id="articleHeader1">高亮实现思路</h3>
<p><span class="img-wrap"><img data-src="/img/remote/1460000009956577?w=569&amp;h=415" src="https://static.alili.tech/img/remote/1460000009956577?w=569&amp;h=415" alt="高亮原理" title="高亮原理" style="cursor: pointer;"></span></p>
<p>对用户的输入进行分词得到关键词，根据关键词搜索得到搜索结果。再次使用关键词从搜索结果中找到匹配，对匹配加上高亮样式，即完成高亮。细分这个过程，会有以下细节点：</p>
<ul>
<li><p>对用户输入分词得到关键词</p></li>
<li><p>根据关键词得到搜索结果</p></li>
<li><p>关键词匹配</p></li>
<li><p>对匹配使用高亮样式</p></li>
</ul>
<p>前两步一般在后台完成，后两步才是我们前端的工作，下面通过具体例子来实际演练一下。</p>
<h3 id="articleHeader2">普通文本高亮</h3>
<p>比如我们有这样的文本：“我是中国人，我爱中华人民共和国，中华人民共和国万岁！”，这时我们的关键词是“我”，即要高亮文本中所有的我。代码实现完整如下：</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="<!DOCTYPE html>
<html lang=&quot;en&quot;>
<head>
  <meta charset=&quot;UTF-8&quot;>
  <title>普通文本高亮</title>
  <style>
    .keyword-match {
      color: red;
    }
  </style>
</head>
<body>
<div>
  原文本：我是中国人，我爱中华人民共和国，中华人民共和国万岁！<br />
  关键词: 我 <br />
  结果如下：<br /><br />
</div>
<div id=&quot;content&quot;></div>

<script>
  const content = document.getElementById('content');
  const text = '我是中国人，我爱中华人民共和国，中华人民共和国万岁！';
  const keyword = '我';

  // 根据关键词，对匹配加上高亮样式
  let hightlightText = text.replace(new RegExp(`(${keyword})`, 'g'), `<span class=&quot;keyword-match&quot;>$1</span>`);

  // 通过innerHTML写入匹配后的内容
  content.innerHTML = hightlightText;
</script>
</body>
</html>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs xml"><code><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>普通文本高亮<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-class">.keyword-match</span> {
      <span class="hljs-attribute">color</span>: red;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  原文本：我是中国人，我爱中华人民共和国，中华人民共和国万岁！<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
  关键词: 我 <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
  结果如下：<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"content"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> content = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'content'</span>);
  <span class="hljs-keyword">const</span> text = <span class="hljs-string">'我是中国人，我爱中华人民共和国，中华人民共和国万岁！'</span>;
  <span class="hljs-keyword">const</span> keyword = <span class="hljs-string">'我'</span>;

  <span class="hljs-comment">// 根据关键词，对匹配加上高亮样式</span>
  <span class="hljs-keyword">let</span> hightlightText = text.replace(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">`(<span class="hljs-subst">${keyword}</span>)`</span>, <span class="hljs-string">'g'</span>), <span class="hljs-string">`&lt;span class="keyword-match"&gt;$1&lt;/span&gt;`</span>);

  <span class="hljs-comment">// 通过innerHTML写入匹配后的内容</span>
  content.innerHTML = hightlightText;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre>
<p>上面的demo运行效果如下</p>
<p><span class="img-wrap"><img data-src="/img/remote/1460000009956578?w=526&amp;h=126" src="https://static.alili.tech/img/remote/1460000009956578?w=526&amp;h=126" alt="普通文本高亮" title="普通文本高亮" style="cursor: pointer;"></span></p>
<p>上面的例子虽然很简单，但已经完整实现了高亮功能，说明了高亮的实现原理。在实际应用中，我们的关键词多半不会是一个简简单单的“我”，而是一个List，下面我们将关键词改成：我，中华。只需稍加修改，就可以实现同时对“我”，“中华”两个关键词高亮</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="<body>
<div>
  原文本：我是中国人，我爱中华人民共和国，中华人民共和国万岁！<br />
  关键词: 我，中华 <br />
  结果如下：<br /><br />
</div>
<div id=&quot;content&quot;></div>

<script>
  const content = document.getElementById('content');
  const text = '我是中国人，我爱中华人民共和国，中华人民共和国万岁！';
  const keyword = ['我', '中华']; // 关键词是一个数组

  // new RegExp(`(${keyword})` 改成 new RegExp(`(${keyword.join('|')})`
  let hightlightText = text.replace(new RegExp(`(${keyword.join('|')})`, 'g'), `<span class=&quot;keyword-match&quot;>$1</span>`);

  // 通过innerHTML写入匹配后的内容
  content.innerHTML = hightlightText;
</script>
</body>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs xml"><code><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  原文本：我是中国人，我爱中华人民共和国，中华人民共和国万岁！<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
  关键词: 我，中华 <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
  结果如下：<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"content"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> content = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'content'</span>);
  <span class="hljs-keyword">const</span> text = <span class="hljs-string">'我是中国人，我爱中华人民共和国，中华人民共和国万岁！'</span>;
  <span class="hljs-keyword">const</span> keyword = [<span class="hljs-string">'我'</span>, <span class="hljs-string">'中华'</span>]; <span class="hljs-comment">// 关键词是一个数组</span>

  <span class="hljs-comment">// new RegExp(`(${keyword})` 改成 new RegExp(`(${keyword.join('|')})`</span>
  <span class="hljs-keyword">let</span> hightlightText = text.replace(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">`(<span class="hljs-subst">${keyword.join(<span class="hljs-string">'|'</span>)}</span>)`</span>, <span class="hljs-string">'g'</span>), <span class="hljs-string">`&lt;span class="keyword-match"&gt;$1&lt;/span&gt;`</span>);

  <span class="hljs-comment">// 通过innerHTML写入匹配后的内容</span>
  content.innerHTML = hightlightText;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></code></pre>
<p>运行效果：</p>
<p><span class="img-wrap"><img data-src="/img/remote/1460000009956579?w=502&amp;h=123" src="https://static.alili.tech/img/remote/1460000009956579?w=502&amp;h=123" alt="普通文本高亮" title="普通文本高亮" style="cursor: pointer; display: inline;"></span></p>
<p>上面的代码似乎已经完美了。但如果我们将关键词改成：我，中华，中华人民共和国。再次运行看结果，会发现“中华人民共和国”这个关键词没有被高亮，而“中华”高亮了，但这并不是我们想要的结果。</p>
<p>注意：<strong>如果一个关键词包含另一个关键词，要优先高亮长度较长的词才对</strong>。要修复这个Bug也很简单，只需要将字数多的关键词放到关键词数组的最前面即可</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="<body>
<div>
  原文本：我是中国人，我爱中华人民共和国，中华人民共和国万岁！<br />
  关键词: 我，中华，中华人民共和国 <br />
  结果如下：<br /><br />
</div>
<div id=&quot;content&quot;></div>
<div id=&quot;content2&quot;></div>

<script>
  const content = document.getElementById('content');
  const text = '我是中国人，我爱中华人民共和国，中华人民共和国万岁！';
  const keyword = ['我', '中华', '中华人民共和国']; // 关键词是一个数组

  let hightlightText = text.replace(new RegExp(`(${keyword.join('|')})`, 'g'), `<span class=&quot;keyword-match&quot;>$1</span>`);

  // 通过innerHTML写入匹配后的内容
  content.innerHTML = hightlightText;
</script>

<script>
  const content2 = document.getElementById('content2');
  const text2 = '我是中国人，我爱中华人民共和国，中华人民共和国万岁！';
  const keyword2 = ['中华人民共和国', '中华', '我']; // 将字数多的关键词放到前面，保证字数多的关键词优先匹配

  let hightlightText2 = text.replace(new RegExp(`(${keyword2.join('|')})`, 'g'), `<span class=&quot;keyword-match&quot;>$1</span>`);

  content2.innerHTML = hightlightText2;
</script>
</body>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs xml"><code><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
  原文本：我是中国人，我爱中华人民共和国，中华人民共和国万岁！<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
  关键词: 我，中华，中华人民共和国 <span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
  结果如下：<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"content"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"content2"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> content = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'content'</span>);
  <span class="hljs-keyword">const</span> text = <span class="hljs-string">'我是中国人，我爱中华人民共和国，中华人民共和国万岁！'</span>;
  <span class="hljs-keyword">const</span> keyword = [<span class="hljs-string">'我'</span>, <span class="hljs-string">'中华'</span>, <span class="hljs-string">'中华人民共和国'</span>]; <span class="hljs-comment">// 关键词是一个数组</span>

  <span class="hljs-keyword">let</span> hightlightText = text.replace(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">`(<span class="hljs-subst">${keyword.join(<span class="hljs-string">'|'</span>)}</span>)`</span>, <span class="hljs-string">'g'</span>), <span class="hljs-string">`&lt;span class="keyword-match"&gt;$1&lt;/span&gt;`</span>);

  <span class="hljs-comment">// 通过innerHTML写入匹配后的内容</span>
  content.innerHTML = hightlightText;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> content2 = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'content2'</span>);
  <span class="hljs-keyword">const</span> text2 = <span class="hljs-string">'我是中国人，我爱中华人民共和国，中华人民共和国万岁！'</span>;
  <span class="hljs-keyword">const</span> keyword2 = [<span class="hljs-string">'中华人民共和国'</span>, <span class="hljs-string">'中华'</span>, <span class="hljs-string">'我'</span>]; <span class="hljs-comment">// 将字数多的关键词放到前面，保证字数多的关键词优先匹配</span>

  <span class="hljs-keyword">let</span> hightlightText2 = text.replace(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">`(<span class="hljs-subst">${keyword2.join(<span class="hljs-string">'|'</span>)}</span>)`</span>, <span class="hljs-string">'g'</span>), <span class="hljs-string">`&lt;span class="keyword-match"&gt;$1&lt;/span&gt;`</span>);

  content2.innerHTML = hightlightText2;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></code></pre>
<p>效果如下：</p>
<p><span class="img-wrap"><img data-src="/img/remote/1460000009956580?w=496&amp;h=153" src="https://static.alili.tech/img/remote/1460000009956580?w=496&amp;h=153" alt="匹配优先级问题" title="匹配优先级问题" style="cursor: pointer;"></span></p>
<h3 id="articleHeader3">富文本高亮</h3>
<p>说完了普通文本的高亮，我们来说说富文本的高亮。所谓富文本，即待高亮的字符串不再是单独的文本，而是html代码。如果你需要富文本编辑器，可以考虑百度的UEditor，富文本编辑器生成的代码就是可以直接插入到页面的html串。</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="// 普通文本
我是中国人，我爱中华人民共和国，中华人民共和国万岁！

// 富文本,即html串
<div>我是<span style=&quot;font-size: 20px; font-weight: bold; background-color: cyan;&quot;>中国人</span>，我爱中华人民共和国，中华人民共和国万岁！</div>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs dts"><code><span class="hljs-comment">// 普通文本</span>
我是中国人，我爱中华人民共和国，中华人民共和国万岁！

<span class="hljs-comment">// 富文本,即html串</span>
<span class="hljs-params">&lt;div&gt;</span>我是<span class="hljs-params">&lt;span style="font-size: <span class="hljs-number">20</span>px; font-weight: bold; background-color: cyan;"&gt;</span>中国人<span class="hljs-params">&lt;/span&gt;</span>，我爱中华人民共和国，中华人民共和国万岁！<span class="hljs-params">&lt;/div&gt;</span></code></pre>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="<body>
富文本高亮
<br />
<br />

<h3>未高亮</h3>
<div id=&quot;text&quot;>
  <div style=&quot;font-style: italic;&quot;>我是<span style=&quot;font-size: 20px; font-weight: bold; background-color: cyan;&quot;>中国人</span>，我爱中华人民共和国，中华人民共和国万岁！</div>
</div>

<br />
<h3>高亮效果</h3>
<div id=&quot;content&quot;></div>

<script>
  const content = document.getElementById('content');
  const text = document.getElementById('text').innerHTML; // 富文本串
  const keyword = ['中华人民共和国', '中华', '我'];

  let hightlightText = text.replace(new RegExp(`(${keyword.join('|')})`, 'g'), `<span class=&quot;keyword-match&quot;>$1</span>`);

  content.innerHTML = hightlightText;
</script>

</body>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs xml"><code><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
富文本高亮
<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>未高亮<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"text"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-style: italic;"</span>&gt;</span>我是<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 20px; font-weight: bold; background-color: cyan;"</span>&gt;</span>中国人<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>，我爱中华人民共和国，中华人民共和国万岁！<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>高亮效果<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"content"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> content = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'content'</span>);
  <span class="hljs-keyword">const</span> text = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'text'</span>).innerHTML; <span class="hljs-comment">// 富文本串</span>
  <span class="hljs-keyword">const</span> keyword = [<span class="hljs-string">'中华人民共和国'</span>, <span class="hljs-string">'中华'</span>, <span class="hljs-string">'我'</span>];

  <span class="hljs-keyword">let</span> hightlightText = text.replace(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">`(<span class="hljs-subst">${keyword.join(<span class="hljs-string">'|'</span>)}</span>)`</span>, <span class="hljs-string">'g'</span>), <span class="hljs-string">`&lt;span class="keyword-match"&gt;$1&lt;/span&gt;`</span>);

  content.innerHTML = hightlightText;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></code></pre>
<p><span class="img-wrap"><img data-src="/img/remote/1460000009956581?w=533&amp;h=270" src="https://static.alili.tech/img/remote/1460000009956581?w=533&amp;h=270" alt="富文本高亮" title="富文本高亮" style="cursor: pointer;"></span></p>
<p>这里的高亮实现直接使用了前面普通文本高亮，似乎也能正常工作。但前提是这个富文本串太简单了。我们现在考虑这样一种情况，如果富文本串中的元素属性具有完全匹配关键词的内容，会发生什么呢？</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="// 待高亮富文本串
<div style=&quot;font-style: italic;&quot; data-attr=&quot;中华人民共和国&quot;>我是<span style=&quot;font-size: 20px; font-weight: bold; background-color: cyan;&quot;>中国人</span>，我爱中华人民共和国，中华人民共和国万岁！</div>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs stylus"><code><span class="hljs-comment">// 待高亮富文本串</span>
&lt;<span class="hljs-selector-tag">div</span> style=<span class="hljs-string">"font-style: italic;"</span> data-attr=<span class="hljs-string">"中华人民共和国"</span>&gt;我是&lt;<span class="hljs-selector-tag">span</span> style=<span class="hljs-string">"font-size: 20px; font-weight: bold; background-color: cyan;"</span>&gt;中国人&lt;/span&gt;，我爱中华人民共和国，中华人民共和国万岁！&lt;/div&gt;</code></pre>
<p>对于上面的字符串，直接使用前面的高亮逻辑，得到的字符串是：</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="<div style=&quot;font-style: italic;&quot; data-attr=&quot;<span class=&quot;keyword-match&quot;>中华人民共和国</span>&quot;><span class=&quot;keyword-match&quot;>我</span>是<span style=&quot;font-size: 20px; font-weight: bold; background-color: cyan;&quot;>中国人</span>，<span class=&quot;keyword-match&quot;>我</span>爱<span class=&quot;keyword-match&quot;>中华人民共和国</span>，<span class=&quot;keyword-match&quot;>中华人民共和国</span>万岁！</div>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs xml"><code style="word-break: break-word; white-space: initial;"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-style: italic;"</span> <span class="hljs-attr">data-attr</span>=<span class="hljs-string">"&lt;span class="</span><span class="hljs-attr">keyword-match</span>"&gt;</span>中华人民共和国<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>"&gt;<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"keyword-match"</span>&gt;</span>我<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>是<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 20px; font-weight: bold; background-color: cyan;"</span>&gt;</span>中国人<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>，<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"keyword-match"</span>&gt;</span>我<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>爱<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"keyword-match"</span>&gt;</span>中华人民共和国<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>，<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"keyword-match"</span>&gt;</span>中华人民共和国<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>万岁！<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></code></pre>
<p>显然，第一个div属性中的“中华人民共和国”不应该被匹配到。如果直接匹配会破坏原来的富文本串，使之不再是一个有效的html串。这是富文本高亮的最大难题，那这个难题怎么解决呢？</p>
<p>当然，第一反应可能就是改正则。但根据个人经验，<strong>对于一个模式内包含自己时，正则几乎无能为力</strong>。比如下面我们常见的字符串结构：</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="// 这是常见的less语法。现在如果要求使用正则将最未的选择器名称加上“$”，大家可以试一下，能否做到
// 原串
@media (max-width: 600px) {
  .header {
    .hd {
      width: 100px;
    }

    .bd {
      background-color: #fff;
    }
  }
}

// 要求结果
@media (max-width: 600px) {
  .header {
    .hd$ { // 加上$
      width: 100px;
    }

    .bd$ {
      background-color: #fff;
    }
  }
}
" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs stylus"><code><span class="hljs-comment">// 这是常见的less语法。现在如果要求使用正则将最未的选择器名称加上“$”，大家可以试一下，能否做到</span>
<span class="hljs-comment">// 原串</span>
@media (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">600px</span>) {
  <span class="hljs-selector-class">.header</span> {
    <span class="hljs-selector-class">.hd</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
    }

    <span class="hljs-selector-class">.bd</span> {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
    }
  }
}

<span class="hljs-comment">// 要求结果</span>
@media (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">600px</span>) {
  <span class="hljs-selector-class">.header</span> {
    .hd$ { <span class="hljs-comment">// 加上$</span>
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
    }

    .bd$ {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
    }
  }
}
</code></pre>
<p>对于富文本串，它也可能是模式自包含的字符串类型，比如</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="// 这是一个标准得不能再标准的html串了
<div data-html=&quot;<div>hello world!</div>&quot;>hello world!</div>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs axapta"><code><span class="hljs-comment">// 这是一个标准得不能再标准的html串了</span>
&lt;<span class="hljs-keyword">div</span> data-html=<span class="hljs-string">"&lt;div&gt;hello world!&lt;/div&gt;"</span>&gt;hello world!&lt;/<span class="hljs-keyword">div</span>&gt;</code></pre>
<p>如果要使用正则去匹配上面字符串的hello内容，这个正则应该怎么写？先提醒一下，真正的富文本串要比这复杂太多太多,真实的用户输入也比这复杂太多太多。我当时做富文本高亮时，遇到这个问题也是一时找不到办法。某天，突然灵光一闪，不要硬碰硬啊，曲线救国嘛(这其实应该早就想到，只是走入正则的死胡同了)：如果能够先把富文本串中的html标签去掉，剩下的不就是普通文本了吗？匹配普通文本简直是不要太简单了哦。匹配完成后，再把去掉的html还原，就完成高亮匹配了。不过这里有几个难题：</p>
<ul>
<li><p>如何去掉html标签。别笑，这真心难，不信你试下</p></li>
<li><p>占位符一定要够特殊，不能在关键词匹配时被破坏</p></li>
<li><p>如何还原html串</p></li>
</ul>
<p><span class="img-wrap"><img data-src="/img/remote/1460000009956582?w=561&amp;h=103" src="https://static.alili.tech/img/remote/1460000009956582?w=561&amp;h=103" alt="富文本高亮原理" title="富文本高亮原理" style="cursor: pointer;"></span></p>
<p>根据上面的思路，完成了新一版的高亮逻辑，代码如下：</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="富文本高亮，关键词：['中华人民共和国', '中华', '我'];
<br />

<h3>未高亮</h3>
<div id=&quot;text&quot;>
  <div style=&quot;font-style: italic;&quot; data-attr=&quot;中华人民共和国&quot;>我是<span style=&quot;font-size: 20px; font-weight: bold; background-color: cyan;&quot;>中国人</span>，我爱中华人民共和国，中华人民共和国万岁！</div>
</div>
<h3>高亮效果</h3>
<div id=&quot;content&quot;></div>

<script>
  const content = document.getElementById('content');
  const text = document.getElementById('text').innerHTML; // 富文本串
  const keyword = ['中华人民共和国', '中华', '我'];

  let hightlightText = hightlightKeyword(text, keyword.join('|'));

  content.innerHTML = hightlightText;

  /**
   * 高亮
   * @param input - 待高亮的富文本串
   * @param keyword - 由关键词生成的匹配串，格式 'xxxx|xxx|x'
   * @returns {string}
   */
  function hightlightKeyword(input, keyword) {
    let store = {
      length: 0
    };

    try {
      return input
          .replace(/^\s+/, ' ') // 去掉多余的空白

          // 去掉Html标签，并使用特殊占位符占位，方便后面还原
          .replace(/(<\w+[^>]*?>)|(<\/\w+[^>]*?>)/g, function(match) {
            var key = '\t' + store.length++; // 注意这里使用了\t

            store[key] = match;
            return key;
          })

          // 关键词高亮
          .replace(new RegExp('(' + keyword + ')', 'gi'), '<span class=&quot;keyword-match&quot;>' + '$1' + '</span>')

          // html标签还原
          .replace(/\t\d+/g, function(match) {
            return store[match] || '';
          });
    } catch (e) {
      return input;
    }
  }

</script>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs javascript"><code>富文本高亮，关键词：[<span class="hljs-string">'中华人民共和国'</span>, <span class="hljs-string">'中华'</span>, <span class="hljs-string">'我'</span>];
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>未高亮<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"text"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-style: italic;"</span> <span class="hljs-attr">data-attr</span>=<span class="hljs-string">"中华人民共和国"</span>&gt;</span>我是<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 20px; font-weight: bold; background-color: cyan;"</span>&gt;</span>中国人<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>，我爱中华人民共和国，中华人民共和国万岁！<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>高亮效果<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"content"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> content = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'content'</span>);
  <span class="hljs-keyword">const</span> text = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'text'</span>).innerHTML; <span class="hljs-comment">// 富文本串</span>
  <span class="hljs-keyword">const</span> keyword = [<span class="hljs-string">'中华人民共和国'</span>, <span class="hljs-string">'中华'</span>, <span class="hljs-string">'我'</span>];

  <span class="hljs-keyword">let</span> hightlightText = hightlightKeyword(text, keyword.join(<span class="hljs-string">'|'</span>));

  content.innerHTML = hightlightText;

  <span class="hljs-comment">/**
   * 高亮
   * @param input - 待高亮的富文本串
   * @param keyword - 由关键词生成的匹配串，格式 'xxxx|xxx|x'
   * @returns {string}
   */</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hightlightKeyword</span>(<span class="hljs-params">input, keyword</span>) </span>{
    <span class="hljs-keyword">let</span> store = {
      <span class="hljs-attr">length</span>: <span class="hljs-number">0</span>
    };

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> input
          .replace(<span class="hljs-regexp">/^\s+/</span>, <span class="hljs-string">' '</span>) <span class="hljs-comment">// 去掉多余的空白</span>

          <span class="hljs-comment">// 去掉Html标签，并使用特殊占位符占位，方便后面还原</span>
          .replace(<span class="hljs-regexp">/(&lt;\w+[^&gt;]*?&gt;)|(&lt;\/\w+[^&gt;]*?&gt;)/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">match</span>) </span>{
            <span class="hljs-keyword">var</span> key = <span class="hljs-string">'\t'</span> + store.length++; <span class="hljs-comment">// 注意这里使用了\t</span>

            store[key] = match;
            <span class="hljs-keyword">return</span> key;
          })

          <span class="hljs-comment">// 关键词高亮</span>
          .replace(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'('</span> + keyword + <span class="hljs-string">')'</span>, <span class="hljs-string">'gi'</span>), <span class="hljs-string">'&lt;span class="keyword-match"&gt;'</span> + <span class="hljs-string">'$1'</span> + <span class="hljs-string">'&lt;/span&gt;'</span>)

          <span class="hljs-comment">// html标签还原</span>
          .replace(<span class="hljs-regexp">/\t\d+/g</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">match</span>) </span>{
            <span class="hljs-keyword">return</span> store[match] || <span class="hljs-string">''</span>;
          });
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">return</span> input;
    }
  }

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span></code></pre>
<p>上面的hightlightKeyword函数已经能够满足大多数情况下富文本高亮,博主曾经负责的一个项目，使用这个高亮逻辑安全运行1年多，也没出现大问题。但其实，上面的高亮逻辑还是有bug，对于一些十分特殊的富文本串还是存在问题，比如下面的富文本串</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="<div>
    <div data-html=&quot;<div>hello world!</div>&quot;>
      hello world!
      <div data-html=&quot;<div>hello world!</div>&quot;>hello world!</div>
    </div>
</div>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs applescript"><code>&lt;<span class="hljs-keyword">div</span>&gt;
    &lt;<span class="hljs-keyword">div</span> data-html=<span class="hljs-string">"&lt;div&gt;hello world!&lt;/div&gt;"</span>&gt;
      hello world!
      &lt;<span class="hljs-keyword">div</span> data-html=<span class="hljs-string">"&lt;div&gt;hello world!&lt;/div&gt;"</span>&gt;hello world!&lt;/<span class="hljs-keyword">div</span>&gt;
    &lt;/<span class="hljs-keyword">div</span>&gt;
&lt;/<span class="hljs-keyword">div</span>&gt;</code></pre>
<p>经过多次尝试，碰壁，最后决定借用浏览器来将html转成DOM，通过DOM操作来完成高亮。下面是高亮终极版本</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="<body>
富文本高亮，关键词：['中华人民共和国', '中华', '我'];
<br />

<h3>未高亮</h3>
<div id=&quot;text&quot;>
  <div data-html=&quot;<div>hello world!</div>&quot;>hello world!</div>
  <div>
    <div data-html=&quot;<div>hello world!</div>&quot;>
      hello world!
      <div data-html=&quot;<div>hello world!</div>&quot;>hello world!</div>
    </div>
  </div>
  <div style=&quot;font-style: italic;&quot; data-attr=&quot;中华人民共和国&quot;>
    我是
    <span style=&quot;font-size: 20px; font-weight: bold; background-color: cyan;&quot;>中国人</span>
    ，我爱中华人民共和国，中华人民共和国万岁！
  </div>
</div>

<h3>高亮效果</h3>
<div id=&quot;content&quot;></div>

<script>
  const content = document.getElementById('content');
  const text = document.getElementById('text').innerHTML; // 富文本串
  const keyword = ['中华人民共和国', 'hello', '中华', '我'];

  let hightlightText = hightlightKeyword(text, keyword.join('|'));

  content.innerHTML = hightlightText;

  /**
   * 借助浏览器完成高亮。
   * 深度优先遍历所有的节点，对文本节点进行高亮
   *
   * @param input - 待高亮的富文本串
   * @param keyword - 由关键词生成的匹配串，格式 'xxxx|xxx|x'
   * @returns {string}
   */

  function hightlightKeyword(html, keyword) {
    // 复制一个节点去进行遍历操作
    let wrap = document.createElement('div');

    wrap.innerHTML = html;

    return DFSTraverseAndHightlight(wrap);

    function DFSTraverseAndHightlight (node) {
      const rootNodes = node.childNodes;
      const childNodes = Array.from(rootNodes);

      for(let i = 0, len = childNodes.length; i < len; i++) {
        const node = childNodes[i];

        // 文本节点，要进行高亮
        if (node.nodeType === 3) {
          let span = document.createElement('span');
          let a = span.innerHTML = node.nodeValue.replace(new RegExp(`(${keyword})`, 'g'), `<span class=&quot;keyword-match&quot;>$1</span>`);
          console.log(node.nodeValue);
          node.parentNode.insertBefore(span, node);
          node.parentNode.removeChild(node);
        }

        //文本节点不会有childNodes属性，如果有子节点，继续遍历
        if (node.childNodes.length) {
          DFSTraverseAndHightlight(node);
        }
      }

      return node.innerHTML;
    }
  }

</script>
</body>" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs javascript"><code>&lt;body&gt;
富文本高亮，关键词：[<span class="hljs-string">'中华人民共和国'</span>, <span class="hljs-string">'中华'</span>, <span class="hljs-string">'我'</span>];
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>未高亮<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"text"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-html</span>=<span class="hljs-string">"&lt;div&gt;hello world!&lt;/div&gt;"</span>&gt;</span>hello world!<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-html</span>=<span class="hljs-string">"&lt;div&gt;hello world!&lt;/div&gt;"</span>&gt;</span>
      hello world!
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-html</span>=<span class="hljs-string">"&lt;div&gt;hello world!&lt;/div&gt;"</span>&gt;</span>hello world!<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-style: italic;"</span> <span class="hljs-attr">data-attr</span>=<span class="hljs-string">"中华人民共和国"</span>&gt;</span>
    我是
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 20px; font-weight: bold; background-color: cyan;"</span>&gt;</span>中国人<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    ，我爱中华人民共和国，中华人民共和国万岁！
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>高亮效果<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"content"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> content = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'content'</span>);
  <span class="hljs-keyword">const</span> text = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'text'</span>).innerHTML; <span class="hljs-comment">// 富文本串</span>
  <span class="hljs-keyword">const</span> keyword = [<span class="hljs-string">'中华人民共和国'</span>, <span class="hljs-string">'hello'</span>, <span class="hljs-string">'中华'</span>, <span class="hljs-string">'我'</span>];

  <span class="hljs-keyword">let</span> hightlightText = hightlightKeyword(text, keyword.join(<span class="hljs-string">'|'</span>));

  content.innerHTML = hightlightText;

  <span class="hljs-comment">/**
   * 借助浏览器完成高亮。
   * 深度优先遍历所有的节点，对文本节点进行高亮
   *
   * @param input - 待高亮的富文本串
   * @param keyword - 由关键词生成的匹配串，格式 'xxxx|xxx|x'
   * @returns {string}
   */</span>

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hightlightKeyword</span>(<span class="hljs-params">html, keyword</span>) </span>{
    <span class="hljs-comment">// 复制一个节点去进行遍历操作</span>
    <span class="hljs-keyword">let</span> wrap = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);

    wrap.innerHTML = html;

    <span class="hljs-keyword">return</span> DFSTraverseAndHightlight(wrap);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">DFSTraverseAndHightlight</span> (<span class="hljs-params">node</span>) </span>{
      <span class="hljs-keyword">const</span> rootNodes = node.childNodes;
      <span class="hljs-keyword">const</span> childNodes = <span class="hljs-built_in">Array</span>.from(rootNodes);

      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>, len = childNodes.length; i &lt; len; i++) {
        <span class="hljs-keyword">const</span> node = childNodes[i];

        <span class="hljs-comment">// 文本节点，要进行高亮</span>
        <span class="hljs-keyword">if</span> (node.nodeType === <span class="hljs-number">3</span>) {
          <span class="hljs-keyword">let</span> span = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'span'</span>);
          <span class="hljs-keyword">let</span> a = span.innerHTML = node.nodeValue.replace(<span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">`(<span class="hljs-subst">${keyword}</span>)`</span>, <span class="hljs-string">'g'</span>), <span class="hljs-string">`&lt;span class="keyword-match"&gt;$1&lt;/span&gt;`</span>);
          <span class="hljs-built_in">console</span>.log(node.nodeValue);
          node.parentNode.insertBefore(span, node);
          node.parentNode.removeChild(node);
        }

        <span class="hljs-comment">//文本节点不会有childNodes属性，如果有子节点，继续遍历</span>
        <span class="hljs-keyword">if</span> (node.childNodes.length) {
          DFSTraverseAndHightlight(node);
        }
      }

      <span class="hljs-keyword">return</span> node.innerHTML;
    }
  }

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span></code></pre>
<h3 id="articleHeader4">简单的分词实现</h3>
<p>文章最开始说了，分词逻辑一般是后台通过专门的库来完成的。但其实，前端也可以自己实现一个简单的分词，只不过会产生许多无意义的词而已,思路大家一看就明白了</p>
<div class="widget-codetool" style="display:none;">
      <div class="widget-codetool--inner">
      <span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="全选"></span>
      <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="// 简单，粗暴分词
function splitWord(word) {
  var len = word.length,
    splitWordList = word.split(''); // 一字分组


  // 分词
  for(var i = 2; i <= len; i++) {
    for (var j = 0; j + i <= len; j++) {
        splitWordList.push(word.slice(j, j+i));
    }
  }

  // 必须把长度最长的放到最前面，否则会造成匹配不全的情况
  return splitWordList.reverse();
}" title="" data-original-title="复制"></span>
      <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="放进笔记"></span>
      </div>
      </div><pre class="hljs actionscript"><code><span class="hljs-comment">// 简单，粗暴分词</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">splitWord</span><span class="hljs-params">(word)</span> </span>{
  <span class="hljs-keyword">var</span> len = word.length,
    splitWordList = word.split(<span class="hljs-string">''</span>); <span class="hljs-comment">// 一字分组</span>


  <span class="hljs-comment">// 分词</span>
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">2</span>; i &lt;= len; i++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j + i &lt;= len; j++) {
        splitWordList.push(word.slice(j, j+i));
    }
  }

  <span class="hljs-comment">// 必须把长度最长的放到最前面，否则会造成匹配不全的情况</span>
  <span class="hljs-keyword">return</span> splitWordList.reverse();
}</code></pre>
<p>运行效果</p>
<p><span class="img-wrap"><img data-src="/img/remote/1460000009956583?w=659&amp;h=240" src="https://static.alili.tech/img/remote/1460000009956583?w=659&amp;h=240" alt="简单分词" title="简单分词" style="cursor: pointer;"></span></p>
<h3 id="articleHeader5">小结</h3>
<p>本文主要从前端的角度，介绍了如何实现高亮功能，包括普通文本高亮和富文本高亮。关键的知识点是：</p>
<ul>
<li><p>利用new RegExp(<code>(${keyword})</code>, 'g')方式动态创建正则</p></li>
<li><p>利用str.replace(regexp, <code>&lt;span class="keyword-match"&gt;$1&lt;/span&gt;</code>)为匹配加上高亮样式</p></li>
<li><p>最长的关键词一定要优先匹配，否则会造成匹配不全的情况</p></li>
<li><p>富文本匹配，用正则很难做到100%精确。但如果有浏览器环境，可以借助浏览器先将富文本串转换成DOM，通过DOM操作来实现一个更精确的富文本高亮</p></li>
<li><p>前端也可以自己实现分词，只不过会产生大量无意义词组而已</p></li>
</ul>
<p>原文地址：<a href="http://www.u3xyz.com/#/detail/22" rel="nofollow noreferrer" target="_blank">http://www.u3xyz.com/#/detail/22</a></p>

                
{{< /raw >}}

# 版权声明
本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，

本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。

原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！

## 原文标题
前端高亮功能实现复盘

## 原文链接
[https://segmentfault.com/a/1190000009956571](https://segmentfault.com/a/1190000009956571)

